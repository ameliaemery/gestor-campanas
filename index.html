<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor HAV 2026 - NUBE BLINDADA (V5)</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        /* ESTILOS ORIGINALES CONSERVADOS AL 100% */
        :root { --primary: #667eea; --secondary: #764ba2; --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --dark: #1f2937; --light: #f9fafb; --border: #e5e7eb; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; min-height: 100vh; }
        .container { max-width: 1800px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; padding: 20px; background: var(--light); }
        .stat-card { background: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .stat-card .number { font-size: 2.5em; font-weight: bold; color: var(--primary); }
        .tabs { display: flex; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); overflow-x: auto; }
        .tab-btn { flex: 1; padding: 18px; background: transparent; border: none; color: white; cursor: pointer; font-size: 1.05em; font-weight: 600; border-bottom: 3px solid transparent; }
        .tab-btn.active { background: white; color: var(--primary); border-bottom-color: var(--primary); }
        .tab-content { display: none; padding: 30px; }
        .tab-content.active { display: block; }
        .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .control-group { display: flex; flex-direction: column; }
        .control-group label { font-weight: 600; margin-bottom: 8px; color: var(--dark); }
        .control-group input, .control-group select, .control-group textarea { padding: 12px; border: 2px solid var(--border); border-radius: 8px; }
        .btn { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn:hover { transform: translateY(-2px); }
        .btn-edit { background: var(--warning); color: white; }
        .btn-del { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-primary { background: var(--primary); color: white; }
        .table-wrapper { overflow-x: auto; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        thead { background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; }
        th, td { padding: 12px 10px; border-bottom: 1px solid var(--border); text-align: left; }
        /* Estilos espec√≠ficos para legibilidad */
        td:nth-child(4) { font-family: 'Courier New', monospace; font-weight: bold; font-size: 1.1em; color: #2c3e50; } 
        td:nth-child(5) { font-weight: bold; color: #34495e; } 
        
        /* Cat√°logo HAV */
        .hav-catalog-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; margin-top: 25px; }
        .hav-platform-card { border-radius: 12px; padding: 18px; border-left: 5px solid; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .hav-channel-item { background: white; padding: 10px; border: 1px solid #eee; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; border-radius: 6px; }
        .hav-channel-name { font-weight: 600; font-size: 0.9em; }
        .hav-channel-id { color: #888; font-size: 0.8em; }
        
        /* Modal y Utilidades */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 500px; }
        .config-list { list-style: none; max-height: 300px; overflow-y: auto; background: #f9f9f9; padding: 10px; }
        .config-list li { padding: 8px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
        
        /* Notificaciones */
        #notification-area { position: fixed; bottom: 20px; right: 20px; z-index: 10000; }
        .notif-box { background: #333; color: white; padding: 15px; border-radius: 8px; margin-top: 10px; animation: slideIn 0.5s; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .badge { padding: 4px 8px; border-radius: 4px; color: white; font-size: 0.8em; }
        .badge-fb { background: #1877f2; } .badge-tt { background: #000; } .badge-gn { background: #EA4335; }
    </style>
</head>
<body>
    <div id="notification-area"></div>
    <div class="container">
        <div class="header">
            <h1>üöÄ Gestor HAV 2026 - NUBE BLINDADA</h1>
            <p class="subtitle">Datos Hist√≥ricos + Sincronizaci√≥n Segura</p>
        </div>

        <div class="stats">
            <div class="stat-card"><div class="number" id="totalCampaigns">0</div><div class="label">üìä Campa√±as</div></div>
            <div class="stat-card"><div class="number" id="totalKeywords">0</div><div class="label">üîë Keywords</div></div>
            <div class="stat-card"><div class="number" id="totalArticles">0</div><div class="label">üìù Art√≠culos</div></div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('tab-list')">üìã Lista de Campa√±as</button>
            <button class="tab-btn" onclick="switchTab('tab-add')">‚ûï Nueva / Editar</button>
            <button class="tab-btn" onclick="switchTab('tab-catalog')">üì° Cat√°logo HAV</button>
            <button class="tab-btn" onclick="switchTab('tab-config')">‚öôÔ∏è Configuraci√≥n</button>
        </div>

        <div id="tab-list" class="tab-content active">
            <div class="controls">
                <div class="control-group"><label>üîç Buscar</label><input type="text" id="search" placeholder="Nombre, ID, Pa√≠s..." onkeyup="renderTable()"></div>
                <div class="control-group"><label>Plataforma</label><select id="filterPlatform" onchange="renderTable()"></select></div>
                <div class="control-group"><label>Nicho</label><select id="filterProduct" onchange="renderTable()"></select></div>
                <div class="control-group"><label>Canal</label><select id="filterChannel" onchange="renderTable()"></select></div>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th onclick="applySort('platform')">Plat.</th>
                            <th onclick="applySort('channel')">Canal</th>
                            <th onclick="applySort('product')">Nicho</th>
                            <th onclick="applySort('id')">ID</th>
                            <th onclick="applySort('code')">Nombre Campa√±a</th>
                            <th onclick="applySort('country')">Pa√≠s</th>
                            <th onclick="applySort('keys')">Keys</th>
                            <th>Art.</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="campaignList"></tbody>
                </table>
            </div>
        </div>

        <div id="tab-add" class="tab-content">
            <h2 id="formTitle">‚ûï Nueva Campa√±a</h2>
            <div class="controls" style="grid-template-columns: repeat(4, 1fr);">
                <div class="control-group"><label>Plataforma</label><select id="inPlatform"></select></div>
                <div class="control-group"><label>Canal</label><select id="inChannel"></select></div>
                <div class="control-group"><label>Nicho</label><select id="inProduct"></select></div>
                <div class="control-group"><label>Idioma</label><input type="text" id="inLanguage"></div>
            </div>
            <div class="controls" style="grid-template-columns: repeat(3, 1fr);">
                <div class="control-group"><label>ID Campa√±a</label><select id="inId"></select></div>
                <div class="control-group"><label>Nombre (C√≥digo)</label><input type="text" id="inCode"></div>
                <div class="control-group"><label>Pa√≠s</label><input type="text" id="inCountry"></div>
            </div>
            <div class="control-group" style="margin-top: 15px;">
                <label>Keywords (una por l√≠nea)</label>
                <textarea id="inKeywords" rows="10"></textarea>
            </div>
            <div class="control-group" style="margin-top: 15px;">
                <label>Art√≠culo (Markdown)</label>
                <textarea id="inArticle" rows="15"></textarea>
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn btn-success" onclick="saveCampaign()">üíæ Guardar en Nube</button>
                <button class="btn btn-del" onclick="resetForm()">Cancelar</button>
            </div>
        </div>

        <div id="tab-catalog" class="tab-content">
            <h2>üì° Cat√°logo HAV (Sincronizado)</h2>
            <div style="margin-bottom: 15px;"><button class="btn btn-primary" onclick="addNewHAVChannel()">‚ûï Agregar Canal</button></div>
            <div id="havCatalogContainer" class="hav-catalog-grid"></div>
        </div>

        <div id="tab-config" class="tab-content">
            <h2>‚öôÔ∏è Configuraci√≥n Global</h2>
            <p>Los cambios aqu√≠ afectan a todos los usuarios.</p>
            <div class="controls">
                <div class="control-group"><input type="text" id="newIdVal" placeholder="Nuevo ID"><button class="btn btn-primary" onclick="addOption('ids', 'newIdVal')">Agregar</button></div>
                <div class="control-group"><input type="text" id="newProdName" placeholder="Nuevo Nicho"><button class="btn btn-primary" onclick="addOption('products', 'newProdName')">Agregar</button></div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div><h4>IDs Disponibles</h4><ul id="listIds" class="config-list"></ul></div>
                <div><h4>Nichos Disponibles</h4><ul id="listProds" class="config-list"></ul></div>
            </div>
        </div>
    </div>

    <div id="editChannelModal" class="modal">
        <div class="modal-content">
            <h3>Editar Canal HAV</h3>
            <div class="control-group"><label>Plataforma</label><select id="modalPlatform"><option value="FB">FB</option><option value="TT">TT</option><option value="GN">GN</option></select></div>
            <div class="control-group"><label>Nombre</label><input type="text" id="modalChannelName"></div>
            <div class="control-group"><label>ID</label><input type="text" id="modalChannelId"></div>
            <div class="control-group"><label>Grupo</label><input type="text" id="modalChannelGroup"></div>
            <div style="margin-top: 15px; text-align: right;">
                <button class="btn btn-del" onclick="closeChannelModal()">Cancelar</button>
                <button class="btn btn-success" onclick="saveChannelEdit()">Guardar</button>
            </div>
        </div>
    </div>

<script>
/* 1. FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyB6lGHmig5XC4RPwAFnWaBFkpXIqdO_WoM",
  authDomain: "gestor-campanas-hav2026.firebaseapp.com",
  projectId: "gestor-campanas-hav2026",
  storageBucket: "gestor-campanas-hav2026.firebasestorage.app",
  messagingSenderId: "1715326503",
  appId: "1:1715326503:web:2b7ecda6f5257c9da78802"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const dbFirebase = firebase.firestore();
const campaignsRef = dbFirebase.collection('campaigns');
const settingsRef = dbFirebase.collection('settings').doc('globalConfig'); 

/* 2. DATOS HIST√ìRICOS COMPLETOS (NUNCA BORRAR) */
const ALL_NICHOS_ORIGINAL = [
    'AireAcondicionado', 'Apartamentos', 'Autos', 'AutosElectricos', 'Bicicletas',
    'CadenasDeOro', 'Celulares', 'Colchones', 'Cortacesped', 'CursoDeIngles',
    'CursoDeMarketingDigital', 'CursosInteligenciaArtificial', 'Escritorio',
    'Generadores', 'Iphone', 'Muebles', 'MueblesDeCocina', 'PcGamer', 'PcGamerBM2',
    'Refrigeradores', 'Sofa', 'SofaCama', 'Televisores', 'UniversidadesOnline'
];

const HISTORICAL_CATALOG = {
    'MUNDO Meta': [
        { code: 'FB-HAV-AutosElectricos', id: '9908318566', platform: 'FB' },
        { code: 'FB-HAV-Bicicletas', id: '8762376986', platform: 'FB' },
        { code: 'FB-HAV-Colchones', id: '4310876523', platform: 'FB' },
        { code: 'FB-HAV-Cortacesped', id: '3203309414', platform: 'FB' },
        { code: 'FB-HAV-Escritorio', id: '3408906124', platform: 'FB' },
        { code: 'FB-HAV-Generadores', id: '5094975587', platform: 'FB' },
        { code: 'FB-HAV-MueblesDeCocina', id: '9443790845', platform: 'FB' },
        { code: 'FB-HAV-PcGamer', id: '8492214982', platform: 'FB' },
        { code: 'FB-HAV-PcGamerBM2', id: '6741304565', platform: 'FB' },
        { code: 'FB-HAV-SofaCama', id: '5476324359', platform: 'FB' },
        { code: 'FB-HAV-Autos', id: '00901', platform: 'FB' },
        { code: 'FB-HAV-Celulares', id: '00902', platform: 'FB' },
        { code: 'FB-HAV-Iphone', id: '00903', platform: 'FB' },
        { code: 'FB-HAV-Sofa', id: '00904', platform: 'FB' },
        { code: 'FB-HAV-Muebles', id: '00905', platform: 'FB' },
        { code: 'FB-HAV-Refrigeradores', id: '00906', platform: 'FB' },
        { code: 'FB-HAV-Apartamentos', id: '00907', platform: 'FB' },
        { code: 'FB-HAV-CadenasDeOro', id: '00908', platform: 'FB' },
        { code: 'FB-HAV-Televisores', id: '00909', platform: 'FB' },
        { code: 'FB-HAV-AireAcondicionado', id: '00910', platform: 'FB' },
        { code: 'FB-HAV-CursoDeIngles', id: '02301', platform: 'FB' },
        { code: 'FB-HAV-CursoDeMarketingDigital', id: '02302', platform: 'FB' },
        { code: 'FB-HAV-UniversidadesOnline', id: '02303', platform: 'FB' },
        { code: 'FB-HAV-CursosInteligenciaArtificial', id: '02304', platform: 'FB' }
    ],
    'Mundo TikTok': [
        { code: 'TT-HAV-Bicicletas', id: '00534', platform: 'TT' },
        { code: 'TT-HAV-Cortacesped', id: '00535', platform: 'TT' },
        { code: 'TT-HAV-Generadores', id: '00536', platform: 'TT' },
        { code: 'TT-HAV-MueblesDeCocina', id: '00537', platform: 'TT' },
        { code: 'TT-HAV-PcGamer', id: '00539', platform: 'TT' },
        { code: 'TT-HAV-PcGamerBM2', id: '00540', platform: 'TT' },
        { code: 'TT-HAV-SofaCama', id: '00541', platform: 'TT' },
        { code: 'TT-HAV-Autos', id: '00911', platform: 'TT' },
        { code: 'TT-HAV-Celulares', id: '00912', platform: 'TT' },
        { code: 'TT-HAV-Iphone', id: '00913', platform: 'TT' },
        { code: 'TT-HAV-Sofa', id: '00914', platform: 'TT' },
        { code: 'TT-HAV-Muebles', id: '00915', platform: 'TT' },
        { code: 'TT-HAV-Refrigeradores', id: '00916', platform: 'TT' },
        { code: 'TT-HAV-Apartamentos', id: '00732', platform: 'TT' },
        { code: 'TT-HAV-CadenasDeOro', id: '00733', platform: 'TT' },
        { code: 'TT-HAV-Televisores', id: '00734', platform: 'TT' },
        { code: 'TT-HAV-AireAcondicionado', id: '00735', platform: 'TT' },
        { code: 'TT-HAV-CursoDeIngles', id: '02305', platform: 'TT' },
        { code: 'TT-HAV-CursoDeMarketingDigital', id: '02306', platform: 'TT' },
        { code: 'TT-HAV-UniversidadesOnline', id: '02307', platform: 'TT' },
        { code: 'TT-HAV-CursosInteligenciaArtificial', id: '02308', platform: 'TT' }
    ],
    'InsideHub TikTok': [
        { code: 'TT-HAV-IHBicicletas', id: '00561', platform: 'TT' },
        { code: 'TT-HAV-IHColchones', id: '00562', platform: 'TT' },
        { code: 'TT-HAV-IHMueblesDeCocina', id: '00563', platform: 'TT' },
        { code: 'TT-HAV-IHSofaCama', id: '00564', platform: 'TT' },
        { code: 'TT-HAV-IHCortacesped', id: '00565', platform: 'TT' },
        { code: 'TT-HAV-IHPcGamer', id: '00566', platform: 'TT' },
        { code: 'TT-HAV-IHAutosElectricos', id: '02310', platform: 'TT' },
        { code: 'TT-HAV-IHEscritorio', id: '02311', platform: 'TT' },
        { code: 'TT-HAV-IHAutos', id: '02312', platform: 'TT' },
        { code: 'TT-HAV-IHCelulares', id: '02313', platform: 'TT' },
        { code: 'TT-HAV-IHIphone', id: '02314', platform: 'TT' },
        { code: 'TT-HAV-IHSof√°', id: '02315', platform: 'TT' },
        { code: 'TT-HAV-IHMuebles', id: '02316', platform: 'TT' },
        { code: 'TT-HAV-IHRefrigeradores', id: '02317', platform: 'TT' },
        { code: 'TT-HAV-IHApartamentos', id: '02318', platform: 'TT' },
        { code: 'TT-HAV-IHCadenasDeOro', id: '02319', platform: 'TT' },
        { code: 'TT-HAV-IHTelevisores', id: '02320', platform: 'TT' },
        { code: 'TT-HAV-IHAireAcondicionado', id: '02321', platform: 'TT' }
    ],
    'Honduras TikTok': [
        { code: 'TT-HAV-HNCortacesped', id: '6405419069', platform: 'TT' },
        { code: 'TT-HAV-HNMueblesDeCocina', id: '9985571428', platform: 'TT' },
        { code: 'TT-HAV-HNPcGamer', id: '4661076646', platform: 'TT' },
        { code: 'TT-HAV-HNSofaCama', id: '3347994979', platform: 'TT' },
        { code: 'TT-HAV-HNBicicletas', id: '1517545151', platform: 'TT' },
        { code: 'TT-HAV-HNColchones', id: '2002321389', platform: 'TT' }
    ],
    'Honduras Meta': [
        { code: 'FB-HAV-HNAutosElectricos', id: '9609693171', platform: 'FB' },
        { code: 'FB-HAV-HNCortacesped', id: '7622109490', platform: 'FB' },
        { code: 'FB-HAV-HNGeneradores', id: '6456028178', platform: 'FB' },
        { code: 'FB-HAV-HNMueblesDeCocina', id: '9712746903', platform: 'FB' },
        { code: 'FB-HAV-HNPcGamer', id: '8890619827', platform: 'FB' },
        { code: 'FB-HAV-HNSofaCama', id: '9577903584', platform: 'FB' },
        { code: 'FB-HAV-HNBicicletas', id: '1419867450', platform: 'FB' },
        { code: 'FB-HAV-HNColchones', id: '2830626828', platform: 'FB' }
    ],
    'Google Ads': [
        { code: 'GN-HAV-Bicicletas', id: '00716', platform: 'GN' },
        { code: 'GN-HAV-Colchones', id: '00726', platform: 'GN' },
        { code: 'GN-HAV-MueblesDeCocina', id: '00727', platform: 'GN' },
        { code: 'GN-HAV-SofaCama', id: '00728', platform: 'GN' },
        { code: 'GN-HAV-Cortacesped', id: '00729', platform: 'GN' },
        { code: 'GN-HAV-PcGamer', id: '00730', platform: 'GN' }
    ]
};

/* CAMPA√ëAS INICIALES (MUESTRA DE LAS CIENTOS QUE TIENES) */
// Aqu√≠ debes pegar tu JSON completo si es muy largo, he puesto los ejemplos clave
const HISTORICAL_CAMPAIGNS = [
    { "platform": "FB", "channel": "HAV", "product": "Celulares", "country": "PL", "code": "FB-HAV-Celulares-PL", "id": "00902", "keywords": ["Telefon na raty", "Telefony na Raty Przez Internet", "Telefon w miesiƒôcznych ratach"], "article": "" },
    { "platform": "FB", "channel": "HAV", "product": "Iphone", "country": "DE", "code": "FB-HAV-Iphone-DE", "id": "00903", "keywords": ["Iphone Bestellen auf Raten", "Iphone Ratenkauf", "Iphone Trotz Negativer Schufa"], "article": "" },
    { "platform": "FB", "channel": "HAV", "product": "Sofa", "country": "ES", "code": "FB-HAV-Sofa-ES", "id": "00904", "keywords": ["Sof√° a cuotas Mensuales", "Financiaci√≥n de Sof√° Sin Entrada"], "article": "" }
    // ... EL SISTEMA SEGUIR√Å FUNCIONANDO IGUAL SI AGREGAS M√ÅS AQU√ç
];

const nichoEmojis = {
    'cadena': '‚õìÔ∏è', 'oro': 'üí∞', 'joya': 'üíé', 'iphone': 'üì±', 'celular': 'üì±', 
    'tv': 'üì∫', 'sof√°': 'üõãÔ∏è', 'sofa': 'üõãÔ∏è', 'mueble': 'ü™ë', 'bici': 'üö≤', 
    'pc': 'üíª', 'colch√≥n': 'üõèÔ∏è', 'auto': 'üöó', 'curso': 'üìö', 'jard√≠n': 'üåø'
};

let db = {
    campaigns: [],
    platforms: ['FB', 'TT', 'GN'],
    channels: ['Mundo', 'IH', 'CS', 'HN'],
    products: ALL_NICHOS_ORIGINAL, // ¬°IMPORTANTE! NUNCA VAC√çO
    ids: ['00902', '00903', '00904', '00905', '00908', '00909'],
    havCatalog: HISTORICAL_CATALOG // ¬°IMPORTANTE! NUNCA VAC√çO
};

let editingIndex = -1;
let currentSort = { column: 'country', order: 'asc' };
let currentEditingChannel = null;

function startRealtimeSync() {
    showNotif('üì° Conectando a Nube...', 'info');

    // 1. Sincronizar CAMPA√ëAS
    campaignsRef.onSnapshot(snapshot => {
        const loaded = [];
        snapshot.forEach(doc => loaded.push({ firebaseId: doc.id, ...doc.data() }));
        db.campaigns = loaded;
        
        // Si la nube est√° vac√≠a de campa√±as, ofrecer subida
        if (loaded.length === 0 && HISTORICAL_CAMPAIGNS.length > 0) {
            console.log("‚ö†Ô∏è Nube sin campa√±as: Subiendo iniciales...");
            // Opcional: Descomentar si quieres subir las campa√±as de ejemplo autom√°ticamente
            // HISTORICAL_CAMPAIGNS.forEach(c => campaignsRef.add(c));
        }
        
        renderTable();
        updateStats();
    });

    // 2. Sincronizar CONFIGURACI√ìN (EL PUNTO CR√çTICO DE LOS NICHOS)
    settingsRef.onSnapshot(doc => {
        if (doc.exists) {
            const data = doc.data();
            
            // L√ìGICA DE BLINDAJE:
            // Si la nube tiene nichos vac√≠os o no existen, USAMOS EL RESPALDO LOCAL
            if (!data.products || data.products.length === 0) {
                console.log("‚ö†Ô∏è ALERTA: Nube con nichos vac√≠os. Restaurando respaldo...");
                db.products = ALL_NICHOS_ORIGINAL;
                db.havCatalog = HISTORICAL_CATALOG;
                // Forzamos la subida a la nube para arreglarla
                saveGlobalSettings();
            } else {
                // Si la nube est√° bien, usamos la nube
                db.products = data.products;
                db.ids = data.ids || db.ids;
                db.havCatalog = data.havCatalog || db.havCatalog;
            }
            refreshEverything();
        } else {
            // Si el documento ni existe, lo creamos con el respaldo
            console.log("‚ö†Ô∏è Configuraci√≥n nueva: Inicializando con respaldo...");
            saveGlobalSettings(); 
        }
    });
}

async function saveToFirebase(campaign) {
    try {
        if (campaign.firebaseId) {
            const { firebaseId, ...data } = campaign;
            await campaignsRef.doc(firebaseId).update(data);
            showNotif('‚òÅÔ∏è Campa√±a actualizada', 'success');
        } else {
            await campaignsRef.add(campaign);
            showNotif('‚òÅÔ∏è Campa√±a creada en nube', 'success');
        }
    } catch (e) { alert('Error nube: ' + e.message); }
}

async function deleteFromFirebase(firebaseId) {
    try { await campaignsRef.doc(firebaseId).delete(); showNotif('üóëÔ∏è Eliminado', 'success'); } catch (e) { console.error(e); }
}

// Esta funci√≥n guarda TU RESPALDO en la nube
async function saveGlobalSettings() {
    try {
        await settingsRef.set({
            products: db.products,
            ids: db.ids,
            platforms: db.platforms,
            channels: db.channels,
            havCatalog: db.havCatalog,
            lastUpdate: new Date().toISOString()
        }, { merge: true });
        console.log("‚úÖ Configuraci√≥n guardada/restaurada en nube.");
    } catch (e) { console.error(e); }
}

function saveToStorage() { saveGlobalSettings(); }

/* UI LOGIC */
function getNichoConEmoji(nicho) {
    if (!nicho) return '';
    const n = nicho.toLowerCase();
    for (let key in nichoEmojis) { if (n.includes(key)) return nichoEmojis[key] + ' ' + nicho; }
    return nicho;
}

function switchTab(id) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelector(`[onclick="switchTab('${id}')"]`).classList.add('active');
    if (id === 'tab-catalog') renderHAVCatalog();
}

function renderTable() {
    const q = document.getElementById('search').value.toLowerCase();
    const pF = document.getElementById('filterPlatform').value;
    const prF = document.getElementById('filterProduct').value;
    const chF = document.getElementById('filterChannel').value;

    let filtered = db.campaigns.filter(c => 
        (c.code.toLowerCase().includes(q) || c.id.includes(q) || (c.country||'').toLowerCase().includes(q)) && 
        (!pF || c.platform === pF) && 
        (!prF || c.product === prF) && 
        (!chF || chF === 'Todos' || c.channel === chF)
    );

    filtered.sort((a, b) => {
        let vA = a[currentSort.column], vB = b[currentSort.column];
        if(currentSort.column === 'keys') { vA = a.keywords?.length||0; vB = b.keywords?.length||0; }
        return currentSort.order === 'asc' ? (vA > vB ? 1 : -1) : (vA < vB ? 1 : -1);
    });

    document.getElementById('campaignList').innerHTML = filtered.map(c => {
        const realIndex = db.campaigns.indexOf(c);
        const hasArticle = c.article && c.article.trim();
        return `<tr>
            <td><span class="badge badge-${c.platform.toLowerCase()}">${c.platform}</span></td>
            <td>${c.channel || '-'}</td>
            <td>${getNichoConEmoji(c.product)}</td>
            <td>${c.id}</td>
            <td>${c.code}</td>
            <td>${c.country}</td>
            <td>${c.keywords ? c.keywords.length : 0}</td>
            <td style="text-align:center">${hasArticle ? '‚úÖ' : '‚ùå'}</td>
            <td><button class="btn btn-edit" style="padding:5px" onclick="editCampaign(${realIndex})">‚úèÔ∏è</button></td>
        </tr>`;
    }).join('');
}

function updateOptions() {
    // FUNCI√ìN DE LLENADO DE SELECTS
    const fill = (id, arr, isFilter) => {
        const el = document.getElementById(id);
        if(el) {
            // Aseguramos que arr tenga datos, si no, usamos el respaldo local
            const dataToUse = (arr && arr.length > 0) ? arr : ALL_NICHOS_ORIGINAL;
            el.innerHTML = (isFilter ? '<option value="">Todos</option>' : '') + dataToUse.map(x => `<option value="${x}">${x}</option>`).join('');
        }
    };
    
    fill('inPlatform', db.platforms); fill('filterPlatform', db.platforms, true);
    fill('inChannel', db.channels); fill('filterChannel', db.channels, true);
    
    // Aqu√≠ es donde ocurr√≠a el error: db.products estaba vac√≠o desde la nube.
    // Ahora db.products est√° blindado en startRealtimeSync, pero por seguridad, pasamos un fallback.
    fill('inProduct', db.products.length ? db.products : ALL_NICHOS_ORIGINAL); 
    fill('filterProduct', db.products.length ? db.products : ALL_NICHOS_ORIGINAL, true);
    
    fill('inId', db.ids); fill('filterId', db.ids, true);

    ['ids', 'products'].forEach(k => {
        const ul = document.getElementById(k === 'ids' ? 'listIds' : 'listProds');
        const dataToRender = (db[k] && db[k].length) ? db[k] : (k==='products' ? ALL_NICHOS_ORIGINAL : []);
        if(ul) ul.innerHTML = dataToRender.map(v => `<li>${v} <button class="btn-del" style="padding:2px 6px" onclick="delOption('${k}', '${v}')">üóëÔ∏è</button></li>`).join('');
    });
}

function updateStats() {
    document.getElementById('totalCampaigns').textContent = db.campaigns.length;
    document.getElementById('totalKeywords').textContent = db.campaigns.reduce((sum, c) => sum + (c.keywords?.length||0), 0);
    document.getElementById('totalArticles').textContent = db.campaigns.filter(c => c.article && c.article.trim()).length;
}

function refreshEverything() { updateOptions(); renderTable(); updateStats(); }

function addOption(type, inputId) {
    const val = document.getElementById(inputId).value.trim();
    if(val && !db[type].includes(val)) {
        db[type].push(val);
        db[type].sort();
        saveGlobalSettings();
        document.getElementById(inputId).value = '';
    }
}
function delOption(type, val) {
    if(confirm('¬øBorrar?')) {
        db[type] = db[type].filter(x => x !== val);
        saveGlobalSettings();
    }
}

function editCampaign(i) {
    editingIndex = i;
    const c = db.campaigns[i];
    document.getElementById('inPlatform').value = c.platform;
    document.getElementById('inChannel').value = c.channel;
    document.getElementById('inProduct').value = c.product;
    document.getElementById('inId').value = c.id;
    document.getElementById('inCode').value = c.code;
    document.getElementById('inCountry').value = c.country;
    document.getElementById('inLanguage').value = c.language || '';
    document.getElementById('inKeywords').value = c.keywords ? c.keywords.join('\n') : '';
    document.getElementById('inArticle').value = c.article || '';
    document.getElementById('formTitle').textContent = '‚úèÔ∏è Editando: ' + c.code;
    switchTab('tab-add');
}

function saveCampaign() {
    const c = {
        platform: document.getElementById('inPlatform').value,
        channel: document.getElementById('inChannel').value,
        product: document.getElementById('inProduct').value,
        id: document.getElementById('inId').value,
        code: document.getElementById('inCode').value,
        country: document.getElementById('inCountry').value.toUpperCase(),
        language: document.getElementById('inLanguage').value,
        keywords: document.getElementById('inKeywords').value.split('\n').filter(x=>x.trim()),
        article: document.getElementById('inArticle').value,
        updatedAt: new Date().toISOString()
    };
    if(!c.code || !c.product) return alert('Faltan datos');
    if(editingIndex >= 0) c.firebaseId = db.campaigns[editingIndex].firebaseId;
    saveToFirebase(c);
    resetForm();
    switchTab('tab-list');
}

function resetForm() {
    editingIndex = -1;
    document.querySelectorAll('#tab-add input, #tab-add textarea').forEach(e=>e.value='');
    document.getElementById('formTitle').textContent = '‚ûï Nueva Campa√±a';
}

function renderHAVCatalog() {
    const box = document.getElementById('havCatalogContainer');
    if(!box) return;
    // Fallback si la DB est√° vac√≠a
    const catalog = (db.havCatalog && Object.keys(db.havCatalog).length > 0) ? db.havCatalog : HISTORICAL_CATALOG;
    
    let html = '';
    const colors = { 'FB': '#1877f2', 'TT': '#000', 'GN': '#EA4335' };
    for(const [group, channels] of Object.entries(catalog)) {
        if(!channels.length) continue;
        const color = colors[channels[0].platform] || '#333';
        html += `<div class="hav-platform-card" style="border-left-color:${color}"><h3 style="color:${color}">${group}</h3>
            ${channels.map((ch, idx) => `
                <div class="hav-channel-item">
                    <div><div class="hav-channel-name">${ch.code}</div><div class="hav-channel-id">${ch.id}</div></div>
                    <div><button class="btn btn-primary" style="padding:4px 8px;font-size:0.8em" onclick="navigator.clipboard.writeText('${ch.code}|${ch.id}');showNotif('Copiado','success')">üìã</button>
                    <button class="btn btn-edit" style="padding:4px 8px;font-size:0.8em;margin-left:5px" onclick="editHAVChannel('${group}', ${idx})">‚úèÔ∏è</button></div>
                </div>`).join('')}</div>`;
    }
    box.innerHTML = html;
}

function addNewHAVChannel() {
    currentEditingChannel = null; document.getElementById('modalPlatform').value = 'FB';
    document.getElementById('modalChannelName').value = ''; document.getElementById('modalChannelId').value = '';
    document.getElementById('editChannelModal').classList.add('active');
}
function saveChannelEdit() {
    const plat = document.getElementById('modalPlatform').value, name = document.getElementById('modalChannelName').value, id = document.getElementById('modalChannelId').value, group = document.getElementById('modalChannelGroup').value;
    if(!name || !id) return alert('Completa datos');
    const code = `${plat}-HAV-${name}`;
    if(currentEditingChannel) {
        const oldG = currentEditingChannel.group;
        db.havCatalog[oldG].splice(currentEditingChannel.index, 1);
        if(!db.havCatalog[oldG].length) delete db.havCatalog[oldG];
    }
    if(!db.havCatalog[group]) db.havCatalog[group] = [];
    db.havCatalog[group].push({ code, id, platform: plat });
    saveGlobalSettings(); closeChannelModal();
}
function editHAVChannel(grp, idx) {
    currentEditingChannel = { group: grp, index: idx };
    const ch = db.havCatalog[grp][idx];
    document.getElementById('modalPlatform').value = ch.platform;
    document.getElementById('modalChannelName').value = ch.code.split('-HAV-')[1] || '';
    document.getElementById('modalChannelId').value = ch.id;
    document.getElementById('modalChannelGroup').value = grp;
    document.getElementById('editChannelModal').classList.add('active');
}
function closeChannelModal() { document.getElementById('editChannelModal').classList.remove('active'); }
function showNotif(msg, type) {
    const div = document.createElement('div');
    div.className = 'notif-box';
    div.style.background = type === 'success' ? '#10b981' : '#333';
    div.textContent = msg;
    document.getElementById('notification-area').appendChild(div);
    setTimeout(()=>div.remove(), 3000);
}
function applySort(col) { currentSort.column = col; currentSort.order = currentSort.order==='asc'?'desc':'asc'; renderTable(); }

window.onload = function() { startRealtimeSync(); };
</script>
</body>
</html>
