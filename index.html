<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor HAV 2026</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        /* ==========================================================================
           ESTILOS ORIGINALES (RESPETADOS)
           ========================================================================== */
        :root { --primary: #667eea; --secondary: #764ba2; --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --dark: #1f2937; --light: #f9fafb; --border: #e5e7eb; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; min-height: 100vh; }
        .container { max-width: 1800px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; padding: 30px; text-align: center; position: relative; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .header .subtitle { font-size: 1.1em; opacity: 0.9; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; padding: 20px; background: var(--light); }
        .stat-card { background: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.3s; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-card .number { font-size: 2.5em; font-weight: bold; color: var(--primary); }
        .stat-card .label { color: var(--dark); margin-top: 5px; font-size: 0.9em; }
        .tabs { display: flex; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); overflow-x: auto; }
        .tab-btn { flex: 1; padding: 18px; background: transparent; border: none; color: white; cursor: pointer; font-size: 1.05em; font-weight: 600; border-bottom: 3px solid transparent; white-space: nowrap; }
        .tab-btn:hover { background: rgba(255,255,255,0.1); }
        .tab-btn.active { background: white; color: var(--primary); border-bottom-color: var(--primary); }
        .tab-content { display: none; padding: 30px; }
        .tab-content.active { display: block; }
        .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .control-group { display: flex; flex-direction: column; }
        .control-group label { font-weight: 600; margin-bottom: 8px; color: var(--dark); font-size: 0.95em; }
        .control-group input, .control-group select, .control-group textarea { padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 1em; transition: all 0.3s; }
        .control-group input:focus, .control-group select:focus, .control-group textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .control-group textarea { resize: vertical; font-family: 'Courier New', monospace; }
        .btn { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 600; transition: all 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .btn-edit { background: var(--warning); color: white; }
        .btn-del { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-meta { background: #8b5cf6; color: white; }
        .btn-bold { background: var(--dark); color: white; margin-left: 10px; }
        .btn-clear-tags { background: var(--danger); color: white; margin-left: 10px; }
        .table-wrapper { overflow-x: auto; margin-top: 20px; }
        
        table { width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; }
        thead { background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; }
        th { padding: 15px 10px; text-align: left; cursor: pointer; user-select: none; font-weight: 600; position: relative; white-space: nowrap; }
        th:hover { background: rgba(255,255,255,0.1); }
        td { padding: 12px 10px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        tbody tr:hover { background: var(--light); }
        
        /* ESTILOS DE TEXTO TABLA */
        td:nth-child(4) { /* Nicho */ font-weight: bold; font-size: 1.05em; color: #2c3e50; }
        td:nth-child(5) { /* ID */ font-family: 'Courier New', monospace; font-weight: bold; font-size: 1.1em; color: #34495e; }
        td:nth-child(9) { /* Keys */ font-weight: bold; color: #333; }
        
        /* SELECTOR PLATAFORMA */
        .platform-select { 
            padding: 6px; border: 1px solid #e0e0e0; border-radius: 6px; 
            background: white; cursor: pointer; font-size: 0.85em; font-weight: 600; 
            width: 110px; 
        }

        /* CAT√ÅLOGO HAV */
        .hav-catalog-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); gap: 30px; margin-top: 30px; align-items: start; }
        .hav-platform-card { border-radius: 12px; padding: 20px; border-left: 6px solid; box-shadow: 0 4px 15px rgba(0,0,0,0.08); background: white; height: 100%; display: flex; flex-direction: column; }
        .hav-platform-card h3 { margin-bottom: 15px; font-size: 1.25em; font-weight: 700; padding-bottom: 10px; border-bottom: 2px solid #f0f0f0; }
        .hav-channels-list { display: flex; flex-direction: column; gap: 12px; max-height: 500px; overflow-y: auto; padding-right: 8px; }
        .hav-channel-item { background: #f8faff; padding: 12px 15px; border-radius: 8px; border: 1px solid #e1e4e8; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.03); transition: transform 0.2s; }
        .hav-channel-item:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.08); }
        .hav-channel-name { font-weight: 600; font-size: 0.85em; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .hav-channel-id { font-size: 0.75em; color: #888; }
        
        /* BOTONES CAT√ÅLOGO */
        .hav-btn-group { display: flex; gap: 3px; }
        .btn-mini { padding: 4px 6px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.75em; transition: 0.2s; }
        .btn-copy-mini { background: var(--primary); color: white; }
        .btn-edit-mini { background: var(--warning); color: white; }
        .btn-del-mini { background: var(--danger); color: white; }

        .badge { padding: 5px 12px; border-radius: 20px; font-size: 0.85em; font-weight: 600; display: inline-block; }
        .badge-fb { background: #1877f2; color: white; }
        .badge-tt { background: #fe2c55; color: white; }
        .badge-gn { background: #EA4335; color: white; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3); animation: modalSlide 0.3s ease; }
        @keyframes modalSlide { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; }
        .config-list { list-style: none; max-height: 400px; overflow-y: auto; background: var(--light); padding: 15px; border-radius: 8px; }
        .config-list li { padding: 10px; background: white; margin: 8px 0; border-radius: 6px; display: flex; align-items: center; gap: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .config-input { flex: 1; padding: 8px 12px; border: 2px solid var(--border); border-radius: 6px; font-size: 0.95em; }
        .btn-save-mini { background: var(--success); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; }
        .btn-del-mini { background: var(--danger); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; }
        
        /* === ICONOS LINK === */
        /* Usamos text-shadow y color transparente para FORZAR el color en emojis, funciona en links */
        .url-active { 
            color: transparent !important; 
            text-shadow: 0 0 0 #00E676 !important; /* VERDE BRILLANTE */
            font-weight: bold; 
            font-size: 1.3em; 
            cursor: pointer; 
            text-decoration: none; 
        }
        .url-inactive { 
            color: transparent !important;
            text-shadow: 0 0 0 #d1d5db !important; /* GRIS */
            font-size: 1.3em; 
            cursor: default; 
        }
        
        .article-indicator { font-size: 1.3em; cursor: pointer; transition: transform 0.3s; }
        .article-indicator:hover { transform: scale(1.3); }
        .has-article { color: var(--success); }
        .no-article { color: var(--border); }
        
        /* Notificaciones */
        #notification-area { position: fixed; bottom: 20px; right: 20px; z-index: 10000; }
        .notif-box { background: #333; color: white; padding: 15px; border-radius: 8px; margin-top: 10px; animation: slideIn 0.5s; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .btn-copy { background: var(--primary); color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.8em; font-weight: 600; }
    
        /* Estilo para IDs m√°s grandes y visibles */
        td code {
            font-size: 1.1rem;
            font-weight: 700;
            background: #f0f9ff;
            padding: 4px 10px;
            border-radius: 6px;
            border: 2px solid #3b82f6;
            color: #1e40af;
            display: inline-block;
        }
    
        /* ========== SISTEMA DE LOGIN SEGURO ========== */
        #loginScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 99999;
        }

        #loginScreen.hidden {
            display: none;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 400px;
            text-align: center;
            animation: loginSlide 0.5s ease;
        }

        @keyframes loginSlide {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-box h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .login-box p {
            color: #666;
            margin-bottom: 30px;
            font-size: 0.95em;
        }

        .login-input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .login-input-group label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        .login-input-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
            box-sizing: border-box;
        }

        .login-input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .login-error {
            background: #fee2e2;
            color: #dc2626;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
            font-size: 0.9em;
            font-weight: 500;
        }

        .login-error.show {
            display: block;
            animation: shake 0.4s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .logout-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ef4444;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }

        #mainApp {
            display: none;
        }

        #mainApp.show {
            display: block;
        }

        /* Modal de An√°lisis */
        .analysis-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }
        .analysis-modal.active { display: flex; }
        .analysis-content {
            background: white;
            padding: 35px;
            border-radius: 16px;
            max-width: 700px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
        }
        .analysis-header {
            font-size: 1.5em;
            color: var(--primary);
            margin-bottom: 20px;
            border-bottom: 3px solid var(--primary);
            padding-bottom: 10px;
        }
        .analysis-metric {
            margin: 15px 0;
            padding: 12px;
            background: var(--light);
            border-radius: 8px;
        }
        .campaign-item {
            padding: 8px 12px;
            margin: 5px 0;
            background: white;
            border-left: 4px solid var(--primary);
            border-radius: 4px;
            font-size: 0.9em;
        }
        .campaign-item.below { border-left-color: var(--danger); }
        .campaign-item.above { border-left-color: var(--success); }
        .stat-card.clickable {
            cursor: pointer;
            transition: all 0.3s;
        }
        .stat-card.clickable:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
</style>
</head>
<body>
<!-- ========== PANTALLA DE LOGIN SEGURA ========== -->
<div id="loginScreen">
    <div class="login-box">
        <h1>üîí Gestor HAV 2026</h1>
        <p>Sistema Protegido - Acceso Autorizado</p>

        <div id="loginError" class="login-error">
            ‚ùå Usuario o contrase√±a incorrectos
        </div>

        <form id="loginForm" onsubmit="return handleLogin(event)">
            <div class="login-input-group">
                <label>üë§ Usuario</label>
                <input type="text" id="loginUser" autocomplete="username" required autofocus>
            </div>

            <div class="login-input-group">
                <label>üîë Contrase√±a</label>
                <input type="password" id="loginPass" autocomplete="current-password" required>
            </div>

            <button type="submit" class="login-btn">üöÄ Entrar al Gestor</button>
        </form>
    </div>
</div>

<!-- ========== BOT√ìN CERRAR SESI√ìN ========== -->
<button class="logout-btn" onclick="logout()" style="display: none;" id="logoutBtn">üö™ Cerrar Sesi√≥n</button>

<!-- ========== APLICACI√ìN PRINCIPAL (PROTEGIDA) ========== -->
<div id="mainApp">

    <div id="notification-area"></div>
    <div class="container">
        <div class="header">
            <h1>üöÄ Gestor de Campa√±as HAV 2026</h1>
            <p class="subtitle">‚òÅÔ∏è Sistema Sincronizado en la Nube</p>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="number" id="totalCampaigns">0</div>
                <div class="label">üìä Total Campa√±as</div>
            </div>
            <div class="stat-card">
                <div class="number" id="totalKeywords">0</div>
                <div class="label">üîë Keywords Totales</div>
            </div>
            <div class="stat-card clickable" onclick="showKeywordAnalysis()" title="Click para an√°lisis">
                <div class="number" id="filteredCount">0</div>
                <div class="label">üîç Campa√±as Filtro</div>
            </div>
            <div class="stat-card clickable" onclick="filterByArticleStatus()" title="Click para filtrar">
                <div class="number" id="totalArticles">0</div>
                <div class="label">üìù Con Art√≠culo üîç</div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('tab-list')">üìã Lista de Campa√±as</button>
            <button class="tab-btn" onclick="switchTab('tab-comp')">üî¨ Comparador</button>
            <button class="tab-btn" onclick="switchTab('tab-add')">‚ûï Gestionar Campa√±a</button>
            <button class="tab-btn" onclick="switchTab('tab-config')">‚öôÔ∏è Configuraci√≥n Global</button>
            <button class="tab-btn" onclick="switchTab('tab-catalog')">üì° Cat√°logo HAV</button>
        </div>

        <div id="tab-list" class="tab-content active">
            <div class="controls">
                <div class="control-group"><label>üîç Buscar</label><input type="text" id="search" autocomplete="off" onkeyup="renderTable()"></div>
                <div class="control-group"><label>üì∫ Canal</label><select id="filterChannel" onchange="renderTable()"></select></div>
                <div class="control-group"><label>üÜî ID Campa√±a</label><select id="filterId" onchange="renderTable()"></select></div>
                <div class="control-group"><label>üì¶ Nicho</label><select id="filterProduct" onchange="renderTable()"></select></div>
                <div class="control-group"><label>üì° Plataforma</label><select id="filterPlatform" onchange="renderTable()"></select></div>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th onclick="applySort('date')">üìÖ Fecha</th>
                            <th onclick="applySort('platform')">Plat.</th>
                            <th onclick="applySort('channel')">Canal</th>
                            <th onclick="applySort('product')">Nicho</th>
                            <th onclick="applySort('id')">ID</th>
                            <th onclick="applySort('code')">Nombre de Campa√±a</th>
                            <th onclick="applySort('language')">Idioma</th>
                            <th onclick="applySort('country')">Pa√≠s</th>
                            <th onclick="applySort('keys')">Keys</th>
                            <th onclick="applySort('article')">Art√≠culo</th>
                            <th onclick="applySort('url')">Link</th>
                            <th onclick="applySort('autor')">üë§</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="campaignList"></tbody>
                </table>
            </div>
        </div>

        <div id="tab-comp" class="tab-content">
            <h2>Analizar 3 Campa√±as Simult√°neamente</h2>
            <div class="controls" style="margin-top: 15px;">
                <div class="control-group"><label>Campa√±a 1</label><select id="comp1" onchange="runTripleComparison()"></select></div>
                <div class="control-group"><label>Campa√±a 2</label><select id="comp2" onchange="runTripleComparison()"></select></div>
                <div class="control-group"><label>Campa√±a 3</label><select id="comp3" onchange="runTripleComparison()"></select></div>
            </div>
            <div id="compResults" class="comparator-grid"></div>
        </div>

        <div id="tab-add" class="tab-content">
            <h2 id="formTitle">Gestionar Campa√±a</h2>
            <div class="controls" style="grid-template-columns: repeat(4, 1fr); margin-top: 15px;">
                <div class="control-group"><label>Plataforma</label><select id="inPlatform"></select></div>
                <div class="control-group"><label>Canal</label><select id="inChannel"></select></div>
                <datalist id="adManagerList"><option value="HAV"><option value="Otro"></datalist>
                <div class="control-group"><label>Idioma</label><select id="inLanguage"><option value="">Seleccionar idioma...</option></select></div>
                <div class="control-group"><label>Nicho/Producto</label><select id="inProduct"></select></div>
            </div>
            
            <div class="controls" style="grid-template-columns: repeat(4, 1fr); margin-top: 15px;">
                <div class="control-group"><label>üìÖ Fecha</label><input type="date" id="inDate"></div>
                <div class="control-group"><label>ID Campa√±a</label><select id="inId"></select></div>
                <div class="control-group"><label>Nombre de Campa√±a</label><input type="text" id="inCode" oninput="autoCompleteCampaign()"></div>
                <div class="control-group"><label>Pa√≠s (ISO)</label><input type="text" id="inCountry"></div>
            </div>
            <div class="control-group" style="margin-top: 15px;">
                <label style="margin-bottom: 10px;">Keywords (una por l√≠nea)</label>

                <!-- Keywords divididas en dos columnas GRANDES -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: start;">
                    <!-- COLUMNA 1: Botones de negrita -->
                    <div>
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <button class="btn btn-bold" onclick="boldSelectedText()" style="padding: 6px 10px; font-size: 0.85em;"><b>B</b> Negrita</button>
                            <button class="btn btn-clear-tags" onclick="clearAllBoldTags()" style="padding: 6px 10px; font-size: 0.85em;">üóëÔ∏è Limpiar Negritas</button>
                        </div>
                        <textarea id="inKeywords1" rows="20" style="width: 100%; height: 400px; resize: vertical;"></textarea>
                    </div>

                    <!-- COLUMNA 2: Bot√≥n Obs. -->
                    <div>
                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                            <button class="btn" style="background: #764ba2; color: white; padding: 6px 12px; font-size: 0.9em; cursor: default;" disabled>üìå Observaciones</button>
                        </div>
                        <textarea id="inKeywords2" rows="20" style="width: 100%; height: 400px; resize: vertical;"></textarea>
                    </div>
                </div>

                <!-- Campo de Observaciones (oculto por defecto) -->
                <div id="obsContainer" style="display: none; margin-top: 10px;">
                    <label style="font-size: 0.9em; color: #666;">Observaciones de la campa√±a:</label>
                    <textarea id="inObservaciones" rows="3"></textarea>
                </div>
            </div>
            
            <div class="control-group" style="margin-top: 15px;">
                <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 5px;">
                    <label style="margin-bottom: 0;">üìù Art√≠culo (Markdown)</label>
                    
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <label style="margin: 0; font-size: 0.9em; font-weight: bold;">‚úçÔ∏è Autor:</label>
                            <select id="inAutor" style="padding: 5px 10px; font-size: 0.9em; border: 1px solid var(--border); border-radius: 4px;">
                                <option value="">-</option>
                                <option value="I">I</option>
                                <option value="H">H</option>
                            </select>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <label style="margin: 0; font-size: 0.9em; font-weight: bold;">üîó URL:</label>
                            <input type="text" id="inUrl" placeholder="Pega aqu√≠ la URL..." style="padding: 5px 10px; font-size: 0.9em; border: 1px solid var(--border); border-radius: 4px; width: 300px;">
                        </div>
                    </div>
                </div>
                <textarea id="inArticle" rows="15" placeholder="Pega aqu√≠ tu art√≠culo en formato Markdown..."></textarea>
            </div>

            <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-edit" onclick="saveCampaign()">üíæ Guardar en Nube</button>
                <button class="btn btn-meta" onclick="saveMetadataOnly()" id="btnMetaOnly" style="display:none;">üìù Actualizar solo Datos</button>
                <button class="btn btn-warning" onclick="exportarCampanas()">üì§ Exportar Copia Seguridad</button> <button class="btn btn-del" onclick="resetForm()">üîÑ Limpiar Formulario</button>
                <input type="file" id="importFile" accept=".json" style="display:none" onchange="importarDatos(event)">
                <button class="btn btn-primary" onclick="document.getElementById('importFile').click()">üì• Importar Backup JSON</button>
            </div>
        </div>

        <div id="tab-config" class="tab-content">
            <h2>Configuraci√≥n Global (Sincronizada)</h2>
            <div class="config-section" style="background: #f8f9fa; padding: 20px; margin: 20px 0; border-radius: 8px; border-left: 4px solid #007bff;">
                <h3 style="margin-top: 0; color: #007bff;">üì¶ Gesti√≥n del Cat√°logo HAV</h3>
                <div style="margin-bottom: 15px;">
                    <button class="btn btn-primary" onclick="document.getElementById('importFile').click()">
                        üì• Importar Cat√°logo JSON
                    </button>
                    <button class="btn btn-warning" onclick="forzarLimpiezaDuplicados()" style="margin-left: 10px;">
                        üßπ Eliminar Duplicados
                    </button>
                    <button class="btn btn-del" onclick="borrarCatalogoCompleto()" style="margin-left: 10px;">
                        üóëÔ∏è Borrar Cat√°logo Completo
                    </button>
                </div>
                <p style="margin: 0; font-size: 0.9em; color: #666;">
                    ‚Ä¢ <strong>Importar:</strong> Agrega canales desde un archivo JSON<br>
                    ‚Ä¢ <strong>Eliminar Duplicados:</strong> Limpia canales repetidos<br>
                    ‚Ä¢ <strong>Borrar Completo:</strong> Elimina TODO el cat√°logo HAV
                </p>
            </div>

            <div class="controls">
                <div class="control-group"><label>‚ûï Nuevo ID</label><input type="text" id="newIdVal" placeholder=""><button class="btn btn-edit" onclick="addOption('ids', 'newIdVal')">Crear</button></div>
                <div class="control-group"><label>‚ûï Nuevo Nicho</label><input type="text" id="newProdName" placeholder="Ej: Escritorio"><button class="btn btn-edit" onclick="addOption('products', 'newProdName')">Crear</button></div>
                <div class="control-group"><label>‚ûï Nueva Plataforma</label><select id="newPlatName"><option value="Facebook">Facebook</option><option value="TikTok">TikTok</option><option value="Google">Google</option></select><button class="btn btn-edit" onclick="addOption('platforms', 'newPlatName')">Crear</button></div>
                <div class="control-group"><label>‚ûï Nuevo Canal</label><input type="text" id="newChanName"><button class="btn btn-edit" onclick="addOption('channels', 'newChanName')">Crear</button></div>
                <div class="control-group"><label>‚ûï Nuevo Idioma</label><input type="text" id="newLangName" placeholder="Ej: Alem√°n"><button class="btn btn-edit" onclick="addOption('languages', 'newLangName')">Crear</button></div>
                <div class="control-group"><label>‚ûï Nuevo Pa√≠s</label><input type="text" id="newCountryName" placeholder="Ej: PE (Per√∫)"><button class="btn btn-edit" onclick="addOption('countries', 'newCountryName')">Crear</button></div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 25px;">
                <div><h4 style="color:var(--primary)">üÜî IDs de Campa√±a</h4><ul id="listIds" class="config-list"></ul></div>
                <div><h4 style="color:var(--secondary)">üì¶ Nichos</h4><ul id="listProds" class="config-list"></ul></div>
                <div><h4 style="color:var(--dark)">üì° Plataformas</h4><ul id="listPlatforms" class="config-list"></ul></div>
                <div><h4 style="color:var(--dark)">üì∫ Canales</h4><ul id="listChannels" class="config-list"></ul></div>
                <div><h4 style="color:var(--dark)">üåê Idiomas</h4><ul id="listLanguages" class="config-list"></ul></div>
                <div><h4 style="color:var(--dark)">üåç Pa√≠ses</h4><ul id="listCountries" class="config-list"></ul></div>
            </div>
        </div>

        <div id="tab-catalog" class="tab-content">
            <h2 style="color: #667eea; margin-bottom: 20px;">üì° Cat√°logo HAV - Canales en la Nube</h2>
            <div style="margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="addNewHAVChannel()">‚ûï Agregar Nuevo Canal</button>
            </div>
            <div id="havCatalogContainer" class="hav-catalog-grid"></div>
        </div>
    </div>

    <div id="editChannelModal" class="modal">
        <div class="modal-content">
            <h3>‚úèÔ∏è Editar Canal HAV</h3>
            <div class="control-group"><label>Plataforma</label><select id="modalPlatform"><option value="FB">Facebook (FB)</option><option value="TT">TikTok (TT)</option><option value="GN">Google (GN)</option></select></div>
            <div class="control-group" style="margin-top: 15px;"><label>Nombre del Canal (sin prefijo)</label><input type="text" id="modalChannelName" placeholder=""></div>
            <div class="control-group" style="margin-top: 15px;"><label>ID del Canal</label><input type="text" id="modalChannelId" placeholder=""></div>
            <div class="control-group" style="margin-top: 15px;"><label>Categor√≠a/Grupo</label><input type="text" id="modalChannelGroup" placeholder=""></div>
            <div class="modal-buttons"><button class="btn btn-del" onclick="closeChannelModal()">‚ùå Cancelar</button><button class="btn btn-success" onclick="saveChannelEdit()">üíæ Guardar</button></div>
        </div>
    </div>

<script>
// ============================================================================
// 1. CONFIGURACI√ìN FIREBASE
// ============================================================================
const firebaseConfig = {
  apiKey: "AIzaSyB6lGHmig5XC4RPwAFnWaBFkpXIqdO_WoM",
  authDomain: "gestor-campanas-hav2026.firebaseapp.com",
  projectId: "gestor-campanas-hav2026",
  storageBucket: "gestor-campanas-hav2026.firebasestorage.app",
  messagingSenderId: "1715326503",
  appId: "1:1715326503:web:2b7ecda6f5257c9da78802"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const dbFirebase = firebase.firestore();
const campaignsRef = dbFirebase.collection('campaigns');
const settingsRef = dbFirebase.collection('settings').doc('globalConfig'); 

console.log('üî• Firebase conectado');

// ============================================================================
// 2. DATOS HIST√ìRICOS Y RESPALDOS (TU BASE DE DATOS ORIGINAL INTACTA)
// ============================================================================

const initialCampaigns = [
    { "platform": "FB", "channel": "HAV", "product": "Celulares", "country": "PL", "code": "FB-HAV-Celulares-PL", "id": "00902", "keywords": ["Telefon na raty", "Telefony na Raty Przez Internet", "Telefon w miesiƒôcznych ratach", "Finansowanie Telefon bez wp≈Çaty poczƒÖtkowe", "Telefon na raty bez BIK", "Telefon na Raty Bez Banku"], "article": "" },
    // ... [Tu historial original sigue aqu√≠ protegido]
    { "platform": "FB", "channel": "HAV", "product": "Iphone", "country": "DE", "code": "FB-HAV-Iphone-DE", "id": "00903", "keywords": ["Iphone Bestellen auf Raten", "Iphone Ratenkauf"], "article": "" }
];

const ALL_NICHOS = [
    'AireAcondicionado', 'Apartamentos', 'Autos', 'AutosElectricos', 'Bicicletas',
    'CadenasDeOro', 'Celulares', 'Colchones', 'Cortacesped', 'CursoDeIngles',
    'CursoDeMarketingDigital', 'CursosInteligenciaArtificial', 'Escritorio',
    'Generadores', 'Iphone', 'Muebles', 'MueblesDeCocina', 'PcGamer', 'PcGamerBM2',
    'Refrigeradores', 'Sofa', 'SofaCama', 'Televisores', 'UniversidadesOnline'
];

const ALL_LANGUAGES = ['Alem√°n', 'Ingl√©s', 'Neerland√©s', 'B√∫lgaro', 'Espa√±ol', 'Portugu√©s', 'Checo', 'Dan√©s', 'Fin√©s', 'Franc√©s', 'H√∫ngaro', 'Italiano', 'Lituano', 'Noruego', 'Polaco', 'Rumano', '√Årabe', 'Sueco', 'Esloveno', 'Eslovaco', 'Turco'];

const HAV_CATALOG_INITIAL = {};

// ============================================================================
// 3. ESTRUCTURA DE DATOS
// ============================================================================
let db = JSON.parse(localStorage.getItem('arbitrage_final_v11')) || {
    campaigns: initialCampaigns, // SE INICIA CON TUS DATOS HIST√ìRICOS
    platforms: ['FB', 'TT', 'GN'],
    channels: ['Mundo', 'IH', 'CS', 'HN'],
    products: ALL_NICHOS,
    ids: ['00902', '00903', '00904', '00905', '00908', '00909'],
    havCatalog: HAV_CATALOG_INITIAL
};

// --- FIX: Inicializaci√≥n segura de arrays ---
if (!db.ids) db.ids = ['00902', '00903', '00904', '00905', '00908', '00909'];
if (!db.products) db.products = ALL_NICHOS;
if (!db.platforms) db.platforms = ['FB', 'TT', 'GN'];
if (!db.channels) db.channels = ['Mundo', 'IH', 'CS', 'HN'];
if (!db.countries) db.countries = ['PL', 'DE', 'ES', 'FR', 'IT', 'NL', 'BE', 'PT', 'UK', 'US', 'MX', 'AR', 'BR', 'CL', 'CO', 'PE'];
// ------------------------------------------

let editingIndex = -1;
let currentSort = { column: 'country', order: 'asc' };
let currentEditingChannel = null;

// ============================================================================
// 4. L√ìGICA DE NUBE (H√çBRIDA PARA PROTECCI√ìN DE DATOS)
// ============================================================================


function limpiarDuplicadosCatalogo() {
    let totalEliminados = 0;
    for (let categoria in db.havCatalog) {
        if (!Array.isArray(db.havCatalog[categoria])) continue;
        const items = db.havCatalog[categoria];
        const codesVistos = new Set();
        const itemsUnicos = [];
        items.forEach(item => {
            if (!codesVistos.has(item.code)) {
                codesVistos.add(item.code);
                itemsUnicos.push(item);
            } else {
                totalEliminados++;
            }
        });
        db.havCatalog[categoria] = itemsUnicos;
    }
    if (totalEliminados > 0) {
        saveGlobalSettings();
        refreshEverything();
        showNotif(`üßπ ${totalEliminados} duplicados eliminados`, 'success');
    }
    return totalEliminados;
}

function borrarCatalogoCompleto() {
    if (confirm('‚ö†Ô∏è ¬øBORRAR TODO EL CAT√ÅLOGO HAV?\n\nEsta acci√≥n eliminar√° TODOS los canales.\n¬øEst√°s seguro?')) {
        if (confirm('‚ö†Ô∏è‚ö†Ô∏è √öLTIMA CONFIRMACI√ìN\n\nSe borrar√°n TODOS los canales. ¬øContinuar?')) {
            db.havCatalog = {};
            saveGlobalSettings();
            refreshEverything();
            showNotif('üóëÔ∏è Cat√°logo HAV borrado', 'warning');
        }
    }
}

function forzarLimpiezaDuplicados() {
    const total = limpiarDuplicadosCatalogo();
    alert(total === 0 ? '‚úÖ No hay duplicados' : `üßπ ${total} duplicados eliminados`);
}

function startRealtimeSync() {
    setTimeout(() => { limpiarDuplicadosCatalogo(); }, 3000);
    showNotif('üì° Conectando a la Nube...', 'info');

    // A) Escuchar CAMPA√ëAS
    campaignsRef.onSnapshot(snapshot => {
        const loaded = [];
        snapshot.forEach(doc => loaded.push({ firebaseId: doc.id, ...doc.data() }));
        
        if (loaded.length > 0) {
            // Si la nube tiene datos, los usamos (as√≠ tus compa√±eros ven lo mismo)
            db.campaigns = loaded;
        } else {
            // Si la nube est√° vac√≠a, MANTENEMOS TUS DATOS LOCALES y los subimos silenciosamente
            console.log("‚ö†Ô∏è Nube vac√≠a. Usando datos hist√≥ricos y subi√©ndolos...");
            // initialCampaigns.forEach(c => campaignsRef.add(c));
        }
        
        renderTable();
        updateStats();
    });

    // B) Escuchar CONFIGURACI√ìN
    settingsRef.onSnapshot(doc => {
        if (doc.exists) {
            const data = doc.data();
            // PROTECCI√ìN: Si la nube devuelve nichos vac√≠os, ignoramos y usamos los locales
            if (data.products && data.products.length > 0) {
                db.products = data.products;
            } else {
                console.log("‚ö†Ô∏è Recuperando Nichos Locales...");
                db.products = ALL_NICHOS; 
                saveGlobalSettings(); // Reparar nube
            }

            if (data.ids !== undefined) {
                const mergedIds = [...new Set([...(db.ids || []), ...(data.ids || [])])];
                db.ids = mergedIds.sort();
            } else {
                db.ids = db.ids || [];
            }
            if (data.platforms !== undefined) {
                const mergedPlatforms = [...new Set([...(db.platforms || []), ...(data.platforms || [])])];
                db.platforms = mergedPlatforms.sort();
            } else {
                db.platforms = db.platforms || [];
            }
            if (data.channels !== undefined) {
                const mergedChannels = [...new Set([...(db.channels || []), ...(data.channels || [])])];
                db.channels = mergedChannels.sort();
            } else {
                db.channels = db.channels || [];
            }
            db.languages = data.languages || ALL_LANGUAGES;
            db.havCatalog = (data.havCatalog && Object.keys(data.havCatalog).length) ? data.havCatalog : HAV_CATALOG_INITIAL;
            
            refreshEverything();
        } else {
            // Primera vez: Subimos tu configuraci√≥n local a la nube
            console.log("‚ö†Ô∏è Inicializando nube con tus datos...");
            saveGlobalSettings();
        }
    });
}

// 4. NUEVA FUNCI√ìN EXPORTAR (TU SEGURO DE VIDA)
function exportarCampanas() {
    const dataStr = JSON.stringify(db.campaigns, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `backup_campanas_${new Date().toISOString().slice(0,10)}.json`;
    link.click();
    showNotif('‚úÖ Copia de seguridad descargada', 'success');
}

async function saveToFirebase(campaign) {
  try {
    if (campaign.firebaseId) {
      const { firebaseId, ...data } = campaign;
      await campaignsRef.doc(firebaseId).update(data);
      showNotif('‚òÅÔ∏è Actualizado en Nube', 'success');
    } else {
      await campaignsRef.add(campaign);
      showNotif('‚òÅÔ∏è Guardado en Nube', 'success');
    }
  } catch (error) { alert('Error nube: ' + error.message); }
}

async function deleteFromFirebase(firebaseId) {
  try { await campaignsRef.doc(firebaseId).delete(); showNotif('üóëÔ∏è Borrado de Nube', 'success'); } catch (error) { console.error(error); }
}

async function saveGlobalSettings() {
    try {
        await settingsRef.set({
            products: db.products,
            ids: db.ids,
            platforms: db.platforms,
            channels: db.channels,
            languages: db.languages,
            havCatalog: db.havCatalog,
            countries: db.countries || [],
            lastUpdate: new Date().toISOString()
        }, { merge: true });
    } catch (error) { console.error(error); }
}

// ============================================================================
// 5. INTERFAZ (UI) - EXACTAMENTE COMO LA ORIGINAL
// ============================================================================

const nichoEmojis = {
    'cadena': '‚õìÔ∏è', 'oro': 'üí∞', 'joya': 'üíé', 'iphone': 'üì±', 'celular': 'üì±', 
    'tv': 'üì∫', 'televisor': 'üì∫', 'televisores': 'üì∫',
    'sof√°': 'üõãÔ∏è', 'sofa': 'üõãÔ∏è', 'mueble': 'ü™ë', 'bici': 'üö≤', 
    'pc': 'üíª', 'colch√≥n': 'üõèÔ∏è', 'auto': 'üöó', 'curso': 'üìö', 'jard√≠n': 'üåø',
    'aire': '‚ùÑÔ∏è', 'refriger': 'üßä', 'generador': '‚ö°', 'cortacesped': 'üåø',
    'escritorio': 'üñ•Ô∏è', 'apartamento': 'üè¢'
};

function getNichoConEmoji(nicho) {
    if (!nicho) return '';
    const n = nicho.toLowerCase();
    for (let key in nichoEmojis) { if (n.includes(key)) return nichoEmojis[key] + ' ' + nicho; }
    return nicho;
}

function updateCampPlatform(index, newPlatform) {
    const c = db.campaigns[index];
    if (c) { c.platform = newPlatform; saveToFirebase(c); }
}

function switchTab(id) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelector(`[onclick="switchTab('${id}')"]`).classList.add('active');
    if(id === 'tab-comp') updateCompSelects();
    if(id === 'tab-catalog') renderHAVCatalog();
}

function updateStats(filteredCampaigns = null) {
    const campaignsToCount = filteredCampaigns !== null ? filteredCampaigns : db.campaigns;

    document.getElementById('totalCampaigns').textContent = db.campaigns.length;
    const totalKeys = db.campaigns.reduce((sum, c) => sum + (c.keywords?.length || 0), 0);
    document.getElementById('totalKeywords').textContent = totalKeys;

    const filteredElement = document.getElementById('filteredCount');
    if (filteredElement) {
        filteredElement.textContent = (filteredCampaigns !== null) ? filteredCampaigns.length : 0;
    }

    const withArticles = campaignsToCount.filter(c => c.article && c.article.trim()).length;
    document.getElementById('totalArticles').textContent = withArticles;
}

function refreshEverything() { updateOptions(); renderTable(); updateStats(); renderHAVCatalog(); }

function updateOptions() {
    const fill = (id, arr, isFilter) => {
        const el = document.getElementById(id);
        if(!el) return;
        el.innerHTML = (isFilter ? '<option value="">Todos</option>' : '') + 
                       (arr || []).map(opt => `<option value="${opt}">${opt}</option>`).join('');
    };

    fill('inPlatform', db.platforms); fill('filterPlatform', db.platforms, true);
    fill('inChannel', db.channels); fill('filterChannel', db.channels, true);
    // Aseguramos que siempre use la lista completa si la db falla
    fill('inProduct', db.products.length ? db.products : ALL_NICHOS); 
    fill('filterProduct', db.products.length ? db.products : ALL_NICHOS, true);
    fill('inId', db.ids); fill('filterId', db.ids, true);
    fill('inLanguage', db.languages);

    ['ids', 'products', 'platforms', 'channels', 'languages', 'countries'].forEach(type => {
        let listId = '';
        if(type==='ids') listId='listIds'; else if(type==='products') listId='listProds'; else if(type==='platforms') listId='listPlatforms'; else if(type==='channels') listId='listChannels'; else if(type==='languages') listId='listLanguages'; else if(type==='countries') listId='listCountries';
        
        const container = document.getElementById(listId);
        if(container && db[type]) {
            container.innerHTML = db[type].map((val, i) => `
                <li>
                    <input type="text" class="config-input" value="${val}" id="input_${type}_${i}">
                    <button class="btn btn-save-mini" onclick="updateGlobalItem('${type}', ${i})">üíæ</button>
                    <button class="btn-del-mini" onclick="delOption('${type}', ${i})">üóëÔ∏è</button>
                </li>`).join('');
        }
    });
}

function addOption(type, inputId) {
    const val = document.getElementById(inputId).value.trim();
    if (!db[type]) db[type] = [];
    if (!val || db[type].includes(val)) return alert('Valor inv√°lido o ya existe');
    db[type].push(val); 
    db[type].sort();
    saveGlobalSettings();
    document.getElementById(inputId).value = '';
    showNotif('‚úÖ Agregado', 'success');
    refreshEverything();
}

function delOption(type, index) {
    if (confirm('¬øEliminar?')) { db[type].splice(index, 1); saveGlobalSettings(); refreshEverything(); }
}

function updateGlobalItem(type, index) {
    const newVal = document.getElementById(`input_${type}_${index}`).value.trim();
    if(newVal) { db[type][index] = newVal; saveGlobalSettings(); showNotif('‚úÖ Actualizado', 'success'); }
}

function renderTable() {
    const q = document.getElementById('search').value.toLowerCase();
    const pF = document.getElementById('filterPlatform').value;
    const prF = document.getElementById('filterProduct').value;
    const idF = document.getElementById('filterId').value;
    const chF = document.getElementById('filterChannel').value;

    let filtered = db.campaigns.filter(c => 
        (c.code.toLowerCase().includes(q) || c.id.includes(q) || c.country.toLowerCase().includes(q)) && 
        (!pF || c.platform === pF) && 
        (!prF || c.product === prF) && 
        (!idF || c.id === idF) &&
        (!chF || chF === 'Todos' || c.channel === chF)
    );

    filtered.sort((a, b) => {
        let vA = a[currentSort.column], vB = b[currentSort.column];

        // 1. L√≥gica especial para contar Keys
        if (currentSort.column === 'keys') {
            vA = a.keywords?.length || 0;
            vB = b.keywords?.length || 0;
        }

        // 2. L√≥gica especial para Art√≠culo (Correcci√≥n aplicada)
        if (currentSort.column === 'article') {
            const hasA = a.article && a.article.trim() ? 1 : 0;
            const hasB = b.article && b.article.trim() ? 1 : 0;
            
            // Si uno tiene y el otro no, eso decide el orden
            if (hasA !== hasB) {
                vA = hasA; 
                vB = hasB;
            } else {
                // Si ambos tienen (o no tienen), desempatamos por longitud de texto
                vA = (a.article || '').length;
                vB = (b.article || '').length;
            }
        }

        // 3. L√≥gica especial para URL/Link (Correcci√≥n aplicada)
        if (currentSort.column === 'url') {
            // Convertimos a 1 (tiene link) o 0 (no tiene link)
            const hasLinkA = (a.url && String(a.url).trim().length > 0) ? 1 : 0;
            const hasLinkB = (b.url && String(b.url).trim().length > 0) ? 1 : 0;
            vA = hasLinkA;
            vB = hasLinkB;
        }

        // 4. L√≥gica para Autor
        if (currentSort.column === 'autor') {
            vA = (a.autor || '').toLowerCase();
            vB = (b.autor || '').toLowerCase();
        }

        // === PARTE CR√çTICA: EL COMPARADOR ESTABLE ===
        // Esto soluciona el error en GitHub.
        // Si vA es menor que vB
        if (vA < vB) return currentSort.order === 'asc' ? -1 : 1;
        // Si vA es mayor que vB
        if (vA > vB) return currentSort.order === 'asc' ? 1 : -1;
        // Si son IGUALES (vA === vB), devolvemos 0 para no romper el orden
        return 0; 
    });

    const tbody = document.getElementById('campaignList');
    tbody.innerHTML = filtered.map(c => {
        const realIndex = db.campaigns.indexOf(c);
        const hasArticle = c.article && c.article.trim();
        const articleIcon = hasArticle ? 
            `<span class="article-indicator has-article" onclick="toggleArticle(${realIndex})">‚úÖ</span>` : 
            `<span class="article-indicator no-article">‚ùå</span>`;
        
        // CORRECCION FINAL: FORZAR VERDE SI HAY URL Y HACERLO CLICKABLE
        const hasUrl = (c.url && String(c.url).trim().length > 0);
        const urlClass = hasUrl ? 'url-active' : 'url-inactive';

        // Si hay URL, usamos <a> para ir al link. Si no, usamos <span>.
        const urlIcon = hasUrl
            ? `<a href="${c.url}" target="_blank" class="${urlClass}" title="Ir a: ${c.url}">üîó</a>`
            : `<span class="${urlClass}" title="Sin Link">üîó</span>`;

        // 3. SELECCI√ìN DE NOMBRE DE PLATAFORMA (NO ABREVIADO)
        const getPlatName = (code) => {
            if(code === 'FB') return 'Facebook';
            if(code === 'TT') return 'TikTok';
            if(code === 'GN') return 'Google';
            return code;
        };

        return `<tr>
            <td>${c.date || '-'}</td> <td>
                <select class="platform-select" onchange="updateCampPlatform(${realIndex}, this.value)">
                    <option value="FB" ${c.platform === 'FB' ? 'selected' : ''}>Facebook</option>
                    <option value="TT" ${c.platform === 'TT' ? 'selected' : ''}>TikTok</option>
                    <option value="GN" ${c.platform === 'GN' ? 'selected' : ''}>Google</option>
                </select>
            </td>
            <td>${c.channel || '-'}</td>
            <td><strong>${getNichoConEmoji(c.product)}</strong></td>
            <td><code>${c.id}</code></td>
            <td><strong>${c.code}</strong></td> <td>${c.language || '-'}</td>
            <td>${c.country}</td>
            <td><strong>${c.keywords?.length || 0}</strong></td>
            <td style="text-align: center;">${articleIcon}</td>
            <td style="text-align: center;">${urlIcon}</td>
            <td style="text-align: center; font-weight: bold; color: var(--primary);">${c.autor || '-'}</td>
            <td>
                <button class="btn btn-edit" style="padding: 6px 10px;" onclick="editCampaign(${realIndex})">‚úèÔ∏è</button>
                <button class="btn btn-del" style="padding: 6px 10px;" onclick="deleteCampaign(${realIndex})">üóëÔ∏è</button>
                <button class="btn" style="padding: 6px 10px; ${c.observaciones && c.observaciones.trim() ? 'background: #ef4444; color: white;' : 'background: #e5e7eb; color: #666;'}" onclick="verObservacion(${realIndex})" title="${c.observaciones && c.observaciones.trim() ? 'Ver observaci√≥n' : 'Sin observaciones'}">üìå</button>
            </td>
        </tr>`;
    }).join('');
    updateStats(filtered);
}

function applySort(col) {
    currentSort.order = (currentSort.column === col && currentSort.order === 'asc') ? 'desc' : 'asc';
    currentSort.column = col;
    renderTable();
}

function toggleArticle(i) {
    const c = db.campaigns[i];
    if (c.article) {
        editCampaign(i);
        setTimeout(() => document.getElementById('inArticle').scrollIntoView(), 300);
    }
}

function editCampaign(index) {
    editingIndex = index;
    const c = db.campaigns[index];
    document.getElementById('inPlatform').value = c.platform;
    document.getElementById('inChannel').value = c.channel || '';
    document.getElementById('inProduct').value = c.product;
    document.getElementById('inId').value = c.id;
    document.getElementById('inCode').value = c.code;
    document.getElementById('inLanguage').value = c.language || '';
    document.getElementById('inCountry').value = c.country;
    // CAMPO FECHA EN EDICI√ìN
    document.getElementById('inDate').value = c.date || ''; 
    // Columna 1: TODAS las keywords, Columna 2: Observaciones
    const allKeys = c.keywords || [];
    document.getElementById('inKeywords1').value = allKeys.join('\n');
    document.getElementById('inKeywords2').value = c.observaciones || '';

    // Campo oculto no se usa
    document.getElementById('inObservaciones').value = '';
    document.getElementById('inArticle').value = c.article || '';
    document.getElementById('inAutor').value = c.autor || '';
    // CARGAR URL AL EDITAR
    document.getElementById('inUrl').value = c.url || '';
    
    document.getElementById('formTitle').textContent = '‚úèÔ∏è Editando: ' + c.code;
    document.getElementById('btnMetaOnly').style.display = 'inline-block';
    switchTab('tab-add');
}

function saveCampaign() {
    const platform = document.getElementById('inPlatform').value;
    const product = document.getElementById('inProduct').value;
    const id = document.getElementById('inId').value;
    const code = document.getElementById('inCode').value;
    const country = document.getElementById('inCountry').value.toUpperCase();

    if (!platform || !product || !id || !code || !country) return alert('‚ö†Ô∏è Faltan datos obligatorios');

    const campaign = {
        platform, 
        channel: document.getElementById('inChannel').value,
        product, id, code, country,
        date: document.getElementById('inDate').value,
        language: document.getElementById('inLanguage').value,
        keywords: document.getElementById('inKeywords1').value.split('\n').map(k=>k.trim()).filter(k=>k),
        observaciones: document.getElementById('inKeywords2').value,
        article: document.getElementById('inArticle').value,
        autor: document.getElementById('inAutor').value,
        url: document.getElementById('inUrl').value,
        updatedAt: new Date().toISOString()
    };

    if (editingIndex >= 0) {
        campaign.firebaseId = db.campaigns[editingIndex].firebaseId;
        db.campaigns[editingIndex] = campaign;
    } else {
        db.campaigns.push(campaign);
    }

    renderTable();
    updateStats();
    saveToFirebase(campaign);
    // Mantenerse en el formulario
    setTimeout(() => {
        resetForm();
        showNotif('‚úÖ Campa√±a guardada. Listo para la siguiente.', 'success');
    }, 500);
}

function autoCompleteCampaign() {
    const campaignName = document.getElementById('inCode').value.trim();

    // Si est√° vac√≠o, limpiar campos y no autocompletar
    if (!campaignName) {
        document.getElementById('inPlatform').value = '';
        document.getElementById('inChannel').value = '';
        document.getElementById('inProduct').value = '';
        document.getElementById('inLanguage').value = '';
        document.getElementById('inCountry').value = '';
        document.getElementById('inId').value = '';
        return;
    }

    const parts = campaignName.split('-');
    if (parts.length >= 4) {
        const [platform, channel, product, country] = parts;
        document.getElementById('inPlatform').value = platform || '';
        document.getElementById('inChannel').value = channel || '';
        document.getElementById('inProduct').value = product || '';
        document.getElementById('inCountry').value = country || '';

        const languageSelect = document.getElementById('inLanguage');
        const matchingCampaign = db.campaigns.find(c => c.code === campaignName);
        if (matchingCampaign && matchingCampaign.language) {
            languageSelect.value = matchingCampaign.language;
        }
    }
}


function saveMetadataOnly() {
    if (editingIndex < 0) return;
    const c = db.campaigns[editingIndex];
    c.platform = document.getElementById('inPlatform').value;
    c.channel = document.getElementById('inChannel').value;
    c.product = document.getElementById('inProduct').value;
    c.id = document.getElementById('inId').value;
    c.code = document.getElementById('inCode').value;
    c.country = document.getElementById('inCountry').value.toUpperCase();
    c.date = document.getElementById('inDate').value;
    c.autor = document.getElementById('inAutor').value;
    saveToFirebase(c);
    // Mantenerse en el formulario
    setTimeout(() => {
        resetForm();
        showNotif('‚úÖ Campa√±a guardada. Listo para la siguiente.', 'success');
    }, 500);
}

function deleteCampaign(index) {
    if (confirm('¬øEliminar campa√±a permanentemente de la nube?')) {
        const c = db.campaigns[index];
        if(c.firebaseId) deleteFromFirebase(c.firebaseId);
    }
}

function resetForm() {
    editingIndex = -1;
    document.querySelectorAll('#tab-add input, #tab-add select, #tab-add textarea').forEach(el => el.value = '');
    document.getElementById('formTitle').textContent = '‚ûï Nueva Campa√±a';
    document.getElementById('btnMetaOnly').style.display = 'none';
}

function boldSelectedText() {
    const ta = document.getElementById('inKeywords1') || document.getElementById('inKeywords2');
    if (!ta) return;
    const start = ta.selectionStart;
    const end = ta.selectionEnd;
    if (start === end) return;
    ta.value = ta.value.substring(0, start) + '<b>' + ta.value.substring(start, end) + '</b>' + ta.value.substring(end);
    const newPos = start + '<b>'.length + (end - start) + '</b>'.length;
    ta.focus();
    ta.setSelectionRange(newPos, newPos);
}
function clearAllBoldTags() {
    const ta = document.getElementById('inKeywords1') || document.getElementById('inKeywords2');
    if (!ta) return;
    ta.value = ta.value.replace(/<\/?b>/gi, '');
}

// ===== IMPORTAR (JSON) =====
function importarDatos(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const imported = JSON.parse(e.target.result);
            if (detectarCatalogo(imported)) {
                importarCatalogo(imported);
            } else if (Array.isArray(imported)) {
                if (confirm(`¬øImportar ${imported.length} campa√±as?`)) {
                    let count = 0;
                    imported.forEach(c => { saveToFirebase(c); count++; });
                    showNotif(`‚úÖ ${count} campa√±as importadas`, 'success');
                }
            } else {
                alert('‚ùå Formato no reconocido');
            }
        } catch (err) { alert('‚ùå Error: ' + err.message); console.error(err); }
    };
    reader.readAsText(file);
    event.target.value = '';
}

function detectarCatalogo(data) {
    if (typeof data !== 'object' || Array.isArray(data)) return false;
    for (let key in data) {
        if (Array.isArray(data[key]) && data[key].length > 0) {
            const firstItem = data[key][0];
            if (firstItem && firstItem.code && firstItem.id) return true;
        }
    }
    return false;
}

function importarCatalogo(catalogo) {
    let totalAgregados = 0;
    for (let categoria in catalogo) {
        if (!Array.isArray(catalogo[categoria])) continue;
        if (!db.havCatalog[categoria]) db.havCatalog[categoria] = [];
        catalogo[categoria].forEach(item => {
            if (!item || !item.code || !item.id) return;
            const existe = db.havCatalog[categoria].find(i => i.code === item.code);
            if (!existe) {
                db.havCatalog[categoria].push({
                    code: item.code,
                    id: item.id,
                    platform: item.platform || 'FB'
                });
                if (item.id && !db.ids.includes(item.id)) db.ids.push(item.id);
                totalAgregados++;
            }
        });
    }
    db.ids.sort();
    saveGlobalSettings();
    refreshEverything();
    setTimeout(() => limpiarDuplicadosCatalogo(), 500);
    showNotif(`‚úÖ Cat√°logo: ${totalAgregados} canales agregados`, 'success');
}

// ===== 1. CAT√ÅLOGO HAV (Restaurado a DISE√ëO HERMOSO Y ORDENADO) =====
function renderHAVCatalog() {
    const container = document.getElementById('havCatalogContainer');
    if (!container || !db.havCatalog) return;
    
    let html = '';
    // Colores por defecto para las tarjetas
    const platforms = { 
        'FB': { color: '#1877f2', bg: '#e7f3ff', n: 'üåé Meta' }, 
        'TT': { color: '#fe2c55', bg: '#fff0f3', n: 'üéµ TikTok' }, 
        'GN': { color: '#EA4335', bg: '#fff5f0', n: 'üîç Google' } 
    };

    // ORDEN ESPEC√çFICO: PRIMERO MUNDO META, TIKTOK, GOOGLE
    const orderedKeys = ['MUNDO Meta', 'Mundo TikTok', 'Google Ads'];
    const allKeys = Object.keys(db.havCatalog);
    // Filtrar los que no est√°n en la lista ordenada y agregarlos al final
    const finalOrder = [...orderedKeys, ...allKeys.filter(k => !orderedKeys.includes(k))];

    finalOrder.forEach(groupName => {
        const channels = db.havCatalog[groupName];
        if(!channels || !channels.length) return;
        const plat = channels[0].platform || 'FB';
        const style = platforms[plat] || platforms['FB'];
        
        html += `<div class="hav-platform-card" style="border-left-color: ${style.color}; background: ${style.bg}">
            <h3 style="color:${style.color}">${groupName}</h3>
            <div class="hav-channels-list">
                ${channels.map((ch, idx) => `
                <div class="hav-channel-item">
                    <div class="hav-channel-info">
                        <div class="hav-channel-name">${ch.code}</div>
                        <div class="hav-channel-id">${ch.id}</div>
                    </div>
                    <div class="hav-btn-group">
                        <button class="btn-mini btn-copy-mini" onclick="navigator.clipboard.writeText('${ch.code} | ${ch.id}');showNotif('Copiado','success')">üìã</button>
                        <button class="btn-mini btn-edit-mini" onclick="editHAVChannel('${groupName}', ${idx})">‚úèÔ∏è</button>
                        <button class="btn-mini btn-del-mini" onclick="deleteHAVChannel('${groupName}', ${idx})">üóëÔ∏è</button>
                    </div>
                </div>`).join('')}
            </div>
        </div>`;
    });
    container.innerHTML = html;
}

function addNewHAVChannel() {
    currentEditingChannel = null;
    document.getElementById('modalPlatform').value = 'FB';
    document.getElementById('modalChannelName').value = '';
    document.getElementById('modalChannelId').value = '';
    document.getElementById('modalChannelGroup').value = 'MUNDO Meta';
    document.getElementById('editChannelModal').classList.add('active');
}

function saveChannelEdit() {
    const plat = document.getElementById('modalPlatform').value;
    const name = document.getElementById('modalChannelName').value;
    const id = document.getElementById('modalChannelId').value;
    const group = document.getElementById('modalChannelGroup').value;
    
    if(!name || !id || !group) return alert('Completa todo');
    
    const code = `${plat}-HAV-${name}`;
    
    if (currentEditingChannel) {
        const oldGroup = currentEditingChannel.group;
        db.havCatalog[oldGroup].splice(currentEditingChannel.index, 1);
        if(db.havCatalog[oldGroup].length === 0) delete db.havCatalog[oldGroup];
    }
    
    if (!db.havCatalog[group]) db.havCatalog[group] = [];
    db.havCatalog[group].push({ code, id, platform: plat });
    
    saveGlobalSettings();
    closeChannelModal();
}

function deleteHAVChannel(group, index) {
    if(confirm('¬øEliminar canal?')) {
        db.havCatalog[group].splice(index, 1);
        if(db.havCatalog[group].length===0) delete db.havCatalog[group];
        saveGlobalSettings();
    }
}

function editHAVChannel(group, index) {
    currentEditingChannel = { group, index };
    const ch = db.havCatalog[group][index];
    document.getElementById('modalPlatform').value = ch.platform;
    document.getElementById('modalChannelName').value = ch.code.split('-HAV-')[1] || '';
    document.getElementById('modalChannelId').value = ch.id;
    document.getElementById('modalChannelGroup').value = group;
    document.getElementById('editChannelModal').classList.add('active');
}

function closeChannelModal() { document.getElementById('editChannelModal').classList.remove('active'); }

function showNotif(msg, type) {
    const n = document.createElement('div');
    n.textContent = msg;
    n.style.cssText = `position:fixed;bottom:20px;right:20px;background:${type==='success'?'#10b981':'#ef4444'};color:white;padding:15px;border-radius:8px;z-index:9999;box-shadow:0 4px 12px rgba(0,0,0,0.2)`;
    document.body.appendChild(n);
    setTimeout(()=>n.remove(), 2500);
}

// ===== COMPARADOR =====
function updateCompSelects() {
    ['comp1', 'comp2', 'comp3'].forEach(id => {
        const el = document.getElementById(id);
        el.innerHTML = '<option value="">Seleccionar...</option>' + 
            db.campaigns.map((c, i) => `<option value="${i}">${c.code} (${c.country})</option>`).join('');
    });
}

function runTripleComparison() {
    const i1 = document.getElementById('comp1').value;
    const i2 = document.getElementById('comp2').value;
    const i3 = document.getElementById('comp3').value;
    if (!i1 || !i2 || !i3) return;
    const campaigns = [db.campaigns[i1], db.campaigns[i2], db.campaigns[i3]];
    document.getElementById('compResults').innerHTML = campaigns.map(c => `
        <div class="comp-card">
            <h3>${c.code}</h3>
            <div class="metric"><strong>Pa√≠s:</strong><span>${c.country}</span></div>
            <div class="metric"><strong>ID:</strong><span>${c.id}</span></div>
            <div class="keyword-list">${c.keywords.map(k=>`<div class="keyword-item">${k}</div>`).join('')}</div>
        </div>`).join('');
}


// ===== AUTO-COMPLETAR DESDE CAT√ÅLOGO HAV =====
function autoCompleteFromHAV() {
    const nombreCampana = document.getElementById('inCode').value.trim();

    if (nombreCampana.length < 5) return; // Esperar a que escriba algo significativo

    // Parsear: FB-HAV-Autos-AE -> Platform, Canal, Nicho
    const partes = nombreCampana.split('-');
    if (partes.length < 3) return;

    const plataforma = partes[0]; // FB, TT, GN
    const nicho = partes[2];       // Autos, Celulares, Iphone, etc.

    console.log('üîç Buscando en cat√°logo:', { plataforma, nicho });

    // Buscar en el cat√°logo HAV
    let idEncontrado = null;
    let nichoEncontrado = null;

    // Recorrer todos los grupos del cat√°logo
    for (let grupo in db.havCatalog) {
        const canales = db.havCatalog[grupo];
        if (!canales || !Array.isArray(canales)) continue;

        for (let canal of canales) {
            // Verificar si el canal coincide con plataforma y nicho
            // Ejemplo: canal.code = "FB-HAV-Autos", canal.id = "00901", canal.platform = "FB"
            if (canal.platform === plataforma && canal.code.includes(nicho)) {
                idEncontrado = canal.id;
                nichoEncontrado = nicho;
                console.log('‚úÖ Encontrado:', canal);
                break;
            }
        }

        if (idEncontrado) break;
    }

    // Auto-completar NICHO
    if (nichoEncontrado) {
        const selectNicho = document.getElementById('inProduct');

        // Buscar el nicho exacto en el dropdown
        for (let i = 0; i < selectNicho.options.length; i++) {
            const opcion = selectNicho.options[i].value;

            // Coincidencia exacta o parcial
            if (opcion === nichoEncontrado || 
                opcion.toLowerCase().includes(nichoEncontrado.toLowerCase()) ||
                nichoEncontrado.toLowerCase().includes(opcion.toLowerCase())) {
                selectNicho.value = opcion;
                console.log('‚úÖ Nicho seleccionado:', opcion);
                break;
            }
        }
    }

    // Auto-completar ID
    if (idEncontrado) {
        // Si el ID no est√° en la lista, agregarlo
        if (!db.ids.includes(idEncontrado)) {
            console.log('‚ûï Agregando nuevo ID:', idEncontrado);
            db.ids.push(idEncontrado);
            db.ids.sort();
            saveGlobalSettings();

            // Refrescar los dropdowns
            updateOptions();
        }

        // Seleccionar el ID
        setTimeout(() => {
            document.getElementById('inId').value = idEncontrado;
            console.log('‚úÖ ID seleccionado:', idEncontrado);
        }, 100);
    }
}


// ========================================================================
// SISTEMA DE AUTENTICACI√ìN Y SEGURIDAD
// ========================================================================

const USUARIOS_AUTORIZADOS = {
    'haevedecano83': 'gestor2026**./',
    'amelemery': 'gestor2026**./'
};

function handleLogin(event) {
    event.preventDefault();

    const usuario = document.getElementById('loginUser').value.trim();
    const password = document.getElementById('loginPass').value;

    // Validar credenciales
    if (USUARIOS_AUTORIZADOS[usuario] && USUARIOS_AUTORIZADOS[usuario] === password) {
        // Login exitoso
        const timestamp = Date.now();
        localStorage.setItem('gestorHAV_auth', btoa(usuario + ':' + timestamp));
        localStorage.setItem('gestorHAV_user', usuario);
        localStorage.setItem('gestorHAV_loginTime', timestamp);

        showApp();
        console.log('‚úÖ Acceso autorizado:', usuario);
    } else {
        // Login fallido
        document.getElementById('loginError').classList.add('show');
        document.getElementById('loginPass').value = '';

        setTimeout(() => {
            document.getElementById('loginError').classList.remove('show');
        }, 3000);

        console.warn('‚ö†Ô∏è Intento de acceso denegado');
    }

    return false;
}

function showApp() {
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('mainApp').classList.add('show');
    document.getElementById('logoutBtn').style.display = 'block';

    const usuario = localStorage.getItem('gestorHAV_user');
    const loginTime = localStorage.getItem('gestorHAV_loginTime');

    console.log('üë§ Usuario activo:', usuario);
    console.log('üïê Sesi√≥n iniciada:', new Date(parseInt(loginTime)).toLocaleString());
}

function logout() {
    if (confirm('¬øCerrar sesi√≥n y salir del gestor?')) {
        localStorage.removeItem('gestorHAV_auth');
        localStorage.removeItem('gestorHAV_user');
        localStorage.removeItem('gestorHAV_loginTime');

        console.log('üö™ Sesi√≥n cerrada');
        location.reload();
    }
}

function checkSession() {
    const auth = localStorage.getItem('gestorHAV_auth');
    const usuario = localStorage.getItem('gestorHAV_user');
    const loginTime = localStorage.getItem('gestorHAV_loginTime');

    // Verificar si existe sesi√≥n v√°lida
    if (auth && usuario && loginTime && USUARIOS_AUTORIZADOS[usuario]) {
        // Verificar que la sesi√≥n no tenga m√°s de 7 d√≠as (opcional)
        const diasTranscurridos = (Date.now() - parseInt(loginTime)) / (1000 * 60 * 60 * 24);

        if (diasTranscurridos < 7) {
            // Sesi√≥n v√°lida - mostrar app directamente
            showApp();
            console.log('‚úÖ Sesi√≥n activa restaurada:', usuario);
        } else {
            // Sesi√≥n expirada
            logout();
            console.log('‚è∞ Sesi√≥n expirada - Requiere nuevo login');
        }
    } else {
        // No hay sesi√≥n - mostrar login
        document.getElementById('loginScreen').classList.remove('hidden');
        console.log('üîí Gestor protegido - Login requerido');
    }
}

// Verificar sesi√≥n autom√°ticamente al cargar
document.addEventListener('DOMContentLoaded', function() {
    checkSession();
});

// Tambi√©n verificar al cargar el script
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', checkSession);
} else {
    checkSession();
}

// ========================================================================
// FIN SISTEMA DE AUTENTICACI√ìN
// ========================================================================



// FUNCIONES DE ESTAD√çSTICAS INTERACTIVAS
let articleFilterActive = false;

function showKeywordAnalysis() {
    const totalCamps = db.campaigns.length;
    if (totalCamps === 0) {
        alert('No hay campa√±as para analizar');
        return;
    }

    const totalKeys = db.campaigns.reduce((sum, c) => sum + (c.keywords?.length || 0), 0);
    const avgKeys = Math.round(totalKeys / totalCamps);

    let maxCamp = db.campaigns[0];
    let minCamp = db.campaigns[0];

    db.campaigns.forEach(c => {
        const keysCount = c.keywords?.length || 0;
        if (keysCount > (maxCamp.keywords?.length || 0)) maxCamp = c;
        if (keysCount < (minCamp.keywords?.length || 0)) minCamp = c;
    });

    const above = db.campaigns.filter(c => (c.keywords?.length || 0) > avgKeys);
    const below = db.campaigns.filter(c => (c.keywords?.length || 0) < avgKeys);

    let html = '<div class="analysis-metric"><strong>üìä Promedio actual:</strong> ' + avgKeys + ' keywords/campa√±a</div>';

    html += '<div class="analysis-metric"><strong>üèÜ Campa√±a con M√ÅS keywords:</strong><br>';
    html += maxCamp.code + ' (' + maxCamp.country + ') ‚Üí <span style="color: var(--success); font-weight: bold;">' + (maxCamp.keywords?.length || 0) + ' keywords</span></div>';

    html += '<div class="analysis-metric"><strong>‚ö†Ô∏è Campa√±a con MENOS keywords:</strong><br>';
    html += minCamp.code + ' (' + minCamp.country + ') ‚Üí <span style="color: var(--danger); font-weight: bold;">' + (minCamp.keywords?.length || 0) + ' keywords</span></div>';

    html += '<div class="analysis-section"><h4 style="color: var(--success);">üü¢ Por ENCIMA del promedio (' + avgKeys + '+): ' + above.length + ' campa√±as</h4>';
    above.slice(0, 5).forEach(c => {
        html += '<div class="campaign-item above"><strong>' + c.code + '</strong> (' + c.country + ') ‚Üí ' + (c.keywords?.length || 0) + ' keywords</div>';
    });
    if (above.length > 5) {
        html += '<div style="text-align: center; color: #666; margin-top: 10px;">... y ' + (above.length - 5) + ' m√°s</div>';
    }
    html += '</div>';

    html += '<div class="analysis-section"><h4 style="color: var(--danger);">üî¥ Por DEBAJO del promedio (<' + avgKeys + '): ' + below.length + ' campa√±as</h4>';
    below.slice(0, 5).forEach(c => {
        html += '<div class="campaign-item below"><strong>' + c.code + '</strong> (' + c.country + ') ‚Üí ' + (c.keywords?.length || 0) + ' keywords ‚ö†Ô∏è</div>';
    });
    if (below.length > 5) {
        html += '<div style="text-align: center; color: #666; margin-top: 10px;">... y ' + (below.length - 5) + ' m√°s</div>';
    }
    html += '</div>';

    if (below.length > 0) {
        html += '<div class="analysis-metric" style="background: #fff3cd; border-left: 4px solid var(--warning);"><strong>üí° Sugerencia:</strong> ' + below.length + ' ' + (below.length === 1 ? 'campa√±a necesita' : 'campa√±as necesitan') + ' m√°s keywords.</div>';
    }

    document.getElementById('analysisBody').innerHTML = html;
    document.getElementById('analysisModal').classList.add('active');
}

function closeAnalysisModal() {
    document.getElementById('analysisModal').classList.remove('active');
}

function filterByArticleStatus() {
    if (!articleFilterActive) {
        const withoutArticle = db.campaigns.filter(c => !c.article || !c.article.trim());

        if (withoutArticle.length === 0) {
            showNotif('‚úÖ Todas las campa√±as tienen art√≠culo', 'success');
            return;
        }

        articleFilterActive = true;
        showNotif('‚ö†Ô∏è Mostrando ' + withoutArticle.length + ' campa√±as SIN art√≠culo', 'warning');
        renderTableFiltered(withoutArticle);
    } else {
        articleFilterActive = false;
        showNotif('‚úÖ Mostrando todas las campa√±as', 'success');
        renderTable();
    }
}

function renderTableFiltered(campaigns) {
    const tbody = document.getElementById('campaignList');
    tbody.innerHTML = campaigns.map(c => {
        const realIndex = db.campaigns.indexOf(c);
        const hasArticle = c.article && c.article.trim();
        const articleIcon = hasArticle ? 
            '<span class="article-indicator has-article" onclick="toggleArticle(' + realIndex + ')">‚úÖ</span>' : 
            '<span class="article-indicator no-article">‚ùå</span>';

        const hasUrl = (c.url && String(c.url).trim().length > 0);
        const urlClass = hasUrl ? 'url-active' : 'url-inactive';
        const urlIcon = hasUrl ?
            '<a href="' + c.url + '" target="_blank" class="' + urlClass + '" title="Ir a: ' + c.url + '">üîó</a>' :
            '<span class="' + urlClass + '" title="Sin Link">üîó</span>';

        return '<tr style="background: #fff3cd;"><td>' + (c.date || '-') + '</td><td><select class="platform-select" onchange="updateCampPlatform(' + realIndex + ', this.value)"><option value="FB" ' + (c.platform === 'FB' ? 'selected' : '') + '>Facebook</option><option value="TT" ' + (c.platform === 'TT' ? 'selected' : '') + '>TikTok</option><option value="GN" ' + (c.platform === 'GN' ? 'selected' : '') + '>Google</option></select></td><td>' + (c.channel || '-') + '</td><td><strong>' + getNichoConEmoji(c.product) + '</strong></td><td><code>' + c.id + '</code></td><td><strong>' + c.code + '</strong></td><td>' + (c.language || '-') + '</td><td>' + c.country + '</td><td><strong>' + (c.keywords?.length || 0) + '</strong></td><td style="text-align: center;">' + articleIcon + '</td><td style="text-align: center;">' + urlIcon + '</td><td style="text-align: center; font-weight: bold; color: var(--primary);">' + (c.autor || '-') + '</td><td><button class="btn btn-edit" style="padding: 6px 10px;" onclick="editCampaign(' + realIndex + ')">‚úèÔ∏è</button><button class="btn btn-del" style="padding: 6px 10px;" onclick="deleteCampaign(' + realIndex + ')">üóëÔ∏è</button><button class="btn" style="padding: 6px 10px; ' + (c.observaciones && c.observaciones.trim() ? 'background: #ef4444; color: white;' : 'background: #e5e7eb; color: #666;') + '" onclick="verObservacion(' + realIndex + ')">üìå</button></td></tr>';
    }).join('');
}


window.onload = function() {
    startRealtimeSync();

    // Listener para auto-completar al escribir nombre de campa√±a
    const campoNombre = document.getElementById('inCode');
    if (campoNombre) {
        campoNombre.addEventListener('input', autoCompleteFromHAV);
        console.log('‚úÖ Auto-completado activado');
    }
    document.getElementById('inProduct').addEventListener('change', function() {});
    document.getElementById('editChannelModal').addEventListener('click', function(e) {
        if (e.target === this) closeChannelModal();
    });
};

// FUNCI√ìN PARA MOSTRAR/OCULTAR OBSERVACIONES
function toggleObservaciones() {
    const container = document.getElementById('obsContainer');
    if (container) {
        container.style.display = container.style.display === 'none' ? 'block' : 'none';
    }
}

// FUNCI√ìN PARA VER OBSERVACI√ìN DESDE LA TABLA
function verObservacion(index) {
    const c = db.campaigns[index];
    if (c.observaciones && c.observaciones.trim()) {
        alert('üìå Observaci√≥n de campa√±a ' + c.code + ':\n\n' + c.observaciones);
    } else {
        alert('Esta campa√±a no tiene observaciones.');
    }
}

</script>


    <!-- Modal An√°lisis Keywords -->
    <div id="analysisModal" class="analysis-modal" onclick="if(event.target === this) closeAnalysisModal()">
        <div class="analysis-content">
            <div class="analysis-header">üìä An√°lisis Detallado de Keywords</div>
            <div id="analysisBody"></div>
            <div style="margin-top: 25px; text-align: right;">
                <button class="btn btn-primary" onclick="closeAnalysisModal()">‚úÖ Cerrar</button>
            </div>
        </div>
    </div>

</div><!-- Fin mainApp (contenido protegido) -->
</body>
</html>
