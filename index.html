<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Campa√±as HAV 2026 - NUBE</title>
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1f2937;
            --light: #f9fafb;
            --border: #e5e7eb;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            padding: 20px;
            min-height: 100vh;
        }
        .container { 
            max-width: 1800px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 20px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .header .subtitle { font-size: 1.1em; opacity: 0.9; }
        .stats { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; 
            padding: 20px; 
            background: var(--light);
        }
        .stat-card { 
            background: white; 
            padding: 20px; 
            border-radius: 12px; 
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-card .number { font-size: 2.5em; font-weight: bold; color: var(--primary); }
        .stat-card .label { color: var(--dark); margin-top: 5px; font-size: 0.9em; }
        .tabs { 
            display: flex; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            overflow-x: auto;
        }
        .tab-btn { 
            flex: 1;
            padding: 18px; 
            background: transparent; 
            border: none; 
            color: white; 
            cursor: pointer; 
            transition: all 0.3s;
            font-size: 1.05em;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }
        .tab-btn:hover { background: rgba(255,255,255,0.1); }
        .tab-btn.active { background: white; color: var(--primary); border-bottom-color: var(--primary); }
        .tab-content { display: none; padding: 30px; }
        .tab-content.active { display: block; }
        .controls { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); 
            gap: 15px; 
            margin-bottom: 25px;
        }
        .control-group { display: flex; flex-direction: column; }
        .control-group label { 
            font-weight: 600; 
            margin-bottom: 8px; 
            color: var(--dark);
            font-size: 0.95em;
        }
        .control-group input, .control-group select, .control-group textarea { 
            padding: 12px; 
            border: 2px solid var(--border); 
            border-radius: 8px; 
            font-size: 1em;
            transition: all 0.3s;
        }
        .control-group input:focus, .control-group select:focus, .control-group textarea:focus { 
            outline: none; 
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .control-group textarea { resize: vertical; font-family: 'Courier New', monospace; }
        .btn { 
            padding: 12px 25px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 1em; 
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .btn-edit { background: var(--warning); color: white; }
        .btn-del { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-meta { background: #8b5cf6; color: white; }
        .btn-bold { background: var(--dark); color: white; margin-left: 10px; }
        .btn-clear-tags { background: var(--danger); color: white; margin-left: 10px; }
        .table-wrapper { overflow-x: auto; margin-top: 20px; }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        thead { background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; }
        th { 
            padding: 15px 10px; 
            text-align: left; 
            cursor: pointer; 
            user-select: none;
            font-weight: 600;
            position: relative;
        }
        th:hover { background: rgba(255,255,255,0.1); }
        td { padding: 12px 10px; border-bottom: 1px solid var(--border); }
        tbody tr:hover { background: var(--light); }
        .badge { 
            padding: 5px 12px; 
            border-radius: 20px; 
            font-size: 0.85em; 
            font-weight: 600;
            display: inline-block;
        }
        .badge-fb { background: #1877f2; color: white; }
        .badge-tt { background: #fe2c55; color: white; }
        .badge-gn { background: #EA4335; color: white; }
        .comparator-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 20px; }
        .comp-card { 
            background: white; 
            padding: 20px; 
            border-radius: 12px; 
            border: 2px solid var(--border);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .comp-card h3 { 
            color: var(--primary); 
            margin-bottom: 15px; 
            padding-bottom: 10px; 
            border-bottom: 2px solid var(--border);
        }
        .comp-card .metric { 
            display: flex; 
            justify-content: space-between; 
            padding: 8px 0; 
            border-bottom: 1px solid var(--light);
        }
        .comp-card .metric:last-child { border-bottom: none; }
        .comp-card .metric strong { color: var(--dark); }
        .comp-card .keyword-list { 
            max-height: 200px; 
            overflow-y: auto; 
            margin-top: 10px;
            padding: 10px;
            background: var(--light);
            border-radius: 8px;
        }
        .keyword-item { 
            padding: 6px 10px; 
            margin: 5px 0; 
            background: white; 
            border-radius: 6px;
            font-size: 0.9em;
        }
        .config-list { 
            list-style: none; 
            max-height: 400px; 
            overflow-y: auto;
            background: var(--light);
            padding: 15px;
            border-radius: 8px;
        }
        .config-list li { 
            padding: 10px; 
            background: white; 
            margin: 8px 0; 
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .config-input { 
            flex: 1;
            padding: 8px 12px;
            border: 2px solid var(--border);
            border-radius: 6px;
            font-size: 0.95em;
        }
        .config-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        .btn-save-mini {
            background: var(--success);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        .btn-save-mini:hover {
            background: #059669;
            transform: scale(1.05);
        }
        .btn-del-mini { 
            background: var(--danger); 
            color: white; 
            border: none; 
            padding: 8px 12px; 
            border-radius: 6px; 
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        .btn-del-mini:hover {
            background: #dc2626;
            transform: scale(1.05);
        }
        .editable-list { 
            list-style: none; 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); 
            gap: 15px;
            background: var(--light);
            padding: 20px;
            border-radius: 8px;
        }
        .editable-list li { 
            padding: 12px; 
            background: white; 
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .full-width { grid-column: 1 / -1; }

        .launch-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--success);
        }

        .article-indicator {
            font-size: 1.3em;
            cursor: pointer;
            transition: transform 0.3s;
        }
        .article-indicator:hover {
            transform: scale(1.3);
        }
        .has-article { color: var(--success); }
        .no-article { color: var(--border); }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Estilos para el cat√°logo HAV */
        .hav-catalog-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }

        .hav-platform-card {
            border-radius: 12px;
            padding: 18px;
            border-left: 5px solid;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .hav-channels-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 500px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .hav-channel-item {
            background: white;
            padding: 11px 13px;
            border-radius: 7px;
            border: 1px solid #e0e0e0;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .hav-channel-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transform: translateX(3px);
        }

        .hav-channel-info {
            flex: 1;
            min-width: 0;
        }

        .hav-channel-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.88em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .hav-channel-id {
            font-size: 0.75em;
            color: #999;
            margin-top: 2px;
        }

        .hav-channel-actions {
            display: flex;
            gap: 5px;
            flex-shrink: 0;
        }

        .btn-copy {
            background: var(--primary);
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.3s;
        }

        .btn-copy:hover {
            background: var(--secondary);
        }

        .btn-edit-mini {
            background: var(--warning);
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.3s;
        }

        .btn-edit-mini:hover {
            background: #d97706;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: modalSlide 0.3s ease;
        }

        @keyframes modalSlide {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-content h3 {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
        }
    
    .platform-select {
        padding: 6px 10px;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        background: white;
        cursor: pointer;
        font-size: 0.85em;
        font-weight: 600;
        transition: all 0.3s ease;
        width: 110px;
    }
    .platform-select:hover {
        border-color: #667eea;
        background: #f8f9ff;
    }
    .platform-select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    /* Columna ID: m√°s grande y en negrita */
    td:nth-child(4) {
        font-size: 15px !important;
        font-weight: bold !important;
        font-family: 'Courier New', monospace;
        color: #2c3e50;
    }

    /* Columna Nombre de Campa√±a: m√°s grande y en negrita */
    td:nth-child(5) {
        font-size: 14px !important;
        font-weight: bold !important;
        color: #34495e;
    }

    /* Headers ID y Nombre de Campa√±a tambi√©n en negrita */
    th:nth-child(4), th:nth-child(5) {
        font-weight: bold !important;
        font-size: 13px !important;
    }

    </style>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Gestor de Campa√±as HAV 2026</h1>
            <p class="subtitle">‚òÅÔ∏è Sistema Sincronizado en la Nube</p>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="number" id="totalCampaigns">0</div>
                <div class="label">üìä Total Campa√±as</div>
            </div>
            <div class="stat-card">
                <div class="number" id="totalKeywords">0</div>
                <div class="label">üîë Keywords Totales</div>
            </div>
            <div class="stat-card">
                <div class="number" id="avgKeys">0</div>
                <div class="label">üìà Promedio Keys</div>
            </div>
            <div class="stat-card">
                <div class="number" id="totalArticles">0</div>
                <div class="label">üìù Con Art√≠culo</div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('tab-list')">üìã Lista de Campa√±as</button>
            <button class="tab-btn" onclick="switchTab('tab-comp')">üî¨ Comparador</button>
            <button class="tab-btn" onclick="switchTab('tab-add')">‚ûï Gestionar Campa√±a</button>
            <button class="tab-btn" onclick="switchTab('tab-config')">‚öôÔ∏è Configuraci√≥n Global</button>
            <button class="tab-btn" onclick="switchTab('tab-catalog')">üì° Cat√°logo HAV</button>
        </div>

        <div id="tab-list" class="tab-content active">
            <div class="controls">
                <div class="control-group"><label>üîç Buscar</label><input type="text" id="search" placeholder="Buscar..." onkeyup="renderTable()"></div>
                <div class="control-group"><label>üì∫ Canal</label><select id="filterChannel" onchange="renderTable()"></select></div>
                <div class="control-group"><label>üÜî ID Campa√±a</label><select id="filterId" onchange="renderTable()"></select></div>
                <div class="control-group"><label>üì¶ Nicho</label><select id="filterProduct" onchange="renderTable()"></select></div>
                <div class="control-group"><label>üì° Plataforma</label><select id="filterPlatform" onchange="renderTable()"></select></div>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th onclick="applySort('platform')">Plat.</th>
                            <th onclick="applySort('channel')">Canal</th>
                            <th onclick="applySort('product')">Nicho</th>
                            <th onclick="applySort('id')">ID</th>
                            <th onclick="applySort('code')">Nombre de Campa√±a</th>
                            <th onclick="applySort('language')">Idioma</th>
                            <th onclick="applySort('country')">Pa√≠s</th>
                            <th onclick="applySort('keys')">Keys</th>
                            <th>Art√≠culo</th>
                            <th>üë§</th>
                            
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="campaignList"></tbody>
                </table>
            </div>
        </div>

        <div id="tab-comp" class="tab-content">
            <h2>Analizar 3 Campa√±as Simult√°neamente</h2>
            <div class="controls" style="margin-top: 15px;">
                <div class="control-group"><label>Campa√±a 1</label><select id="comp1" onchange="runTripleComparison()"></select></div>
                <div class="control-group"><label>Campa√±a 2</label><select id="comp2" onchange="runTripleComparison()"></select></div>
                <div class="control-group"><label>Campa√±a 3</label><select id="comp3" onchange="runTripleComparison()"></select></div>
            </div>
            <div id="compResults" class="comparator-grid"></div>
        </div>

        <div id="tab-add" class="tab-content">
            <h2 id="formTitle">Gestionar Campa√±a</h2>
            <div class="controls" style="grid-template-columns: repeat(4, 1fr); margin-top: 15px;">
                <div class="control-group"><label>Plataforma</label><select id="inPlatform"></select></div>
                <div class="control-group"><label>Canal</label><select id="inChannel"></select></div>
<datalist id="adManagerList">
                    <option value="HAV">
                    <option value="Otro">
                </datalist>
                <div class="control-group"><label>Idioma</label><input type="text" id="inLanguage" placeholder="Ej: es, en"></div>
                <div class="control-group"><label>Nicho/Producto</label><select id="inProduct"></select></div>
            </div>
            <div class="controls" style="grid-template-columns: repeat(3, 1fr); margin-top: 15px;">
                <div class="control-group"><label>ID Campa√±a</label><select id="inId"></select></div>
                <div class="control-group"><label>Nombre de Campa√±a</label><input type="text" id="inCode"></div>
                <div class="control-group"><label>Pa√≠s (ISO)</label><input type="text" id="inCountry"></div>
            </div>
            <div class="control-group" style="margin-top: 15px;">
                <div style="display: flex; align-items: center; margin-bottom: 5px;">
                    <label>Keywords (una por l√≠nea)</label>
                    <button class="btn btn-bold" onclick="boldSelectedText()"><b>B</b> Negrita</button>
                    <button class="btn btn-clear-tags" onclick="clearAllBoldTags()">üóëÔ∏è Limpiar Negritas</button>
                </div>
                <textarea id="inKeywords" rows="12"></textarea>
            </div>
            <div class="control-group" style="margin-top: 15px;">
                <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 5px;">
                    <label>üìù Art√≠culo (Markdown)</label>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label style="margin: 0; font-size: 0.9em;">‚úçÔ∏è Autor:</label>
                        <select id="inAutor" style="padding: 5px 10px; font-size: 0.9em;">
                            <option value="">-</option>
                            <option value="I">I</option>
                            <option value="H">H</option>
                        </select>
                    </div>
                </div>
                <textarea id="inArticle" rows="15" placeholder="Pega aqu√≠ tu art√≠culo en formato Markdown..."></textarea>
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-edit" onclick="saveCampaign()">üíæ Guardar en Nube</button>
                <button class="btn btn-meta" onclick="saveMetadataOnly()" id="btnMetaOnly" style="display:none;">üìù Actualizar solo Datos</button>
                <button class="btn btn-del" onclick="resetForm()">üîÑ Limpiar Formulario</button>
            </div>
        </div>

        <div id="tab-config" class="tab-content">
            <h2>Configuraci√≥n Global (Sincronizada)</h2>
            <p style="margin-bottom: 15px; color: #555;">Los cambios aqu√≠ se guardan en la nube y aparecen para todos los usuarios.</p>

            <div class="controls">
                <div class="control-group"><label>‚ûï Nuevo ID</label><input type="text" id="newIdVal" placeholder=""><button class="btn btn-edit" onclick="addOption('ids', 'newIdVal')">Crear</button></div>
                <div class="control-group"><label>‚ûï Nuevo Nicho</label><input type="text" id="newProdName" placeholder="Ej: Escritorio"><button class="btn btn-edit" onclick="addOption('products', 'newProdName')">Crear</button></div>
                <div class="control-group"><label>‚ûï Nueva Plataforma</label><select id="newPlatName"><option value="Facebook">Facebook</option><option value="TikTok">TikTok</option><option value="Google">Google</option></select><button class="btn btn-edit" onclick="addOption('platforms', 'newPlatName')">Crear</button></div>
                <div class="control-group"><label>‚ûï Nuevo Canal</label><input type="text" id="newChanName"><button class="btn btn-edit" onclick="addOption('channels', 'newChanName')">Crear</button></div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-top: 25px;">
                <div><h4 style="color:var(--primary)">üÜî IDs de Campa√±a</h4><ul id="listIds" class="config-list"></ul></div>
                <div><h4 style="color:var(--secondary)">üì¶ Nichos</h4><ul id="listProds" class="config-list"></ul></div>
                <div><h4 style="color:var(--dark)">üì° Plataformas</h4><ul id="listPlatforms" class="config-list"></ul></div>
                <div><h4 style="color:var(--dark)">üì∫ Canales</h4><ul id="listChannels" class="config-list"></ul></div>
            </div>
        </div>

        <div id="tab-catalog" class="tab-content">
            <h2 style="color: #667eea; margin-bottom: 20px;">üì° Cat√°logo HAV - Canales en la Nube</h2>
            <p style="color: #666; margin-bottom: 25px; font-size: 1.05em;">üí° <strong>Edita</strong> los canales directamente y se guardar√°n para todos los usuarios.</p>

            <div style="margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="addNewHAVChannel()">‚ûï Agregar Nuevo Canal</button>
            </div>

            <div id="havCatalogContainer" class="hav-catalog-grid"></div>
        </div>
    </div>

    <div id="editChannelModal" class="modal">
        <div class="modal-content">
            <h3>‚úèÔ∏è Editar Canal HAV</h3>
            <div class="control-group">
                <label>Plataforma</label>
                <select id="modalPlatform">
                    <option value="FB">Facebook (FB)</option>
                    <option value="TT">TikTok (TT)</option>
                    <option value="GN">Google (GN)</option>
                </select>
            </div>
            <div class="control-group" style="margin-top: 15px;">
                <label>Nombre del Canal (sin prefijo)</label>
                <input type="text" id="modalChannelName" placeholder="Ej: Sofa, Celulares, AutosElectricos">
            </div>
            <div class="control-group" style="margin-top: 15px;">
                <label>ID del Canal</label>
                <input type="text" id="modalChannelId" placeholder="Ej: 00904, 3.408906124e+09">
            </div>
            <div class="control-group" style="margin-top: 15px;">
                <label>Categor√≠a/Grupo</label>
                <input type="text" id="modalChannelGroup" placeholder="Ej: MUNDO Meta, Mundo TikTok, InsideHub TikTok">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-del" onclick="closeChannelModal()">‚ùå Cancelar</button>
                <button class="btn btn-success" onclick="saveChannelEdit()">üíæ Guardar</button>
            </div>
        </div>
    </div>

<script>
// ============================================================================
// 1. CONFIGURACI√ìN FIREBASE (Tus credenciales)
// ============================================================================
const firebaseConfig = {
  apiKey: "AIzaSyB6lGHmig5XC4RPwAFnWaBFkpXIqdO_WoM",
  authDomain: "gestor-campanas-hav2026.firebaseapp.com",
  projectId: "gestor-campanas-hav2026",
  storageBucket: "gestor-campanas-hav2026.firebasestorage.app",
  messagingSenderId: "1715326503",
  appId: "1:1715326503:web:2b7ecda6f5257c9da78802"
};

// Inicializar Firebase solo si no est√° activo
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
const dbFirebase = firebase.firestore();

// Referencias a tus "carpetas" en la nube
const campaignsRef = dbFirebase.collection('campaigns');
const settingsRef = dbFirebase.collection('settings').doc('globalConfig'); // Aqu√≠ guardaremos los Nichos, IDs y Cat√°logo

console.log('üî• Firebase conectado y listo');

// ============================================================================
// 2. VARIABLES GLOBALES
// ============================================================================
let db = {
    campaigns: [],
    // Datos por defecto por si la nube est√° vac√≠a al principio
    platforms: ['FB', 'TT', 'GN'],
    channels: ['Mundo', 'IH', 'CS', 'HN'],
    products: [],
    ids: ['00902', '00903', '00904', '00905', '00908', '00909'],
    havCatalog: {} 
};

let editingIndex = -1;
let currentSort = { column: 'country', order: 'asc' };
let currentEditingChannel = null;

// ============================================================================
// 3. SINCRONIZACI√ìN REAL (El cerebro del sistema)
// ============================================================================

function startRealtimeSync() {
    console.log('üì° Sincronizando datos...');

    // A) Escuchar CAMPA√ëAS en tiempo real
    campaignsRef.onSnapshot(snapshot => {
        const loaded = [];
        snapshot.forEach(doc => {
            loaded.push({ firebaseId: doc.id, ...doc.data() });
        });
        db.campaigns = loaded;
        renderTable();
        updateStats();
        console.log(`üîÑ ${loaded.length} campa√±as cargadas`);
    });

    // B) Escuchar CONFIGURACI√ìN (Nichos, IDs, Cat√°logo) en tiempo real
    settingsRef.onSnapshot(doc => {
        if (doc.exists) {
            const data = doc.data();
            if(data.products) db.products = data.products;
            if(data.ids) db.ids = data.ids;
            if(data.platforms) db.platforms = data.platforms;
            if(data.channels) db.channels = data.channels;
            if(data.havCatalog) db.havCatalog = data.havCatalog;
            console.log('‚öôÔ∏è Configuraci√≥n sincronizada');
            refreshEverything(); // Actualizar desplegables y cat√°logo visual
        } else {
            // Si es la primera vez y no existe la config en la nube, la creamos
            console.log('‚ö†Ô∏è Configuraci√≥n vac√≠a, subiendo inicial...');
            saveGlobalSettings(); 
        }
    });
}

// Guardar CAMPA√ëA en la nube
async function saveToFirebase(campaign) {
  try {
    if (campaign.firebaseId) {
      const { firebaseId, ...data } = campaign;
      await campaignsRef.doc(firebaseId).update(data);
    } else {
      await campaignsRef.add(campaign);
    }
    showNotification('‚òÅÔ∏è Guardado en la nube exitoso');
  } catch (error) {
    console.error('Error:', error);
    alert('Error al guardar: ' + error.message);
  }
}

// Borrar CAMPA√ëA de la nube
async function deleteFromFirebase(firebaseId) {
  try {
    await campaignsRef.doc(firebaseId).delete();
    showNotification('üóëÔ∏è Campa√±a eliminada');
  } catch (error) {
    console.error('Error:', error);
  }
}

// Guardar CONFIGURACI√ìN GLOBAL en la nube (Nichos, IDs, Cat√°logo)
async function saveGlobalSettings() {
    try {
        await settingsRef.set({
            products: db.products || [],
            ids: db.ids || [],
            platforms: db.platforms || [],
            channels: db.channels || [],
            havCatalog: db.havCatalog || {},
            lastUpdate: new Date().toISOString()
        }, { merge: true });
        console.log('‚òÅÔ∏è Configuraci√≥n global guardada');
    } catch (error) {
        console.error('Error guardando settings:', error);
    }
}

// Reemplazamos saveToStorage para que SIEMPRE vaya a la nube
function saveToStorage() {
    saveGlobalSettings();
}

// ============================================================================
// 4. L√ìGICA DE LA INTERFAZ
// ============================================================================

const nichoEmojis = {
    'cadena': '‚õìÔ∏è', 'oro': 'üí∞', 'joya': 'üíé', 'iphone': 'üì±', 'celular': 'üì±', 
    'tv': 'üì∫', 'sof√°': 'üõãÔ∏è', 'mueble': 'ü™ë', 'bici': 'üö≤', 'pc': 'üíª', 
    'colch√≥n': 'üõèÔ∏è', 'auto': 'üöó', 'curso': 'üìö', 'jard√≠n': 'üåø', 'cocina': 'üç≥'
};

function getNichoConEmoji(nicho) {
    if (!nicho) return '';
    const n = nicho.toLowerCase();
    for (let key in nichoEmojis) {
        if (n.includes(key)) return nichoEmojis[key] + ' ' + nicho;
    }
    return nicho;
}

function updateCampPlatform(index, newPlatform) {
    const c = db.campaigns[index];
    if (c) {
        c.platform = newPlatform;
        saveToFirebase(c);
    }
}

function switchTab(id) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelector(`[onclick="switchTab('${id}')"]`).classList.add('active');
    if(id === 'tab-comp') updateCompSelects();
    if(id === 'tab-catalog') renderHAVCatalog();
}

function updateStats() {
    document.getElementById('totalCampaigns').textContent = db.campaigns.length;
    const totalKeys = db.campaigns.reduce((sum, c) => sum + (c.keywords?.length || 0), 0);
    document.getElementById('totalKeywords').textContent = totalKeys;
    document.getElementById('avgKeys').textContent = db.campaigns.length ? Math.round(totalKeys / db.campaigns.length) : 0;
    document.getElementById('totalArticles').textContent = db.campaigns.filter(c => c.article && c.article.trim()).length;
}

function refreshEverything() { 
    updateOptions(); 
    renderTable(); 
    updateStats(); 
    renderHAVCatalog();
}

// ===== OPCIONES Y DESPLEGABLES =====

function updateOptions() {
    const selects = { 
        'inPlatform': db.platforms, 'filterPlatform': db.platforms, 
        'inChannel': db.channels, 'filterChannel': db.channels, 
        'inProduct': db.products, 'filterProduct': db.products,
        'inId': db.ids, 'filterId': db.ids
    };

    for (const [id, data] of Object.entries(selects)) {
        const el = document.getElementById(id);
        if (!el) continue;
        const isFilter = id.startsWith('filter');
        let html = isFilter ? `<option value="">Todos</option>` : '';
        
        if (id.includes('Platform')) {
            const names = { 'FB': 'Facebook', 'TT': 'TikTok', 'GN': 'Google' };
            html += data.map(opt => `<option value="${opt}">${names[opt] || opt}</option>`).join('');
        } else {
            html += data.map(opt => `<option value="${opt}">${opt}</option>`).join('');
        }
        el.innerHTML = html;
    }

    // Listas editables en Configuraci√≥n
    ['ids', 'products', 'platforms', 'channels'].forEach(type => {
        let listId = '';
        if(type === 'ids') listId = 'listIds';
        else if(type === 'products') listId = 'listProds';
        else if(type === 'platforms') listId = 'listPlatforms';
        else if(type === 'channels') listId = 'listChannels';

        const container = document.getElementById(listId);
        if (container && db[type]) {
            container.innerHTML = db[type].map((val, i) => `
                <li>
                    <input type="text" class="config-input" value="${val}" id="input_${type}_${i}">
                    <button class="btn btn-save-mini" onclick="updateGlobalItem('${type}', ${i})">üíæ</button>
                    <button class="btn-del-mini" onclick="delOption('${type}', ${i})">üóëÔ∏è</button>
                </li>`).join('');
        }
    });
}

function addOption(type, inputId) {
    const val = document.getElementById(inputId).value.trim();
    if (!val || db[type].includes(val)) return alert('Valor inv√°lido o repetido');
    db[type].push(val);
    db[type].sort();
    saveGlobalSettings();
    document.getElementById(inputId).value = '';
    showNotification('‚úÖ Agregado');
}

function delOption(type, index) {
    if (confirm('¬øEliminar opci√≥n?')) {
        db[type].splice(index, 1);
        saveGlobalSettings();
    }
}

function updateGlobalItem(type, index) {
    const newVal = document.getElementById(`input_${type}_${index}`).value.trim();
    if (newVal) {
        db[type][index] = newVal;
        saveGlobalSettings();
        showNotification('‚úÖ Actualizado');
    }
}

// ===== TABLA PRINCIPAL =====

function renderTable() {
    const q = document.getElementById('search').value.toLowerCase();
    const pF = document.getElementById('filterPlatform').value;
    const prF = document.getElementById('filterProduct').value;
    const idF = document.getElementById('filterId').value;
    const chF = document.getElementById('filterChannel')?.value || '';

    let filtered = db.campaigns.filter(c => 
        (c.code.toLowerCase().includes(q) || c.id.includes(q) || (c.country||'').toLowerCase().includes(q)) && 
        (!pF || c.platform === pF) && 
        (!prF || c.product === prF) && 
        (!idF || c.id === idF) &&
        (!chF || chF === 'Todos' || c.channel === chF)
    );

    filtered.sort((a, b) => {
        let vA = a[currentSort.column], vB = b[currentSort.column];
        if (currentSort.column === 'keys') { vA = a.keywords?.length || 0; vB = b.keywords?.length || 0; }
        return currentSort.order === 'asc' ? (vA > vB ? 1 : -1) : (vA < vB ? 1 : -1);
    });

    const tbody = document.getElementById('campaignList');
    tbody.innerHTML = filtered.map(c => {
        const realIndex = db.campaigns.indexOf(c);
        const hasArticle = c.article && c.article.trim();
        return `<tr>
            <td>
                <select class="platform-select" onchange="updateCampPlatform(${realIndex}, this.value)">
                    <option value="FB" ${c.platform === 'FB' ? 'selected' : ''}>FB</option>
                    <option value="TT" ${c.platform === 'TT' ? 'selected' : ''}>TT</option>
                    <option value="GN" ${c.platform === 'GN' ? 'selected' : ''}>GN</option>
                </select>
            </td>
            <td>${c.channel || '-'}</td>
            <td><strong>${getNichoConEmoji(c.product)}</strong></td>
            <td><code>${c.id}</code></td>
            <td>${c.code}</td>
            <td>${c.language || '-'}</td>
            <td>${c.country}</td>
            <td><strong>${c.keywords?.length || 0}</strong></td>
            <td style="text-align: center;">${hasArticle ? '‚úÖ' : '‚ùå'}</td>
            <td style="text-align: center; font-weight: bold; color: var(--primary);">${c.autor || '-'}</td>
            <td>
                <button class="btn btn-edit" style="padding:6px" onclick="editCampaign(${realIndex})">‚úèÔ∏è</button>
                <button class="btn btn-del" style="padding:6px" onclick="deleteCampaign(${realIndex})">üóëÔ∏è</button>
            </td>
        </tr>`;
    }).join('');
}

function applySort(col) {
    currentSort.order = (currentSort.column === col && currentSort.order === 'asc') ? 'desc' : 'asc';
    currentSort.column = col;
    renderTable();
}

// ===== EDICI√ìN Y GUARDADO =====

function editCampaign(index) {
    editingIndex = index;
    const c = db.campaigns[index];
    document.getElementById('inPlatform').value = c.platform;
    document.getElementById('inChannel').value = c.channel || '';
    document.getElementById('inProduct').value = c.product;
    document.getElementById('inId').value = c.id;
    document.getElementById('inCode').value = c.code;
    document.getElementById('inLanguage').value = c.language || '';
    document.getElementById('inCountry').value = c.country;
    document.getElementById('inKeywords').value = c.keywords ? c.keywords.join('\n') : '';
    document.getElementById('inArticle').value = c.article || '';
    document.getElementById('inAutor').value = c.autor || '';
    
    document.getElementById('formTitle').textContent = '‚úèÔ∏è Editando: ' + c.code;
    document.getElementById('btnMetaOnly').style.display = 'inline-block';
    switchTab('tab-add');
}

function saveCampaign() {
    const platform = document.getElementById('inPlatform').value;
    const product = document.getElementById('inProduct').value;
    const id = document.getElementById('inId').value;
    const code = document.getElementById('inCode').value;
    
    if (!platform || !product || !id || !code) return alert('‚ö†Ô∏è Faltan datos obligatorios');

    const campaign = {
        platform, 
        channel: document.getElementById('inChannel').value,
        product, id, code,
        country: document.getElementById('inCountry').value.toUpperCase(),
        language: document.getElementById('inLanguage').value,
        keywords: document.getElementById('inKeywords').value.split('\n').map(k=>k.trim()).filter(k=>k),
        article: document.getElementById('inArticle').value,
        autor: document.getElementById('inAutor').value,
        updatedAt: new Date().toISOString()
    };

    if (editingIndex >= 0) {
        campaign.firebaseId = db.campaigns[editingIndex].firebaseId;
        saveToFirebase(campaign);
    } else {
        saveToFirebase(campaign);
    }
    resetForm();
    switchTab('tab-list');
}

function saveMetadataOnly() {
    if (editingIndex < 0) return;
    const c = db.campaigns[editingIndex];
    // Copiamos todo lo nuevo excepto article y keywords
    c.platform = document.getElementById('inPlatform').value;
    c.channel = document.getElementById('inChannel').value;
    c.product = document.getElementById('inProduct').value;
    c.id = document.getElementById('inId').value;
    c.code = document.getElementById('inCode').value;
    c.country = document.getElementById('inCountry').value.toUpperCase();
    c.autor = document.getElementById('inAutor').value;
    
    saveToFirebase(c);
    resetForm();
    switchTab('tab-list');
}

function deleteCampaign(index) {
    if (confirm('¬øEliminar permanentemente de la nube?')) {
        const c = db.campaigns[index];
        if(c.firebaseId) deleteFromFirebase(c.firebaseId);
    }
}

function resetForm() {
    editingIndex = -1;
    document.querySelectorAll('#tab-add input, #tab-add select, #tab-add textarea').forEach(el => el.value = '');
    document.getElementById('formTitle').textContent = '‚ûï Nueva Campa√±a';
    document.getElementById('btnMetaOnly').style.display = 'none';
}

// ===== HERRAMIENTAS TEXTO =====
function boldSelectedText() {
    const ta = document.getElementById('inKeywords');
    const start = ta.selectionStart, end = ta.selectionEnd;
    ta.value = ta.value.substring(0, start) + '<b>' + ta.value.substring(start, end) + '</b>' + ta.value.substring(end);
}
function clearAllBoldTags() {
    document.getElementById('inKeywords').value = document.getElementById('inKeywords').value.replace(/<\/?b>/g, '');
}

// ===== COMPARADOR =====
function updateCompSelects() {
    ['comp1', 'comp2', 'comp3'].forEach(id => {
        const el = document.getElementById(id);
        el.innerHTML = '<option value="">Seleccionar...</option>' + 
            db.campaigns.map((c, i) => `<option value="${i}">${c.code} (${c.country})</option>`).join('');
    });
}

function runTripleComparison() {
    const i1 = document.getElementById('comp1').value;
    const i2 = document.getElementById('comp2').value;
    const i3 = document.getElementById('comp3').value;
    if (!i1 || !i2 || !i3) return;
    const campaigns = [db.campaigns[i1], db.campaigns[i2], db.campaigns[i3]];
    document.getElementById('compResults').innerHTML = campaigns.map(c => `
        <div class="comp-card">
            <h3>${c.code}</h3>
            <div class="metric"><strong>Pa√≠s:</strong><span>${c.country}</span></div>
            <div class="metric"><strong>ID:</strong><span>${c.id}</span></div>
            <div class="keyword-list">${c.keywords.map(k=>`<div class="keyword-item">${k}</div>`).join('')}</div>
        </div>`).join('');
}

// ===== CAT√ÅLOGO HAV (Sincronizado) =====
function renderHAVCatalog() {
    const container = document.getElementById('havCatalogContainer');
    if (!container || !db.havCatalog) return;
    
    let html = '';
    const platforms = { 
        'FB': { color: '#1877f2', bg: '#e7f3ff', n: 'üåé Meta' }, 
        'TT': { color: '#fe2c55', bg: '#fff0f3', n: 'üéµ TikTok' }, 
        'GN': { color: '#EA4335', bg: '#fff5f0', n: 'üîç Google' } 
    };

    for (const [groupName, channels] of Object.entries(db.havCatalog)) {
        if(!channels.length) continue;
        const plat = channels[0].platform || 'FB';
        const style = platforms[plat] || platforms['FB'];
        
        html += `<div class="hav-platform-card" style="border-left-color: ${style.color}; background: ${style.bg}">
            <h3 style="color:${style.color}">${groupName}</h3>
            <div class="hav-channels-list">
                ${channels.map((ch, idx) => `
                <div class="hav-channel-item">
                    <div class="hav-channel-info">
                        <div class="hav-channel-name">${ch.code}</div>
                        <div class="hav-channel-id">${ch.id}</div>
                    </div>
                    <div class="hav-channel-actions">
                        <button class="btn-copy" onclick="navigator.clipboard.writeText('${ch.code} | ${ch.id}')">üìã</button>
                        <button class="btn-edit-mini" onclick="editHAVChannel('${groupName}', ${idx})">‚úèÔ∏è</button>
                        <button class="btn-del-mini" onclick="deleteHAVChannel('${groupName}', ${idx})">üóëÔ∏è</button>
                    </div>
                </div>`).join('')}
            </div>
        </div>`;
    }
    container.innerHTML = html;
}

function saveHAVCatalog() { saveGlobalSettings(); showNotification('üíæ Cat√°logo guardado en nube'); }
function refreshHAVCatalog() { refreshEverything(); }

function addNewHAVChannel() {
    currentEditingChannel = null;
    document.getElementById('modalPlatform').value = 'FB';
    document.getElementById('modalChannelName').value = '';
    document.getElementById('modalChannelId').value = '';
    document.getElementById('modalChannelGroup').value = 'MUNDO Meta';
    document.getElementById('editChannelModal').classList.add('active');
}

function saveChannelEdit() {
    const plat = document.getElementById('modalPlatform').value;
    const name = document.getElementById('modalChannelName').value;
    const id = document.getElementById('modalChannelId').value;
    const group = document.getElementById('modalChannelGroup').value;
    
    if(!name || !id || !group) return alert('Completa todo');
    
    const code = `${plat}-HAV-${name}`;
    if (currentEditingChannel) {
        const oldGroup = currentEditingChannel.group;
        db.havCatalog[oldGroup].splice(currentEditingChannel.index, 1);
        if(!db.havCatalog[oldGroup].length) delete db.havCatalog[oldGroup];
    }
    
    if (!db.havCatalog[group]) db.havCatalog[group] = [];
    db.havCatalog[group].push({ code, id, platform: plat });
    
    saveGlobalSettings();
    closeChannelModal();
}

function editHAVChannel(group, index) {
    currentEditingChannel = { group, index };
    const ch = db.havCatalog[group][index];
    document.getElementById('modalPlatform').value = ch.platform;
    document.getElementById('modalChannelName').value = ch.code.split('-HAV-')[1] || '';
    document.getElementById('modalChannelId').value = ch.id;
    document.getElementById('modalChannelGroup').value = group;
    document.getElementById('editChannelModal').classList.add('active');
}

function deleteHAVChannel(group, index) {
    if(confirm('¬øEliminar canal?')) {
        db.havCatalog[group].splice(index, 1);
        if(!db.havCatalog[group].length) delete db.havCatalog[group];
        saveGlobalSettings();
    }
}
function closeChannelModal() { document.getElementById('editChannelModal').classList.remove('active'); }

function showNotification(msg) {
    const n = document.createElement('div');
    n.textContent = msg;
    n.style.cssText = 'position:fixed;bottom:20px;right:20px;background:#10b981;color:white;padding:15px;border-radius:8px;z-index:9999;box-shadow:0 4px 12px rgba(0,0,0,0.2)';
    document.body.appendChild(n);
    setTimeout(()=>n.remove(), 2500);
}

// INICIALIZACI√ìN
window.onload = function() {
    startRealtimeSync();
    
    // Vinculaci√≥n ID autom√°tico
    const prodSel = document.getElementById('inProduct');
    const idSel = document.getElementById('inId');
    if (prodSel && idSel) {
        prodSel.addEventListener('change', function() {
            // L√≥gica opcional para sugerir ID
        });
    }
    
    // Cerrar modal al clickear fuera
    document.getElementById('editChannelModal').addEventListener('click', function(e) {
        if (e.target === this) closeChannelModal();
    });
};
</script>
</body>
</html>
