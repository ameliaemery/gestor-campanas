<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor HAV 2026</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        /* ==========================================================================
           ESTILOS ORIGINALES (RESPETADOS)
           ========================================================================== */
        :root { --primary: #667eea; --secondary: #764ba2; --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --dark: #1f2937; --light: #f9fafb; --border: #e5e7eb; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; min-height: 100vh; }
        .container { max-width: 1800px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; padding: 30px; text-align: center; position: relative; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .header .subtitle { font-size: 1.1em; opacity: 0.9; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; padding: 20px; background: var(--light); }
        .stat-card { background: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.3s; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-card .number { font-size: 2.5em; font-weight: bold; color: var(--primary); }
        .stat-card .label { color: var(--dark); margin-top: 5px; font-size: 0.9em; }
        .tabs { display: flex; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); overflow-x: auto; }
        .tab-btn { flex: 1; padding: 18px; background: transparent; border: none; color: white; cursor: pointer; font-size: 1.05em; font-weight: 600; border-bottom: 3px solid transparent; white-space: nowrap; }
        .tab-btn:hover { background: rgba(255,255,255,0.1); }
        .tab-btn.active { background: white; color: var(--primary); border-bottom-color: var(--primary); }
        .tab-content { display: none; padding: 30px; }
        .tab-content.active { display: block; }
        .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .control-group { display: flex; flex-direction: column; }
        .control-group label { font-weight: 600; margin-bottom: 8px; color: var(--dark); font-size: 0.95em; }
        .control-group input, .control-group select, .control-group textarea { padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 1em; transition: all 0.3s; }
        .control-group input:focus, .control-group select:focus, .control-group textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .control-group textarea { resize: vertical; font-family: 'Courier New', monospace; }
        .btn { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 600; transition: all 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .btn-edit { background: var(--warning); color: white; }
        .btn-del { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-meta { background: #8b5cf6; color: white; }
        .btn-bold { background: var(--dark); color: white; margin-left: 10px; }
        .btn-clear-tags { background: var(--danger); color: white; margin-left: 10px; }
        .table-wrapper { overflow-x: auto; margin-top: 20px; }
        
        table { width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; }
        thead { background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; }
        th { padding: 15px 10px; text-align: left; cursor: pointer; user-select: none; font-weight: 600; position: relative; white-space: nowrap; }
        th:hover { background: rgba(255,255,255,0.1); }
        td { padding: 12px 10px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        tbody tr:hover { background: var(--light); }
        
        /* ESTILOS DE TEXTO TABLA */
        td:nth-child(4) { /* Nicho */ font-weight: bold; font-size: 1.05em; color: #2c3e50; }
        td:nth-child(5) { /* ID */ font-family: 'Courier New', monospace; font-weight: bold; font-size: 1.1em; color: #34495e; }
        td:nth-child(9) { /* Keys */ font-weight: bold; color: #333; }
        
        /* SELECTOR PLATAFORMA */
        .platform-select { 
            padding: 6px; border: 1px solid #e0e0e0; border-radius: 6px; 
            background: white; cursor: pointer; font-size: 0.85em; font-weight: 600; 
            width: 110px; 
        }

        /* CAT√ÅLOGO HAV */
        .hav-catalog-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); gap: 30px; margin-top: 30px; align-items: start; }
        .hav-platform-card { border-radius: 12px; padding: 20px; border-left: 6px solid; box-shadow: 0 4px 15px rgba(0,0,0,0.08); background: white; height: 100%; display: flex; flex-direction: column; }
        .hav-platform-card h3 { margin-bottom: 15px; font-size: 1.25em; font-weight: 700; padding-bottom: 10px; border-bottom: 2px solid #f0f0f0; }
        .hav-channels-list { display: flex; flex-direction: column; gap: 12px; max-height: 500px; overflow-y: auto; padding-right: 8px; }
        .hav-channel-item { background: #f8faff; padding: 12px 15px; border-radius: 8px; border: 1px solid #e1e4e8; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.03); transition: transform 0.2s; }
        .hav-channel-item:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.08); }
        .hav-channel-name { font-weight: 600; font-size: 0.85em; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .hav-channel-id { font-size: 0.75em; color: #888; }
        
        /* BOTONES CAT√ÅLOGO */
        .hav-btn-group { display: flex; gap: 3px; }
        .btn-mini { padding: 4px 6px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.75em; transition: 0.2s; }
        .btn-copy-mini { background: var(--primary); color: white; }
        .btn-edit-mini { background: var(--warning); color: white; }
        .btn-del-mini { background: var(--danger); color: white; }

        .badge { padding: 5px 12px; border-radius: 20px; font-size: 0.85em; font-weight: 600; display: inline-block; }
        .badge-fb { background: #1877f2; color: white; }
        .badge-tt { background: #fe2c55; color: white; }
        .badge-gn { background: #EA4335; color: white; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3); animation: modalSlide 0.3s ease; }
        @keyframes modalSlide { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; }
        .config-list { list-style: none; max-height: 400px; overflow-y: auto; background: var(--light); padding: 15px; border-radius: 8px; }
        .config-list li { padding: 10px; background: white; margin: 8px 0; border-radius: 6px; display: flex; align-items: center; gap: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .config-input { flex: 1; padding: 8px 12px; border: 2px solid var(--border); border-radius: 6px; font-size: 0.95em; }
        .btn-save-mini { background: var(--success); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; }
        .btn-del-mini { background: var(--danger); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; }
        
        /* === ICONOS LINK === */
        /* Usamos text-shadow y color transparente para FORZAR el color en emojis, funciona en links */
        .url-active { 
            color: transparent !important; 
            text-shadow: 0 0 0 #00E676 !important; /* VERDE BRILLANTE */
            font-weight: bold; 
            font-size: 1.3em; 
            cursor: pointer; 
            text-decoration: none; 
        }
        .url-inactive { 
            color: transparent !important;
            text-shadow: 0 0 0 #d1d5db !important; /* GRIS */
            font-size: 1.3em; 
            cursor: default; 
        }
        
        .article-indicator { font-size: 1.3em; cursor: pointer; transition: transform 0.3s; }
        .article-indicator:hover { transform: scale(1.3); }
        .has-article { color: var(--success); }
        .no-article { color: var(--border); }
        
        /* Notificaciones */
        #notification-area { position: fixed; bottom: 20px; right: 20px; z-index: 10000; }
        .notif-box { background: #333; color: white; padding: 15px; border-radius: 8px; margin-top: 10px; animation: slideIn 0.5s; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .btn-copy { background: var(--primary); color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.8em; font-weight: 600; }
    
        /* Estilo para IDs m√°s grandes y visibles */
        td code {
            font-size: 1.1rem;
            font-weight: 700;
            background: #f0f9ff;
            padding: 4px 10px;
            border-radius: 6px;
            border: 2px solid #3b82f6;
            color: #1e40af;
            display: inline-block;
        }
    
        /* ========== SISTEMA DE LOGIN SEGURO ========== */
        #loginScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 99999;
        }

        #loginScreen.hidden {
            display: none;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 400px;
            text-align: center;
            animation: loginSlide 0.5s ease;
        }

        @keyframes loginSlide {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-box h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .login-box p {
            color: #666;
            margin-bottom: 30px;
            font-size: 0.95em;
        }

        .login-input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .login-input-group label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        .login-input-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
            box-sizing: border-box;
        }

        .login-input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .login-error {
            background: #fee2e2;
            color: #dc2626;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
            font-size: 0.9em;
            font-weight: 500;
        }

        .login-error.show {
            display: block;
            animation: shake 0.4s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .logout-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ef4444;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }

        #mainApp {
            display: none;
        }

        #mainApp.show {
            display: block;
        }

        /* Modal de An√°lisis */
        .analysis-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }
        .analysis-modal.active { display: flex; }
        .analysis-content {
            background: white;
            padding: 35px;
            border-radius: 16px;
            max-width: 700px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
        }
        .analysis-header {
            font-size: 1.5em;
            color: var(--primary);
            margin-bottom: 20px;
            border-bottom: 3px solid var(--primary);
            padding-bottom: 10px;
        }
        .analysis-metric {
            margin: 15px 0;
            padding: 12px;
            background: var(--light);
            border-radius: 8px;
        }
        .campaign-item {
            padding: 8px 12px;
            margin: 5px 0;
            background: white;
            border-left: 4px solid var(--primary);
            border-radius: 4px;
            font-size: 0.9em;
        }
        .campaign-item.below { border-left-color: var(--danger); }
        .campaign-item.above { border-left-color: var(--success); }
        .stat-card.clickable {
            cursor: pointer;
            transition: all 0.3s;
        }
        .stat-card.clickable:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }

/* === COMPARADOR EN COLUMNAS === */
.comparator-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    margin-top: 20px;
}

.comp-card {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.comp-card h3 {
    margin: 0 0 15px 0;
    color: #1f2937;
    font-size: 16px;
    border-bottom: 2px solid #3b82f6;
    padding-bottom: 10px;
    word-break: break-word;
}

.comp-card .metric {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #f3f4f6;
}

.comp-card .metric strong {
    color: #6b7280;
    font-size: 14px;
}

.comp-card .metric span {
    color: #1f2937;
    font-weight: 500;
}

.comp-card .keyword-list {
    margin-top: 15px;
    max-height: 400px;
    overflow-y: auto;
}

.comp-card .keyword-item {
    background: #f9fafb;
    padding: 8px 12px;
    margin: 5px 0;
    border-radius: 4px;
    font-size: 14px;
    border-left: 3px solid #3b82f6;
    word-break: break-word;
}

#btnShowModified {
    transition: all 0.3s ease;
}

#btnShowModified:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.5);
}

.tab-btn {
    position: relative;
}

.tab-btn::after {
    content: 'üñ±Ô∏è Clic derecho para abrir en ventana';
    position: absolute;
    bottom: -30px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.85);
    color: white;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 11px;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
    z-index: 1000;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.tab-btn:hover::after {
    opacity: 1;
}

.bank-campaign-card {background: white; padding: 12px 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #667eea; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.05);}
.bank-campaign-card:hover {transform: translateX(5px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2); border-left-color: #764ba2;}
.bank-campaign-card.active {background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-left-color: #10b981;}
.bank-campaign-card h4 {margin: 0 0 8px 0; font-size: 0.95em; font-weight: 600;}
.bank-campaign-card .meta {font-size: 0.85em; opacity: 0.8; display: flex; gap: 12px; flex-wrap: wrap;}
.keyword-item {background: white; padding: 10px 12px; margin-bottom: 8px; border-radius: 6px; border: 2px solid #e5e7eb; display: flex; align-items: center; gap: 10px; transition: all 0.2s;}
.keyword-item:hover {border-color: #667eea; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);}
.keyword-item.selected {border-color: #10b981; background: #f0fdf4;}
.keyword-item input[type="checkbox"] {width: 18px; height: 18px; cursor: pointer;}
.keyword-text {flex: 1; font-weight: 500; font-size: 0.95em; word-break: break-word;}
.keyword-priority {padding: 4px 10px; border-radius: 4px; font-size: 0.75em; font-weight: 600; white-space: nowrap;}
.priority-high {background: #ef4444; color: white;}
.priority-normal {background: #6b7280; color: white;}
.keyword-metrics {display: flex; gap: 8px; font-size: 0.75em; color: #666;}
.metric-value {padding: 2px 6px; background: #f3f4f6; border-radius: 3px; white-space: nowrap;}

/* EDICI√ìN Y ELIMINACI√ìN */
.keyword-item.editing { border-color: #f59e0b; background: #fffbeb; }
.keyword-text-input { width: 100%; padding: 8px 12px; border: 2px solid #667eea; border-radius: 6px; font-size: 0.95em; font-weight: 500; }
.keyword-actions { display: flex; gap: 5px; }
.btn-mini { padding: 6px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em; font-weight: 600; }
.btn-edit-mini { background: #f59e0b; color: white; }
.btn-del-mini { background: #ef4444; color: white; }
.btn-save-mini { background: #10b981; color: white; }
.btn-cancel-mini { background: #6b7280; color: white; }
.keyword-edited-badge { background: #fef3c7; color: #92400e; padding: 2px 8px; border-radius: 4px; font-size: 0.75em; margin-left: 8px; }
.sync-status { position: fixed; bottom: 20px; right: 20px; padding: 12px 20px; border-radius: 8px; background: white; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-size: 0.9em; font-weight: 600; z-index: 9999; display: none; }
.sync-status.saving { background: #fef3c7; color: #92400e; display: block; }
.sync-status.saved { background: #d1fae5; color: #065f46; display: block; }
.sync-status.error { background: #fee2e2; color: #dc2626; display: block; }
</style>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</head>
<body>
<div id="loginScreen">
    <div class="login-box">
        <h1>üîí Gestor HAV 2026</h1>
        <p>Sistema Protegido - Acceso Autorizado</p>

        <div id="loginError" class="login-error">
            ‚ùå Usuario o contrase√±a incorrectos
        </div>

        <form id="loginForm" onsubmit="return handleLogin(event)">
            <div class="login-input-group">
                <label>üë§ Usuario</label>
                <input type="text" id="loginUser" autocomplete="username" required autofocus>
            </div>

            <div class="login-input-group">
                <label>üîë Contrase√±a</label>
                <input type="password" id="loginPass" autocomplete="current-password" required>
            </div>

            <button type="submit" class="login-btn">üöÄ Entrar al Gestor</button>
        </form>
    </div>
</div>

<button class="logout-btn" onclick="logout()" style="display: none;" id="logoutBtn">üö™ Cerrar Sesi√≥n</button>

<div id="mainApp">

    <div id="notification-area"></div>
    <div class="container">
        <div class="header">
            <h1>üöÄ Gestor de Campa√±as HAV 2026</h1>
            <p class="subtitle">‚òÅÔ∏è Sistema Sincronizado en la Nube</p>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="number" id="totalCampaigns">0</div>
                <div class="label">üìä Total Campa√±as</div>
            </div>
            <div class="stat-card">
                <div class="number" id="totalKeywords">0</div>
                <div class="label">üîë Keywords Totales</div>
            </div>
            <div class="stat-card clickable" onclick="showKeywordAnalysis()" title="Click para an√°lisis">
                <div class="number" id="filteredCount">0</div>
                <div class="label">üîç Campa√±as Filtro</div>
            </div>
            <div class="stat-card clickable" onclick="filterByArticleStatus()" title="Click para filtrar">
                <div class="number" id="totalArticles">0</div>
                <div class="label">üìù Con Art√≠culo üîç</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);">
                <button id="btnShowModified" onclick="showModifiedCampaigns()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; box-shadow: 0 2px 6px rgba(245, 158, 11, 0.4); width: 100%;">üìù Modificadas (0)</button>
                <button onclick="clearModifiedHistory()" style="background: #ef4444; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px; margin-top: 8px; width: 100%;">üóëÔ∏è Limpiar Historial</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" oncontextmenu="openTabInWindow('tab-list'); return false;" onclick="switchTab('tab-list')">üìã Lista de Campa√±as</button>
            <button class="tab-btn" oncontextmenu="openTabInWindow('tab-comp'); return false;" onclick="switchTab('tab-comp')">üî¨ Comparador</button>
            <button class="tab-btn" oncontextmenu="openTabInWindow('tab-add'); return false;" onclick="switchTab('tab-add')">‚ûï Gestionar Campa√±a</button>
            <button class="tab-btn" oncontextmenu="openTabInWindow('tab-config'); return false;" onclick="switchTab('tab-config')">‚öôÔ∏è Configuraci√≥n Global</button>
            <button class="tab-btn" oncontextmenu="openTabInWindow('tab-catalog'); return false;" onclick="switchTab('tab-catalog')">üì° Cat√°logo HAV</button>
            <button class="tab-btn" oncontextmenu="openTabInWindow('tab-keyword-bank'); return false;" onclick="switchTab('tab-keyword-bank')">üè¶ Banco Keywords</button>
        </div>

        <div id="tab-list" class="tab-content active">
            <div class="controls">
                <div class="control-group"><label>üîç Buscar</label><input type="text" id="search" autocomplete="off" onkeyup="renderTable()"></div>
                <div class="control-group"><label>üì∫ Canal</label><select id="filterChannel" onchange="renderTable()"></select></div>
                <div class="control-group"><label>üÜî ID Campa√±a</label><select id="filterId" onchange="renderTable()"></select></div>
                <div class="control-group"><label>üì¶ Nicho</label><select id="filterProduct" onchange="renderTable()"></select></div>
                <div class="control-group"><label>üì° Plataforma</label><select id="filterPlatform" onchange="renderTable()"></select></div>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th onclick="applySort('date')">üìÖ Fecha</th>
                            <th onclick="applySort('platform')">Plat.</th>
                            <th onclick="applySort('channel')">Canal</th>
                            <th onclick="applySort('product')">Nicho</th>
                            <th onclick="applySort('id')">ID</th>
                            <th onclick="applySort('code')">Nombre de Campa√±a</th>
                            <th onclick="applySort('language')">Idioma</th>
                            <th onclick="applySort('country')">Pa√≠s</th>
                            <th onclick="applySort('keys')">Keys</th>
                            <th onclick="applySort('article')">Art√≠culo</th>
                            <th onclick="applySort('url')">Link</th>
                            <th onclick="applySort('autor')">üë§</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="campaignList"></tbody>
                </table>
            <div style="margin:15px 0;text-align:center;">
                <button class="btn btn-success" onclick="generarReporte()" style="padding:8px 16px;font-size:0.9em;background:#10b981;">üìä Generar Reporte con Keywords</button>
            </div>

            
            <div style="margin:15px 0;text-align:center;"><button class="btn btn-success" onclick="generarReporteExcel()" style="padding:8px 16px;font-size:0.9em;background:#10b981;">üìä Generar Reporte de Campa√±as Visibles</button></div>
</div>
        </div>

        <div id="tab-comp" class="tab-content">
            <h2>Analizar 3 Campa√±as Simult√°neamente</h2>
            <div class="controls" style="margin-top: 15px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                <div class="control-group">
                    <label>Campa√±a 1 üîç</label>
                    <input type="text" id="comp1" list="comp1-list" placeholder="Escribe para buscar..." oninput="runTripleComparison()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <datalist id="comp1-list"></datalist>
                </div>
                <div class="control-group">
                    <label>Campa√±a 2 üîç (opcional)</label>
                    <input type="text" id="comp2" list="comp2-list" placeholder="Opcional..." oninput="runTripleComparison()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <datalist id="comp2-list"></datalist>
                </div>
                <div class="control-group">
                    <label>Campa√±a 3 üîç (opcional)</label>
                    <input type="text" id="comp3" list="comp3-list" placeholder="Opcional..." oninput="runTripleComparison()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <datalist id="comp3-list"></datalist>
                </div>
            </div>
            <button onclick="clearComparison()" style="margin-top: 10px; padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer;">üóëÔ∏è Limpiar</button>
            <div id="compResults" class="comparator-grid"></div>
        </div>

        <div id="tab-add" class="tab-content">
            <h2 id="formTitle">Gestionar Campa√±a</h2>
            <div class="controls" style="grid-template-columns: repeat(4, 1fr); margin-top: 15px;">
                <div class="control-group"><label>Plataforma</label><select id="inPlatform"></select></div>
                <div class="control-group"><label>Canal</label><select id="inChannel"></select></div>
                <datalist id="adManagerList"><option value="HAV"><option value="Otro"></datalist>
                <div class="control-group"><label>Idioma</label><select id="inLanguage"><option value="">Seleccionar idioma...</option></select></div>
                <div class="control-group"><label>Nicho/Producto</label><select id="inProduct"></select></div>
            </div>
            
            <div class="controls" style="grid-template-columns: repeat(4, 1fr); margin-top: 15px;">
                <div class="control-group"><label>üìÖ Fecha</label><input type="date" id="inDate"></div>
                <div class="control-group"><label>ID Campa√±a</label><input type="text" id="inId" list="inIdList" placeholder="Escribe o pega ID..." style="width: 100%;"><datalist id="inIdList"></datalist></div>
                <div class="control-group"><label>Nombre de Campa√±a</label><input type="text" id="inCode" oninput="autoCompleteCampaign()"></div>
                <div class="control-group"><label>Pa√≠s (ISO)</label><input type="text" id="inCountry"></div>
            </div>
            <div class="control-group" style="margin-top: 15px;">
                <label style="margin-bottom: 10px;">Keywords (una por l√≠nea)</label>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: start;">
                    <div>
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <button class="btn btn-bold" onclick="boldSelectedText()" style="padding: 6px 10px; font-size: 0.85em;"><b>B</b> Negrita</button>
                            <button class="btn btn-clear-tags" onclick="clearAllBoldTags()" style="padding: 6px 10px; font-size: 0.85em;">üóëÔ∏è Limpiar Negritas</button>
                        </div>
                        <textarea id="inKeywords1" rows="20" style="width: 100%; height: 400px; resize: vertical;"></textarea>
                    </div>

                    <div>
                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                            <button class="btn" style="background: #764ba2; color: white; padding: 6px 12px; font-size: 0.9em; cursor: default;" disabled>üìå Observaciones</button>
                        </div>
                        <textarea id="inKeywords2" rows="20" style="width: 100%; height: 400px; resize: vertical;"></textarea>
                    </div>
                </div>

                <div id="obsContainer" style="display: none; margin-top: 10px;">
                    <label style="font-size: 0.9em; color: #666;">Observaciones de la campa√±a:</label>
                    <textarea id="inObservaciones" rows="3"></textarea>
                </div>
            </div>
            
            <div class="control-group" style="margin-top: 15px;">
                <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 5px;">
                    <label style="margin-bottom: 0;">üìù Art√≠culo (Markdown)</label>
                    
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <label style="margin: 0; font-size: 0.9em; font-weight: bold;">‚úçÔ∏è Autor:</label>
                            <select id="inAutor" style="padding: 5px 10px; font-size: 0.9em; border: 1px solid var(--border); border-radius: 4px;">
                                <option value="">-</option>
                                <option value="I">I</option>
                                <option value="H">H</option>
                            </select>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <label style="margin: 0; font-size: 0.9em; font-weight: bold;">üîó URL:</label>
                            <input type="text" id="inUrl" placeholder="Pega aqu√≠ la URL..." style="padding: 5px 10px; font-size: 0.9em; border: 1px solid var(--border); border-radius: 4px; width: 300px;">
                        </div>
                    </div>
                </div>
                <textarea id="inArticle" rows="15" placeholder="Pega aqu√≠ tu art√≠culo en formato Markdown..."></textarea>
            </div>

            <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-edit" onclick="saveCampaign()">üíæ Guardar en Nube</button>
                <button class="btn btn-meta" onclick="saveMetadataOnly()" id="btnMetaOnly" style="display:none;">üìù Actualizar solo Datos</button>
                <button class="btn btn-warning" onclick="exportarCampanas()">üì§ Exportar Copia Seguridad</button>  <button class="btn btn-del" onclick="resetForm()">üîÑ Limpiar Formulario</button>
                <input type="file" id="importFile" accept=".json" style="display:none" onchange="importarDatos(event)">
                <button class="btn btn-primary" onclick="document.getElementById('importFile').click()">üì• Importar Backup JSON</button>
            </div>
        </div>

        <div id="tab-config" class="tab-content">
            <h2>Configuraci√≥n Global (Sincronizada)</h2>
            

            <div class="controls">
                <div class="control-group"><label>‚ûï Nuevo ID</label><input type="text" id="newIdVal" placeholder=""><button class="btn btn-edit" onclick="addOption('ids', 'newIdVal')">Crear</button></div>
                <div class="control-group"><label>‚ûï Nuevo Nicho</label><input type="text" id="newProdName" placeholder="Ej: Escritorio"><button class="btn btn-edit" onclick="addOption('products', 'newProdName')">Crear</button></div>
                <div class="control-group"><label>‚ûï Nueva Plataforma</label><select id="newPlatName"><option value="Facebook">Facebook</option><option value="TikTok">TikTok</option><option value="Google">Google</option></select><button class="btn btn-edit" onclick="addOption('platforms', 'newPlatName')">Crear</button></div>
                <div class="control-group"><label>‚ûï Nuevo Canal</label><input type="text" id="newChanName"><button class="btn btn-edit" onclick="addOption('channels', 'newChanName')">Crear</button></div>
                <div class="control-group"><label>‚ûï Nuevo Idioma</label><input type="text" id="newLangName" placeholder="Ej: Alem√°n"><button class="btn btn-edit" onclick="addOption('languages', 'newLangName')">Crear</button></div>
                <div class="control-group"><label>‚ûï Nuevo Pa√≠s</label><input type="text" id="newCountryName" placeholder="Ej: PE (Per√∫)"><button class="btn btn-edit" onclick="addOption('countries', 'newCountryName')">Crear</button></div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 25px;">
                <div><h4 style="color:var(--primary)">üÜî IDs de Campa√±a</h4><ul id="listIds" class="config-list"></ul></div>
                <div><h4 style="color:var(--secondary)">üì¶ Nichos</h4><ul id="listProds" class="config-list"></ul></div>
                <div><h4 style="color:var(--dark)">üì° Plataformas</h4><ul id="listPlatforms" class="config-list"></ul></div>
                <div><h4 style="color:var(--dark)">üì∫ Canales</h4><ul id="listChannels" class="config-list"></ul></div>
                <div><h4 style="color:var(--dark)">üåê Idiomas</h4><ul id="listLanguages" class="config-list"></ul></div>
                <div><h4 style="color:var(--dark)">üåç Pa√≠ses</h4><ul id="listCountries" class="config-list"></ul></div>
            </div>
        </div>

        <div id="tab-catalog" class="tab-content">
            <h2 style="color: #667eea; margin-bottom: 20px;">üì° Cat√°logo HAV - Canales en la Nube</h2>
            <div class="config-section" style="background: #f8f9fa; padding: 20px; margin: 20px 0; border-radius: 8px; border-left: 4px solid #007bff;">
                <h3 style="margin-top: 0; color: #007bff;">üì¶ Gesti√≥n del Cat√°logo HAV</h3>
                <div style="margin-bottom: 15px;">
                    <button class="btn btn-primary" onclick="document.getElementById('importFile').click()">
                        üì• Importar Cat√°logo JSON
                    </button>
                    <button class="btn btn-warning" onclick="forzarLimpiezaDuplicados()" style="margin-left: 10px;">
                        üßπ Eliminar Duplicados
                    </button>
                    <button class="btn btn-del" onclick="borrarCatalogoCompleto()" style="margin-left: 10px;">
                        üóëÔ∏è Borrar Cat√°logo Completo
                    </button>
                </div>
                <p style="margin: 0; font-size: 0.9em; color: #666;">
                    ‚Ä¢ <strong>Importar:</strong> Agrega canales desde un archivo JSON<br>
                    ‚Ä¢ <strong>Eliminar Duplicados:</strong> Limpia canales repetidos<br>
                    ‚Ä¢ <strong>Borrar Completo:</strong> Elimina TODO el cat√°logo HAV
                </p>
            </div>
            <div style="margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="addNewHAVChannel()">‚ûï Agregar Nuevo Canal</button>
            </div>
            <div id="havCatalogContainer" class="hav-catalog-grid"></div>
        </div>

    <!-- TAB BANCO KEYWORDS -->
    <div id="tab-keyword-bank" class="tab-content">
      <h2 style="color: #667eea; margin-bottom: 20px;">üè¶ Banco de Keywords</h2>
      <div class="stats" style="margin-bottom: 20px;">
        <div class="stat-card"><div class="number" id="bankTotalCampaigns">0</div><div class="label">Campa√±as</div></div>
        <div class="stat-card"><div class="number" id="bankTotalKeywords">0</div><div class="label">Keywords</div></div>
        <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);"><div class="number" id="bankSelectedCount" style="color: white;">0</div><div class="label" style="color: white;">Seleccionadas</div></div>
      </div>
      <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
        <button class="btn btn-primary" onclick="document.getElementById('importBankExcel').click()">üìä Importar Excel</button>
        <input type="file" id="importBankExcel" accept=".xlsx,.xls" style="display:none" onchange="importKeywordBankFromExcel(event)">
        <button class="btn btn-primary" onclick="document.getElementById('importBankFile').click()">üì• Importar JSON</button>
        <input type="file" id="importBankFile" accept=".json" style="display:none" onchange="importKeywordBank(event)">
        <button class="btn btn-success" onclick="exportKeywordBank()">üíæ Exportar</button>
        <button class="btn btn-del" onclick="clearSelectedKeywords()">üóëÔ∏è Limpiar</button>
        <button class="btn btn-warning" onclick="clearBankData()">‚ö†Ô∏è Vaciar</button>
      </div>
      <div class="controls" style="grid-template-columns: 1fr 1fr 1fr 1fr 2fr; margin-bottom: 20px;">
        <div class="control-group"><label>üîç Buscar</label><input type="text" id="bankSearch" placeholder="Buscar..." oninput="filterKeywordBank()" autocomplete="off"></div>
        <div class="control-group"><label>üì¶ Nicho</label><select id="bankFilterProduct" onchange="filterKeywordBank()"><option value="">Todos</option></select></div>
        <div class="control-group"><label>üåç Pa√≠s</label><select id="bankFilterCountry" onchange="filterKeywordBank()"><option value="">Todos</option></select></div>
        <div class="control-group"><label>‚ö° Acciones</label><div style="display: flex; gap: 8px;"><button class="btn btn-success" onclick="copySelectedKeywords()" style="flex: 1; padding: 8px; font-size: 0.9em;">üìã Copiar</button><button class="btn btn-primary" onclick="sendToForm()" style="flex: 1; padding: 8px; font-size: 0.9em;">‚û°Ô∏è A Campa√±a</button></div></div>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px; min-height: 500px;">
        <div style="border-right: 2px solid #e5e7eb; padding-right: 20px;">
          <h3 style="color: #667eea; margin-bottom: 15px; font-size: 1.1em;">üìã Campa√±as (<span id="bankFilteredCount">0</span>)</h3>
          <div id="bankCampaignsList" style="max-height: 600px; overflow-y: auto;"><div style="text-align: center; padding: 60px 20px; color: #999;"><div style="font-size: 3em;">üìä</div><p>Importa un archivo Excel</p></div></div>
        </div>
        <div><div id="bankKeywordsDetail" style="background: #f9fafb; padding: 20px; border-radius: 8px; min-height: 600px;"><div style="text-align: center; padding: 100px 20px; color: #999;"><div style="font-size: 3em;">üëà</div><p>Selecciona una campa√±a</p></div></div></div>
      </div>
    </div>
    </div>

    <div id="editChannelModal" class="modal">
        <div class="modal-content">
            <h3>‚úèÔ∏è Editar Canal HAV</h3>
            <div class="control-group"><label>Plataforma</label><select id="modalPlatform"><option value="FB">Facebook (FB)</option><option value="TT">TikTok (TT)</option><option value="GN">Google (GN)</option></select></div>
            <div class="control-group" style="margin-top: 15px;"><label>Nombre del Canal (sin prefijo)</label><input type="text" id="modalChannelName" placeholder=""></div>
            <div class="control-group" style="margin-top: 15px;"><label>ID del Canal</label><input type="text" id="modalChannelId" placeholder=""></div>
            <div class="control-group" style="margin-top: 15px;"><label>Categor√≠a/Grupo</label><input type="text" id="modalChannelGroup" placeholder=""></div>
            <div class="modal-buttons"><button class="btn btn-del" onclick="closeChannelModal()">‚ùå Cancelar</button><button class="btn btn-success" onclick="saveChannelEdit()">üíæ Guardar</button></div>
        </div>
    </div>

<script>
// ============================================================================
// 1. CONFIGURACI√ìN FIREBASE
// ============================================================================
const firebaseConfig = {
  apiKey: "AIzaSyB6lGHmig5XC4RPwAFnWaBFkpXIqdO_WoM",
  authDomain: "gestor-campanas-hav2026.firebaseapp.com",
  projectId: "gestor-campanas-hav2026",
  storageBucket: "gestor-campanas-hav2026.firebasestorage.app",
  messagingSenderId: "1715326503",
  appId: "1:1715326503:web:2b7ecda6f5257c9da78802"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const dbFirebase = firebase.firestore();
// FIX CONEXI√ìN: evita cortes de WebChannel/Listen en algunas redes
try {
  if (dbFirebase && typeof dbFirebase.settings === 'function') {
    dbFirebase.settings({ experimentalAutoDetectLongPolling: true, useFetchStreams: false });
  }
} catch (e) {}

const campaignsRef = dbFirebase.collection('campaigns');
const settingsRef = dbFirebase.collection('settings').doc('globalConfig'); 

console.log('üî• Firebase conectado');

// ============================================================================
// 2. DATOS HIST√ìRICOS Y RESPALDOS (TU BASE DE DATOS ORIGINAL INTACTA)
// ============================================================================

const initialCampaigns = [
    { "platform": "FB", "channel": "HAV", "product": "Celulares", "country": "PL", "code": "FB-HAV-Celulares-PL", "id": "00902", "keywords": ["Telefon na raty", "Telefony na Raty Przez Internet", "Telefon w miesiƒôcznych ratach", "Finansowanie Telefon bez wp≈Çaty poczƒÖtkowe", "Telefon na raty bez BIK", "Telefon na Raty Bez Banku"], "article": "" },
    // ... [Tu historial original sigue aqu√≠ protegido]
    { "platform": "FB", "channel": "HAV", "product": "Iphone", "country": "DE", "code": "FB-HAV-Iphone-DE", "id": "00903", "keywords": ["Iphone Bestellen auf Raten", "Iphone Ratenkauf"], "article": "" }
];

const ALL_NICHOS = [
    'AireAcondicionado', 'Apartamentos', 'Autos', 'AutosElectricos', 'Bicicletas',
    'CadenasDeOro', 'Celulares', 'Colchones', 'Cortacesped', 'CursoDeIngles',
    'CursoDeMarketingDigital', 'CursosInteligenciaArtificial', 'Escritorio',
    'Generadores', 'Iphone', 'Muebles', 'MueblesDeCocina', 'PcGamer', 'PcGamerBM2',
    'Refrigeradores', 'Sofa', 'SofaCama', 'Televisores', 'UniversidadesOnline'
];

const ALL_LANGUAGES = ['Alem√°n', 'Ingl√©s', 'Neerland√©s', 'B√∫lgaro', 'Espa√±ol', 'Portugu√©s', 'Checo', 'Dan√©s', 'Fin√©s', 'Franc√©s', 'H√∫ngaro', 'Italiano', 'Lituano', 'Noruego', 'Polaco', 'Rumano', '√Årabe', 'Sueco', 'Esloveno', 'Eslovaco', 'Turco'];

const HAV_CATALOG_INITIAL = {};

// ============================================================================
// 3. ESTRUCTURA DE DATOS
// ============================================================================
let db = JSON.parse(localStorage.getItem('arbitrage_final_v11')) || {
    campaigns: initialCampaigns, // SE INICIA CON TUS DATOS HIST√ìRICOS
    platforms: ['FB', 'TT', 'GN'],
    channels: ['Mundo', 'IH', 'CS', 'HN'],
    products: ALL_NICHOS,
    ids: ['00902', '00903', '00904', '00905', '00908', '00909'],
    havCatalog: HAV_CATALOG_INITIAL
};

// --- FIX: Inicializaci√≥n segura de arrays ---
if (!db.ids) db.ids = ['00902', '00903', '00904', '00905', '00908', '00909'];
if (!db.products) db.products = ALL_NICHOS;
if (!db.platforms) db.platforms = ['FB', 'TT', 'GN'];
if (!db.channels) db.channels = ['Mundo', 'IH', 'CS', 'HN'];
if (!db.countries) db.countries = ['PL', 'DE', 'ES', 'FR', 'IT', 'NL', 'BE', 'PT', 'UK', 'US', 'MX', 'AR', 'BR', 'CL', 'CO', 'PE'];
// ------------------------------------------

let editingIndex = -1;
let keywordBank = [];
let selectedKeywords = [];
let currentBankCampaignIndex = -1;
let bankSortDirection = 'desc';
let originalKeywordOrder = [];;
let currentSort = { column: 'country', order: 'asc' };
let currentEditingChannel = null;

// ============================================================================
// 4. L√ìGICA DE NUBE (H√çBRIDA PARA PROTECCI√ìN DE DATOS)
// ============================================================================
    function generarReporte() {
        if (!db.campaigns.length) {
            return alert("No hay campa√±as para generar reporte.");
        }

        // Obtener campa√±as filtradas
        const fs = document.getElementById('search').value.toLowerCase();
        const fp = document.getElementById('filterPlatform').value;
        const fc = document.getElementById('filterChannel').value;
        const fpr = document.getElementById('filterProduct').value;
        const fi = document.getElementById('filterId').value;

        const camps = db.campaigns.filter(c => {
            if (fs && !c.code.toLowerCase().includes(fs)) return false;
            if (fp && fp !== 'Todos' && c.platform !== fp) return false;
            if (fc && fc !== 'Todos' && c.channel !== fc) return false;
            if (fpr && fpr !== 'Todos' && c.product !== fpr) return false;
            if (fi && fi !== 'Todos' && c.id !== fi) return false;
            return true;
        });

        if (!camps.length) {
            return alert("No hay campa√±as visibles para generar reporte.");
        }

        function getPlatformName(code) {
            if (code === 'FB') return 'Facebook';
            if (code === 'TT') return 'TikTok';
            if (code === 'GN') return 'Google';
            return code;
        }

        function getCountryName(code) {
            const paises = {
                'PL': 'Polonia', 'DE': 'Alemania', 'ES': 'Espa√±a', 'FR': 'Francia',
                'IT': 'Italia', 'NL': 'Pa√≠ses Bajos', 'BE': 'B√©lgica', 'PT': 'Portugal',
                'UK': 'Reino Unido', 'US': 'Estados Unidos', 'MX': 'M√©xico',
                'AR': 'Argentina', 'BR': 'Brasil', 'CL': 'Chile', 'CO': 'Colombia', 'PE': 'Per√∫'
            };
            return paises[code] || code;
        }

        function formatDate(fecha) {
            if (!fecha) return 'Sin fecha';
            const partes = fecha.split('-');
            if (partes.length === 3) {
                return `${partes[2]}/${partes[1]}/${partes[0]}`;
            }
            return fecha;
        }

        let html = `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Campa√±as HAV 2026</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }
        .header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .header .meta {
            color: #666;
            font-size: 1.1em;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        .stat-box .number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-box .label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.95em;
        }
        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        th {
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        td {
            padding: 12px 10px;
            border-bottom: 1px solid #e5e7eb;
            vertical-align: top;
        }
        tbody tr:nth-child(even) {
            background: #f9fafb;
        }
        tbody tr:hover {
            background: #eff6ff;
        }
        .campaign-name {
            font-weight: bold;
            color: #1e40af;
            font-size: 1.05em;
        }
        .nicho {
            font-weight: bold;
            color: #2c3e50;
        }
        .keywords-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .keywords-list li {
            padding: 4px 0;
            border-bottom: 1px dotted #ddd;
        }
        .keywords-list li:last-child {
            border-bottom: none;
        }
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
        }
        .badge-fb { background: #1877f2; color: white; }
        .badge-tt { background: #fe2c55; color: white; }
        .badge-gn { background: #EA4335; color: white; }
        .print-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 24px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .print-btn:hover {
            background: #059669;
        }
        @media print {
            body { background: white; padding: 0; }
            .print-btn { display: none; }
            .container { box-shadow: none; }
        }
    </style>
</head>
<body>
    <button class="print-btn" onclick="window.print()">üñ®Ô∏è Imprimir / Guardar PDF</button>
    <div class="container">
        <div class="header">
            <h1>üìä Reporte de Campa√±as HAV 2026</h1>
            <div class="meta">
                <p><strong>Fecha de generaci√≥n:</strong> ${new Date().toLocaleDateString('es-ES')} ${new Date().toLocaleTimeString('es-ES')}</p>
            </div>
        </div>

        <div class="stats">
            <div class="stat-box">
                <div class="number">${camps.length}</div>
                <div class="label">Campa√±as</div>
            </div>
            <div class="stat-box">
                <div class="number">${camps.reduce((sum, c) => sum + (c.keywords?.length || 0), 0)}</div>
                <div class="label">Keywords Totales</div>
            </div>
            <div class="stat-box">
                <div class="number">${Math.round(camps.reduce((sum, c) => sum + (c.keywords?.length || 0), 0) / camps.length)}</div>
                <div class="label">Promedio Keywords</div>
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th style="width: 40px;">#</th>
                    <th style="width: 80px;">Fecha</th>
                    <th style="width: 100px;">Plataforma</th>
                    <th style="width: 80px;">Canal</th>
                    <th style="width: 120px;">Nicho</th>
                    <th style="width: 80px;">ID</th>
                    <th style="width: 100px;">Pa√≠s</th>
                    <th style="width: 80px;">Idioma</th>
                    <th>Nombre de Campa√±a</th>
                    <th style="width: 60px;">Keys</th>
                    <th>Keywords</th>
                </tr>
            </thead>
            <tbody>`;

        camps.forEach((c, index) => {
            const platformBadge = c.platform === 'FB' ? 'badge-fb' : c.platform === 'TT' ? 'badge-tt' : 'badge-gn';

            // FILTRAR KEYWORDS: Solo antes de la primera l√≠nea vac√≠a
            let filteredKeywords = c.keywords || [];
            if (filteredKeywords.length > 0) {
                const emptyIndex = filteredKeywords.findIndex(k => !k || k.trim() === '');
                if (emptyIndex !== -1) {
                    filteredKeywords = filteredKeywords.slice(0, emptyIndex);
                }
            }

            const keywordsList = filteredKeywords.length > 0 
                ? filteredKeywords.map(k => `<li>${k}</li>`).join('') 
                : '<li style="color: #999;">Sin keywords</li>';

            html += `
                <tr>
                    <td>${index + 1}</td>
                    <td>${formatDate(c.date)}</td>
                    <td><span class="badge ${platformBadge}">${getPlatformName(c.platform)}</span></td>
                    <td>${c.channel || '-'}</td>
                    <td class="nicho">${c.product || '-'}</td>
                    <td><strong>${c.id || '-'}</strong></td>
                    <td>${getCountryName(c.country)}</td>
                    <td>${c.language || '-'}</td>
                    <td class="campaign-name">${c.code}</td>
                    <td style="text-align: center;"><strong>${filteredKeywords.length}</strong></td>
                    <td><ul class="keywords-list">${keywordsList}</ul></td>
                </tr>`;
        });

        html += `
            </tbody>
        </table>
    </div>

    <div id="syncStatus" class="sync-status"></div>
</body>
</html>`;

        const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `reporte-campanas-${new Date().toISOString().slice(0, 10)}.html`;
        link.click();
        URL.revokeObjectURL(url);

        showNotif(`‚úì Reporte HTML generado con ${camps.length} campa√±as`, 'success');
    }




function limpiarDuplicadosCatalogo() {
    let totalEliminados = 0;
    for (let categoria in db.havCatalog) {
        if (!Array.isArray(db.havCatalog[categoria])) continue;
        const items = db.havCatalog[categoria];
        const codesVistos = new Set();
        const itemsUnicos = [];
        items.forEach(item => {
            if (!codesVistos.has(item.code)) {
                codesVistos.add(item.code);
                itemsUnicos.push(item);
            } else {
                totalEliminados++;
            }
        });
        db.havCatalog[categoria] = itemsUnicos;
    }
    if (totalEliminados > 0) {
        saveGlobalSettings();
        refreshEverything();
        showNotif(`üßπ ${totalEliminados} duplicados eliminados`, 'success');
    }
    return totalEliminados;
}

function borrarCatalogoCompleto() {
    if (confirm('‚ö†Ô∏è ¬øBORRAR TODO EL CAT√ÅLOGO HAV?\n\nEsta acci√≥n eliminar√° TODOS los canales.\n¬øEst√°s seguro?')) {
        if (confirm('‚ö†Ô∏è‚ö†Ô∏è √öLTIMA CONFIRMACI√ìN\n\nSe borrar√°n TODOS los canales. ¬øContinuar?')) {
            db.havCatalog = {};
            saveGlobalSettings();
            refreshEverything();
            showNotif('üóëÔ∏è Cat√°logo HAV borrado', 'warning');
        }
    }
}

function forzarLimpiezaDuplicados() {
    const total = limpiarDuplicadosCatalogo();
    alert(total === 0 ? '‚úÖ No hay duplicados' : `üßπ ${total} duplicados eliminados`);
}

function startRealtimeSync() {
    setTimeout(() => { limpiarDuplicadosCatalogo(); }, 3000);
    showNotif('üì° Conectando a la Nube...', 'info');

    // A) Escuchar CAMPA√ëAS
    campaignsRef.onSnapshot(snapshot => {
        const loaded = [];
        snapshot.forEach(doc => loaded.push({ firebaseId: doc.id, ...doc.data() }));
        
        if (loaded.length > 0) {
            // Si la nube tiene datos, los usamos (as√≠ tus compa√±eros ven lo mismo)
            db.campaigns = loaded;
        } else {
            // Si la nube est√° vac√≠a, MANTENEMOS TUS DATOS LOCALES y los subimos silenciosamente
            console.log("‚ö†Ô∏è Nube vac√≠a. Usando datos hist√≥ricos y subi√©ndolos...");
            // initialCampaigns.forEach(c => campaignsRef.add(c));
        }
        
        renderTable();
        updateStats();
    });

    // B) Escuchar CONFIGURACI√ìN
    settingsRef.onSnapshot(doc => {
        if (doc.exists) {
            const data = doc.data();
            // PROTECCI√ìN: Si la nube devuelve nichos vac√≠os, ignoramos y usamos los locales
            if (data.products && data.products.length > 0) {
                db.products = data.products;
            } else {
                console.log("‚ö†Ô∏è Recuperando Nichos Locales...");
                db.products = ALL_NICHOS; 
                saveGlobalSettings(); // Reparar nube
            }

            if (data.ids !== undefined) {
                const mergedIds = [...new Set([...(db.ids || []), ...(data.ids || [])])];
                db.ids = mergedIds.sort();
            } else {
                db.ids = db.ids || [];
            }
            if (data.platforms !== undefined) {
                const mergedPlatforms = [...new Set([...(db.platforms || []), ...(data.platforms || [])])];
                db.platforms = mergedPlatforms.sort();
            } else {
                db.platforms = db.platforms || [];
            }
            if (data.channels !== undefined) {
                const mergedChannels = [...new Set([...(db.channels || []), ...(data.channels || [])])];
                db.channels = mergedChannels.sort();
            } else {
                db.channels = db.channels || [];
            }
            db.languages = data.languages || ALL_LANGUAGES;
            db.havCatalog = (data.havCatalog && Object.keys(data.havCatalog).length) ? data.havCatalog : HAV_CATALOG_INITIAL;
            
            refreshEverything();
        } else {
            // Primera vez: Subimos tu configuraci√≥n local a la nube
            console.log("‚ö†Ô∏è Inicializando nube con tus datos...");
            saveGlobalSettings();
        }
    });
}

// 4. NUEVA FUNCI√ìN EXPORTAR (TU SEGURO DE VIDA)
function exportarCampanas() {
    const dataStr = JSON.stringify(db.campaigns, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `backup_campanas_${new Date().toISOString().slice(0,10)}.json`;
    link.click();
    showNotif('‚úÖ Copia de seguridad descargada', 'success');
}


function generarReporte() {
    if (db.campaigns.length === 0) {
        alert('No hay campa√±as para generar reporte.');
        return;
    }

    // Funci√≥n para extraer el t√≠tulo de la primera l√≠nea del art√≠culo
    function extraerTitulo(article) {
        if (!article || !article.trim()) return 'Sin t√≠tulo';

        // Quitar marcadores de markdown
        let firstLine = article.split('\n')[0].trim();

        // Remover markdown com√∫n: #, ##, ###, **, *, etc.
        firstLine = firstLine.replace(/^#+\s*/g, ''); // Encabezados
        firstLine = firstLine.replace(/\*\*/g, ''); // Negritas
        firstLine = firstLine.replace(/\*/g, ''); // Cursivas
        firstLine = firstLine.replace(/<b>/gi, '').replace(/<\/b>/gi, ''); // Etiquetas HTML

        return firstLine || 'Sin t√≠tulo';
    }

    // Funci√≥n para formatear pa√≠s
    function formatearPais(countryCode) {
        const paises = {
            'PL': 'Polonia', 'DE': 'Alemania', 'ES': 'Espa√±a', 'FR': 'Francia',
            'IT': 'Italia', 'NL': 'Pa√≠ses Bajos', 'BE': 'B√©lgica', 'PT': 'Portugal',
            'UK': 'Reino Unido', 'US': 'Estados Unidos', 'MX': 'M√©xico',
            'AR': 'Argentina', 'BR': 'Brasil', 'CL': 'Chile', 'CO': 'Colombia',
            'PE': 'Per√∫'
        };
        return paises[countryCode] || countryCode;
    }

    // Funci√≥n para formatear fecha
    function formatearFecha(fecha) {
        if (!fecha) return 'Sin fecha';
        // Convertir de YYYY-MM-DD a DD/MM/YYYY
        const partes = fecha.split('-');
        if (partes.length === 3) {
            return `${partes[2]}/${partes[1]}/${partes[0]}`;
        }
        return fecha;
    }

    // Generar contenido del reporte
    let reporte = '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
    reporte += '                    REPORTE DE CAMPA√ëAS HAV 2026\n';
    reporte += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
    reporte += `Total de Campa√±as: ${db.campaigns.length}\n`;
    reporte += `Fecha de Generaci√≥n: ${new Date().toLocaleDateString('es-ES')} ${new Date().toLocaleTimeString('es-ES')}\n\n`;
    reporte += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';

    db.campaigns.forEach((c, index) => {
        reporte += `N¬∞: ${index + 1}\n`;
        reporte += `T√çTULO: ${extraerTitulo(c.article)}\n`;
        reporte += `PA√çS: ${formatearPais(c.country)}\n`;
        reporte += `NOMBRE DE CAMPA√ëA: ${c.code}\n`;
        reporte += `FECHA: ${formatearFecha(c.date)}\n`;
        reporte += `PLATAFORMA: ${c.platform === 'FB' ? 'Facebook' : c.platform === 'TT' ? 'TikTok' : c.platform === 'GN' ? 'Google' : c.platform}\n`;
        reporte += `CANAL: ${c.channel || 'N/A'}\n`;
        reporte += `IDIOMA: ${c.language || 'N/A'}\n`;
        reporte += `KEYWORDS: ${c.keywords ? c.keywords.length : 0}\n`;
        reporte += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n';
    });

    // Crear archivo de texto
    const blob = new Blob([reporte], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `reporte-campanas-${new Date().toISOString().slice(0,10)}.txt`;
    link.click();
    URL.revokeObjectURL(url);

    showNotif('üìä Reporte generado y descargado', 'success');
}

async function saveToFirebase(campaign) {
  try {
    if (campaign.firebaseId) {
      const { firebaseId, ...data } = campaign;
      await campaignsRef.doc(firebaseId).update(data);
      showNotif('‚òÅÔ∏è Actualizado en Nube', 'success');
    } else {
      await campaignsRef.add(campaign);
      showNotif('‚òÅÔ∏è Guardado en Nube', 'success');
    }
  } catch (error) { alert('Error nube: ' + error.message); }
}

async function deleteFromFirebase(firebaseId) {
  try { await campaignsRef.doc(firebaseId).delete(); showNotif('üóëÔ∏è Borrado de Nube', 'success'); } catch (error) { console.error(error); }
}

async function saveGlobalSettings() {
    try {
        await settingsRef.set({
            products: db.products,
            ids: db.ids,
            platforms: db.platforms,
            channels: db.channels,
            languages: db.languages,
            havCatalog: db.havCatalog,
            countries: db.countries || [],
            lastUpdate: new Date().toISOString()
        }, { merge: true });
    } catch (error) { console.error(error); }
}

// ============================================================================
// 5. INTERFAZ (UI) - EXACTAMENTE COMO LA ORIGINAL
// ============================================================================

const nichoEmojis = {
    'cadena': '‚õìÔ∏è', 'oro': 'üí∞', 'joya': 'üíé', 'iphone': 'üì±', 'celular': 'üì±', 
    'tv': 'üì∫', 'televisor': 'üì∫', 'televisores': 'üì∫',
    'sof√°': 'üõãÔ∏è', 'sofa': 'üõãÔ∏è', 'mueble': 'ü™ë', 'bici': 'üö≤', 
    'pc': 'üíª', 'colch√≥n': 'üõèÔ∏è', 'auto': 'üöó', 'curso': 'üìö', 'jard√≠n': 'üåø',
    'aire': '‚ùÑÔ∏è', 'refriger': 'üßä', 'generador': '‚ö°', 'cortacesped': 'üåø',
    'escritorio': 'üñ•Ô∏è', 'apartamento': 'üè¢'
};

function getNichoConEmoji(nicho) {
    if (!nicho) return '';
    const n = nicho.toLowerCase();
    for (let key in nichoEmojis) { if (n.includes(key)) return nichoEmojis[key] + ' ' + nicho; }
    return nicho;
}

function updateCampPlatform(index, newPlatform) {
    const c = db.campaigns[index];
    if (c) { c.platform = newPlatform; saveToFirebase(c); }
}

function switchTab(id) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelector(`[onclick="switchTab('${id}')"]`).classList.add('active');
    if(id === 'tab-comp') updateCompSelects();
    if(id === 'tab-catalog') renderHAVCatalog();
    
    // FIX: Al volver a la lista, SIEMPRE renderizar para quitar filtros "Modificados"
    if (id === 'tab-list') {
        renderTable();
    }
}

function updateStats(filteredCampaigns = null) {
    const campaignsToCount = filteredCampaigns !== null ? filteredCampaigns : db.campaigns;

    document.getElementById('totalCampaigns').textContent = db.campaigns.length;
    const totalKeys = db.campaigns.reduce((sum, c) => sum + (c.keywords?.length || 0), 0);
    document.getElementById('totalKeywords').textContent = totalKeys;

    const filteredElement = document.getElementById('filteredCount');
    if (filteredElement) {
        filteredElement.textContent = (filteredCampaigns !== null) ? filteredCampaigns.length : 0;
    }

    const withArticles = campaignsToCount.filter(c => c.article && c.article.trim()).length;
    document.getElementById('totalArticles').textContent = withArticles;
}

function refreshEverything() { updateOptions(); renderTable(); updateStats(); renderHAVCatalog(); }

function updateOptions() {
    const fill = (id, arr, isFilter) => {
        const el = document.getElementById(id);
        if(!el) return;
        el.innerHTML = (isFilter ? '<option value="">Todos</option>' : '') + 
                       (arr || []).map(opt => `<option value="${opt}">${opt}</option>`).join('');
    };

    fill('inPlatform', db.platforms); fill('filterPlatform', db.platforms, true);
    fill('inChannel', db.channels); fill('filterChannel', db.channels, true);
    // Aseguramos que siempre use la lista completa si la db falla
    fill('inProduct', db.products.length ? db.products : ALL_NICHOS); 
    fill('filterProduct', db.products.length ? db.products : ALL_NICHOS, true);
    // Llenar inId (input con datalist)
    const inIdList = document.getElementById('inIdList');
    if (inIdList && db && db.ids) {
        inIdList.innerHTML = '';
        db.ids.forEach(val => {
            const opt = document.createElement('option');
            opt.value = val;
            inIdList.appendChild(opt);
        });
    }
    fill('filterId', db.ids, true);
    fill('inLanguage', db.languages);

    ['ids', 'products', 'platforms', 'channels', 'languages', 'countries'].forEach(type => {
        let listId = '';
        if(type==='ids') listId='listIds'; else if(type==='products') listId='listProds'; else if(type==='platforms') listId='listPlatforms'; else if(type==='channels') listId='listChannels'; else if(type==='languages') listId='listLanguages'; else if(type==='countries') listId='listCountries';
        
        const container = document.getElementById(listId);
        if(container && db[type]) {
            container.innerHTML = db[type].map((val, i) => `
                <li>
                    <input type="text" class="config-input" value="${val}" id="input_${type}_${i}">
                    <button class="btn btn-save-mini" onclick="updateGlobalItem('${type}', ${i})">üíæ</button>
                    <button class="btn-del-mini" onclick="delOption('${type}', ${i})">üóëÔ∏è</button>
                </li>`).join('');
        }
    });
}

function addOption(type, inputId) {
    const val = document.getElementById(inputId).value.trim();
    if (!db[type]) db[type] = [];
    if (!val || db[type].includes(val)) return alert('Valor inv√°lido o ya existe');
    db[type].push(val); 
    db[type].sort();
    saveGlobalSettings();
    document.getElementById(inputId).value = '';
    showNotif('‚úÖ Agregado', 'success');
    refreshEverything();
}

function delOption(type, index) {
    if (confirm('¬øEliminar?')) { db[type].splice(index, 1); saveGlobalSettings(); refreshEverything(); }
}

function updateGlobalItem(type, index) {
    const newVal = document.getElementById(`input_${type}_${index}`).value.trim();
    if(newVal) { db[type][index] = newVal; saveGlobalSettings(); showNotif('‚úÖ Actualizado', 'success'); }
}

function renderTable() {
    const q = document.getElementById('search').value.toLowerCase();
    const pF = document.getElementById('filterPlatform').value;
    const prF = document.getElementById('filterProduct').value;
    const idF = document.getElementById('filterId').value;
    const chF = document.getElementById('filterChannel').value;
    const countryF = (document.getElementById('filterCountryName')?.value || '').trim();
    function mapCountryFilter(val) {
        if (!val) return '';
        const s = String(val).trim();
        if (/^[A-Za-z]{2}$/.test(s)) return s.toUpperCase();
        const target = s.toLowerCase();
        const list = (db && db.countries) ? db.countries : [];
        for (let i=0;i<list.length;i++) {
            const entry = String(list[i] || '');
            // Soporta: "ES (Espa√±a)", "ES Espa√±a", "ES - Espa√±a"
            const m1 = entry.match(/^([A-Za-z]{2})\s*\((.+)\)$/);
            if (m1 && m1[2].trim().toLowerCase() === target) return m1[1].toUpperCase();
            const m2 = entry.match(/^([A-Za-z]{2})\s*[-‚Äì‚Äî]?\s+(.+)$/);
            if (m2 && m2[2].trim().toLowerCase() === target) return m2[1].toUpperCase();
            if (entry.toLowerCase() === target) return entry;
        }
        return s; // fallback
    }


    let filtered = db.campaigns.filter(c => 
        (c.code.toLowerCase().includes(q) || c.id.includes(q) || c.country.toLowerCase().includes(q)) && 
        (!pF || c.platform === pF) && 
        (!prF || c.product === prF) && 
        (!idF || c.id === idF) &&
        (!chF || chF === 'Todos' || c.channel === chF)
    );

    filtered.sort((a, b) => {
        let vA = a[currentSort.column], vB = b[currentSort.column];

        // 1. L√≥gica especial para contar Keys
        if (currentSort.column === 'keys') {
            vA = a.keywords?.length || 0;
            vB = b.keywords?.length || 0;
        }

        // 2. L√≥gica especial para Art√≠culo (Correcci√≥n aplicada)
        if (currentSort.column === 'article') {
            const hasA = a.article && a.article.trim() ? 1 : 0;
            const hasB = b.article && b.article.trim() ? 1 : 0;
            
            // Si uno tiene y el otro no, eso decide el orden
            if (hasA !== hasB) {
                vA = hasA; 
                vB = hasB;
            } else {
                // Si ambos tienen (o no tienen), desempatamos por longitud de texto
                vA = (a.article || '').length;
                vB = (b.article || '').length;
            }
        }

        // 3. L√≥gica especial para URL/Link (Correcci√≥n aplicada)
        if (currentSort.column === 'url') {
            // Convertimos a 1 (tiene link) o 0 (no tiene link)
            const hasLinkA = (a.url && String(a.url).trim().length > 0) ? 1 : 0;
            const hasLinkB = (b.url && String(b.url).trim().length > 0) ? 1 : 0;
            vA = hasLinkA;
            vB = hasLinkB;
        }

        // 4. L√≥gica para Autor
        if (currentSort.column === 'autor') {
            vA = (a.autor || '').toLowerCase();
            vB = (b.autor || '').toLowerCase();
        }

        // === PARTE CR√çTICA: EL COMPARADOR ESTABLE ===
        // Esto soluciona el error en GitHub.
        // Si vA es menor que vB
        if (vA < vB) return currentSort.order === 'asc' ? -1 : 1;
        // Si vA es mayor que vB
        if (vA > vB) return currentSort.order === 'asc' ? 1 : -1;
        // Si son IGUALES (vA === vB), devolvemos 0 para no romper el orden
        return 0; 
    });

    const tbody = document.getElementById('campaignList');
    tbody.innerHTML = filtered.map(c => {
        const realIndex = db.campaigns.indexOf(c);
        const hasArticle = c.article && c.article.trim();
        const articleIcon = hasArticle ? 
            `<span class="article-indicator has-article" onclick="toggleArticle(${realIndex})">‚úÖ</span>` : 
            `<span class="article-indicator no-article">‚ùå</span>`;
        
        // CORRECCION FINAL: FORZAR VERDE SI HAY URL Y HACERLO CLICKABLE
        const hasUrl = (c.url && String(c.url).trim().length > 0);
        const urlClass = hasUrl ? 'url-active' : 'url-inactive';

        // Si hay URL, usamos <a> para ir al link. Si no, usamos <span>.
        const urlIcon = hasUrl
            ? `<a href="${c.url}" target="_blank" class="${urlClass}" title="Ir a: ${c.url}">üîó</a>`
            : `<span class="${urlClass}" title="Sin Link">üîó</span>`;

        // 3. SELECCI√ìN DE NOMBRE DE PLATAFORMA (NO ABREVIADO)
        const getPlatName = (code) => {
            if(code === 'FB') return 'Facebook';
            if(code === 'TT') return 'TikTok';
            if(code === 'GN') return 'Google';
            return code;
        };

        return `<tr>
            <td>${c.date || '-'}</td> <td>
                <select class="platform-select" onchange="updateCampPlatform(${realIndex}, this.value)">
                    <option value="FB" ${c.platform === 'FB' ? 'selected' : ''}>Facebook</option>
                    <option value="TT" ${c.platform === 'TT' ? 'selected' : ''}>TikTok</option>
                    <option value="GN" ${c.platform === 'GN' ? 'selected' : ''}>Google</option>
                </select>
            </td>
            <td>${c.channel || '-'}</td>
            <td><strong>${getNichoConEmoji(c.product)}</strong></td>
            <td><code>${c.id}</code></td>
            <td><strong>${c.code}</strong></td> <td>${c.language || '-'}</td>
            <td>${c.country}</td>
            <td><strong>${c.keywords?.length || 0}</strong></td>
            <td style="text-align: center;">${articleIcon}</td>
            <td style="text-align: center;">${urlIcon}</td>
            <td style="text-align: center; font-weight: bold; color: var(--primary);">${c.autor || '-'}</td>
            <td>
                <button class="btn btn-edit" style="padding: 6px 10px;" onclick="editCampaign(${realIndex})">‚úèÔ∏è</button>
                <button class="btn btn-del" style="padding: 6px 10px;" onclick="deleteCampaign(${realIndex})">üóëÔ∏è</button>
                <button class="btn" style="padding: 6px 10px; ${c.observaciones && c.observaciones.trim() ? 'background: #ef4444; color: white;' : 'background: #e5e7eb; color: #666;'}" onclick="verObservacion(${realIndex})" title="${c.observaciones && c.observaciones.trim() ? 'Ver observaci√≥n' : 'Sin observaciones'}">üìå</button>
                <button class="btn" style="padding: 6px 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: 600;" onclick="abrirModalPromptIA(${realIndex})" title="Generar Prompt IA">ü§ñ</button>
            </td>
        </tr>`;
    }).join('');
    updateStats(filtered);
}

function applySort(col) {
    currentSort.order = (currentSort.column === col && currentSort.order === 'asc') ? 'desc' : 'asc';
    currentSort.column = col;
    renderTable();
}

function toggleArticle(i) {
    const c = db.campaigns[i];
    if (c.article) {
        editCampaign(i);
        setTimeout(() => document.getElementById('inArticle').scrollIntoView(), 300);
    }
}

function editCampaign(index) {
    try {
        // Validar que el √≠ndice es v√°lido
        if (index < 0 || index >= db.campaigns.length) {
            console.error('√çndice inv√°lido:', index);
            showNotif('Error: Campa√±a no encontrada', 'danger');
            return;
        }

        editingIndex = index;
        const c = db.campaigns[index];

        // Verificar que la campa√±a existe
        if (!c) {
            console.error('Campa√±a no encontrada en √≠ndice:', index);
            showNotif('Error: Campa√±a no encontrada', 'danger');
            return;
        }

        // Cargar datos con verificaci√≥n de elementos
        const setValueSafe = (id, value) => {
            const elem = document.getElementById(id);
            if (elem) {
                elem.value = value || '';
            } else {
                console.warn(`Elemento ${id} no encontrado`);
            }
        };

        setValueSafe('inPlatform', c.platform);
        setValueSafe('inChannel', c.channel);
        setValueSafe('inProduct', c.product);
        setValueSafe('inId', c.id);
        setValueSafe('inCode', c.code);
        setValueSafe('inLanguage', c.language);
        setValueSafe('inCountry', c.country);
        setValueSafe('inDate', c.date);
        setValueSafe('inAutor', c.autor);
        setValueSafe('inUrl', c.url);
        setValueSafe('inArticle', c.article);

        // Keywords
        const allKeys = c.keywords || [];
        setValueSafe('inKeywords1', allKeys.join('\n'));
        setValueSafe('inKeywords2', c.observaciones);
        setValueSafe('inObservaciones', '');

        // Actualizar UI
        const formTitle = document.getElementById('formTitle');
        if (formTitle) {
            formTitle.textContent = '‚úèÔ∏è Editando: ' + c.code;
        }

        const btnMeta = document.getElementById('btnMetaOnly');
        if (btnMeta) {
            btnMeta.style.display = 'inline-block';
        }

        // Cambiar a la pesta√±a de edici√≥n
        switchTab('tab-add');

        console.log('Campa√±a cargada exitosamente:', c.code);

    } catch (error) {
        console.error('Error en editCampaign:', error);
        showNotif('Error al cargar la campa√±a: ' + error.message, 'danger');
    }
}

function saveCampaign() {
    const platform = document.getElementById('inPlatform').value;
    const product = document.getElementById('inProduct').value;
    const id = document.getElementById('inId').value;
    const code = document.getElementById('inCode').value;
    const country = document.getElementById('inCountry').value.toUpperCase();

    
    // Verificar duplicados solo si es una campa√±a NUEVA (no est√° editando)
    if (editingIndex < 0) {
        const exists = db.campaigns.some(c => c.code === code);
        if (exists) {
            alert('‚õî ERROR: Esta campa√±a YA EXISTE en la base de datos. No se puede guardar duplicada.\n\nRevisa el listado o edita la campa√±a existente.');
            return;
        }
    }

    if (!platform || !product || !id || !code || !country) return alert('‚ö†Ô∏è Faltan datos obligatorios');

    const campaign = {
        platform, 
        channel: document.getElementById('inChannel').value,
        product, id, code, country,
        date: document.getElementById('inDate').value,
        language: document.getElementById('inLanguage').value,
        keywords: document.getElementById('inKeywords1').value.split('\n').map(k=>k.trim()).filter(k=>k),
        observaciones: document.getElementById('inKeywords2').value,
        article: document.getElementById('inArticle').value,
        autor: document.getElementById('inAutor').value,
        url: document.getElementById('inUrl').value,
        updatedAt: new Date().toISOString()
    };

    if (editingIndex >= 0) {
        campaign.firebaseId = db.campaigns[editingIndex].firebaseId;
        db.campaigns[editingIndex] = campaign;
        markAsModified(campaign.code);
    } else {
        db.campaigns.push(campaign);
    }

    renderTable();
    updateStats();
    saveToFirebase(campaign);
    // Mantenerse en el formulario
    setTimeout(() => {
        resetForm();
        showNotif('‚úÖ Campa√±a guardada. Listo para la siguiente.', 'success');
    }, 500);
}

function autoCompleteCampaign() {
    const campaignName = document.getElementById('inCode').value.trim();

    // Verificar si la campa√±a ya existe (para advertencia visual)
    checkDuplicateCampaign(campaignName);

    if (!campaignName) {
        document.getElementById('inPlatform').value = '';
        document.getElementById('inChannel').value = '';
        document.getElementById('inProduct').value = '';
        document.getElementById('inLanguage').value = '';
        document.getElementById('inCountry').value = '';
        document.getElementById('inId').value = '';
        return;
    }
    const parts = campaignName.split('-');
    if (parts.length >= 4) {
        const [platform, channel, product, country] = parts;
        document.getElementById('inPlatform').value = platform || '';
        document.getElementById('inChannel').value = channel || '';
        document.getElementById('inProduct').value = product || '';
        document.getElementById('inCountry').value = country || '';
        const languageSelect = document.getElementById('inLanguage');
        const matchingCampaign = db.campaigns.find(c => c.code === campaignName);
        if (matchingCampaign && matchingCampaign.language) {
            languageSelect.value = matchingCampaign.language;
        }
    }
}



function checkDuplicateCampaign(campaignName) {
    const inCodeField = document.getElementById('inCode');

    if (!campaignName || editingIndex >= 0) {
        inCodeField.style.backgroundColor = '';
        inCodeField.style.borderColor = '';
        inCodeField.style.color = '';
        return false;
    }

    const exists = db.campaigns.some(c => c.code === campaignName);

    if (exists) {
        inCodeField.style.backgroundColor = '#fee';
        inCodeField.style.borderColor = '#f00';
        inCodeField.style.color = '#c00';
        inCodeField.style.fontWeight = 'bold';
        showNotif('‚ö†Ô∏è ATENCI√ìN: Esta campa√±a YA EXISTE', 'error');
        return true;
    } else {
        inCodeField.style.backgroundColor = '#efe';
        inCodeField.style.borderColor = '#0a0';
        inCodeField.style.color = '#060';
        inCodeField.style.fontWeight = 'bold';
        return false;
    }
}

function saveMetadataOnly() {
    if (editingIndex < 0) return;
    const c = db.campaigns[editingIndex];
    c.platform = document.getElementById('inPlatform').value;
    c.channel = document.getElementById('inChannel').value;
    c.product = document.getElementById('inProduct').value;
    c.id = document.getElementById('inId').value;
    c.code = document.getElementById('inCode').value;
    c.country = document.getElementById('inCountry').value.toUpperCase();
    c.date = document.getElementById('inDate').value;
    c.autor = document.getElementById('inAutor').value;
    saveToFirebase(c);
    // Mantenerse en el formulario
    setTimeout(() => {
        resetForm();
        showNotif('‚úÖ Campa√±a guardada. Listo para la siguiente.', 'success');
    }, 500);
}

function deleteCampaign(index) {
    if (confirm('¬øEliminar campa√±a permanentemente de la nube?')) {
        const c = db.campaigns[index];
        if(c.firebaseId) deleteFromFirebase(c.firebaseId);
    }
}

function resetForm() {
    editingIndex = -1;
    document.querySelectorAll('#tab-add input, #tab-add select, #tab-add textarea').forEach(el => el.value = '');
    document.getElementById('formTitle').textContent = '‚ûï Nueva Campa√±a';
    document.getElementById('btnMetaOnly').style.display = 'none';
    const inCodeField = document.getElementById('inCode');
    if (inCodeField) {
        inCodeField.style.backgroundColor = '';
        inCodeField.style.borderColor = '';
        inCodeField.style.color = '';
        inCodeField.style.fontWeight = '';
    }
}

function boldSelectedText() {
    const ta = document.getElementById('inKeywords1') || document.getElementById('inKeywords2');
    if (!ta) return;
    const start = ta.selectionStart;
    const end = ta.selectionEnd;
    if (start === end) return;
    ta.value = ta.value.substring(0, start) + '<b>' + ta.value.substring(start, end) + '</b>' + ta.value.substring(end);
    const newPos = start + '<b>'.length + (end - start) + '</b>'.length;
    ta.focus();
    ta.setSelectionRange(newPos, newPos);
}
function clearAllBoldTags() {
    const ta = document.getElementById('inKeywords1') || document.getElementById('inKeywords2');
    if (!ta) return;
    ta.value = ta.value.replace(/<\/?b>/gi, '');
}

// ===== IMPORTAR (JSON) =====
function importarDatos(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const imported = JSON.parse(e.target.result);
            if (detectarCatalogo(imported)) {
                importarCatalogo(imported);
            } else if (Array.isArray(imported)) {
                if (confirm(`¬øImportar ${imported.length} campa√±as?`)) {
                    let count = 0;
                    imported.forEach(c => { saveToFirebase(c); count++; });
                    showNotif(`‚úÖ ${count} campa√±as importadas`, 'success');
                }
            } else {
                alert('‚ùå Formato no reconocido');
            }
        } catch (err) { alert('‚ùå Error: ' + err.message); console.error(err); }
    };
    reader.readAsText(file);
    event.target.value = '';
}

function detectarCatalogo(data) {
    if (typeof data !== 'object' || Array.isArray(data)) return false;
    for (let key in data) {
        if (Array.isArray(data[key]) && data[key].length > 0) {
            const firstItem = data[key][0];
            if (firstItem && firstItem.code && firstItem.id) return true;
        }
    }
    return false;
}

function importarCatalogo(catalogo) {
    let totalAgregados = 0;
    for (let categoria in catalogo) {
        if (!Array.isArray(catalogo[categoria])) continue;
        if (!db.havCatalog[categoria]) db.havCatalog[categoria] = [];
        catalogo[categoria].forEach(item => {
            if (!item || !item.code || !item.id) return;
            const existe = db.havCatalog[categoria].find(i => i.code === item.code);
            if (!existe) {
                db.havCatalog[categoria].push({
                    code: item.code,
                    id: item.id,
                    platform: item.platform || 'FB'
                });
                if (item.id && !db.ids.includes(item.id)) db.ids.push(item.id);
                totalAgregados++;
            }
        });
    }
    db.ids.sort();
    saveGlobalSettings();
    refreshEverything();
    setTimeout(() => limpiarDuplicadosCatalogo(), 500);
    showNotif(`‚úÖ Cat√°logo: ${totalAgregados} canales agregados`, 'success');
}

// ===== 1. CAT√ÅLOGO HAV (Restaurado a DISE√ëO HERMOSO Y ORDENADO) =====
function renderHAVCatalog() {
    const container = document.getElementById('havCatalogContainer');
    if (!container || !db.havCatalog) return;
    
    let html = '';
    // Colores por defecto para las tarjetas
    const platforms = { 
        'FB': { color: '#1877f2', bg: '#e7f3ff', n: 'üåé Meta' }, 
        'TT': { color: '#fe2c55', bg: '#fff0f3', n: 'üéµ TikTok' }, 
        'GN': { color: '#EA4335', bg: '#fff5f0', n: 'üîç Google' } 
    };

    // ORDEN ESPEC√çFICO: PRIMERO MUNDO META, TIKTOK, GOOGLE
    const orderedKeys = ['MUNDO Meta', 'Mundo TikTok', 'Google Ads'];
    const allKeys = Object.keys(db.havCatalog);
    // Filtrar los que no est√°n en la lista ordenada y agregarlos al final
    const finalOrder = [...orderedKeys, ...allKeys.filter(k => !orderedKeys.includes(k))];

    finalOrder.forEach(groupName => {
        const channels = db.havCatalog[groupName];
        if(!channels || !channels.length) return;
        const plat = channels[0].platform || 'FB';
        const style = platforms[plat] || platforms['FB'];
        
        html += `<div class="hav-platform-card" style="border-left-color: ${style.color}; background: ${style.bg}">
            <h3 style="color:${style.color}">${groupName}</h3>
            <div class="hav-channels-list">
                ${channels.map((ch, idx) => `
                <div class="hav-channel-item">
                    <div class="hav-channel-info">
                        <div class="hav-channel-name">${ch.code}</div>
                        <div class="hav-channel-id">${ch.id}</div>
                    </div>
                    <div class="hav-btn-group">
                        <button class="btn-mini btn-copy-mini" onclick="navigator.clipboard.writeText('${ch.code} | ${ch.id}');showNotif('Copiado','success')">üìã</button>
                        <button class="btn-mini btn-edit-mini" onclick="editHAVChannel('${groupName}', ${idx})">‚úèÔ∏è</button>
                        <button class="btn-mini btn-del-mini" onclick="deleteHAVChannel('${groupName}', ${idx})">üóëÔ∏è</button>
                    </div>
                </div>`).join('')}
            </div>
        </div>`;
    });
    container.innerHTML = html;
}

function addNewHAVChannel() {
    currentEditingChannel = null;
    document.getElementById('modalPlatform').value = 'FB';
    document.getElementById('modalChannelName').value = '';
    document.getElementById('modalChannelId').value = '';
    document.getElementById('modalChannelGroup').value = 'MUNDO Meta';
    document.getElementById('editChannelModal').classList.add('active');
}

function saveChannelEdit() {
    const plat = document.getElementById('modalPlatform').value;
    const name = document.getElementById('modalChannelName').value;
    const id = document.getElementById('modalChannelId').value;
    const group = document.getElementById('modalChannelGroup').value;
    
    if(!name || !id || !group) return alert('Completa todo');
    
    const code = `${plat}-HAV-${name}`;
    
    if (currentEditingChannel) {
        const oldGroup = currentEditingChannel.group;
        db.havCatalog[oldGroup].splice(currentEditingChannel.index, 1);
        if(db.havCatalog[oldGroup].length === 0) delete db.havCatalog[oldGroup];
    }
    
    if (!db.havCatalog[group]) db.havCatalog[group] = [];
    db.havCatalog[group].push({ code, id, platform: plat });
    
    saveGlobalSettings();
    closeChannelModal();
}

function deleteHAVChannel(group, index) {
    if(confirm('¬øEliminar canal?')) {
        db.havCatalog[group].splice(index, 1);
        if(db.havCatalog[group].length===0) delete db.havCatalog[group];
        saveGlobalSettings();
    }
}

function editHAVChannel(group, index) {
    currentEditingChannel = { group, index };
    const ch = db.havCatalog[group][index];
    document.getElementById('modalPlatform').value = ch.platform;
    document.getElementById('modalChannelName').value = ch.code.split('-HAV-')[1] || '';
    document.getElementById('modalChannelId').value = ch.id;
    document.getElementById('modalChannelGroup').value = group;
    document.getElementById('editChannelModal').classList.add('active');
}

function closeChannelModal() { document.getElementById('editChannelModal').classList.remove('active'); }

function showNotif(msg, type) {
    const n = document.createElement('div');
    n.textContent = msg;
    n.style.cssText = `position:fixed;bottom:20px;right:20px;background:${type==='success'?'#10b981':'#ef4444'};color:white;padding:15px;border-radius:8px;z-index:9999;box-shadow:0 4px 12px rgba(0,0,0,0.2)`;
    document.body.appendChild(n);
    setTimeout(()=>n.remove(), 2500);
}

// ===== COMPARADOR =====
function updateCompSelects() {
    const campaignMap = new Map();
    db.campaigns.forEach((c, i) => {
        campaignMap.set(c.code, i);
    });

    ['comp1', 'comp2', 'comp3'].forEach(id => {
        const datalist = document.getElementById(id + '-list');
        const sortedCampaigns = db.campaigns
            .map((c, i) => ({ name: c.code, index: i }))
            .sort((a, b) => a.name.localeCompare(b.name));

        datalist.innerHTML = sortedCampaigns
            .map(c => `<option value="${c.name}">${c.name}</option>`)
            .join('');
    });

    window.campaignMap = campaignMap;
}

function runTripleComparison() {
    const v1 = document.getElementById('comp1').value;
    const v2 = document.getElementById('comp2').value;
    const v3 = document.getElementById('comp3').value;

    const values = [v1, v2, v3].filter(v => v && v.trim() !== '');

    if (values.length === 0) {
        document.getElementById('compResults').innerHTML = '';
        return;
    }

    const campaigns = [];
    for (const val of values) {
        const idx = window.campaignMap.get(val);
        if (idx !== undefined) {
            campaigns.push(db.campaigns[idx]);
        }
    }

    if (campaigns.length === 0) {
        document.getElementById('compResults').innerHTML = '<div style="color: #ef4444; padding: 20px; text-align: center; grid-column: 1/-1;">‚ö†Ô∏è Selecciona al menos una campa√±a v√°lida</div>';
        return;
    }

    const resultsDiv = document.getElementById('compResults');
    resultsDiv.style.gridTemplateColumns = `repeat(${campaigns.length}, 1fr)`;

    resultsDiv.innerHTML = campaigns.map(c => `
        <div class="comp-card">
            <h3>${c.code}</h3>
            <div class="metric"><strong>Pa√≠s:</strong><span>${c.country}</span></div>
            <div class="metric"><strong>ID:</strong><span>${c.id}</span></div>
            <div class="metric"><strong>Keywords:</strong><span>${c.keywords.length}</span></div>
            <div class="keyword-list">${c.keywords.map(k=>`<div class="keyword-item">${k}</div>`).join('')}</div>
        </div>`).join('');
}

function clearComparison() {
    document.getElementById('comp1').value = '';
    document.getElementById('comp2').value = '';
    document.getElementById('comp3').value = '';
    document.getElementById('compResults').innerHTML = '';
}


// ===== AUTO-COMPLETAR DESDE CAT√ÅLOGO HAV =====
function autoCompleteFromHAV() {
    const nombreCampana = document.getElementById('inCode').value.trim();

    if (nombreCampana.length < 5) return; // Esperar a que escriba algo significativo

    // Parsear: FB-HAV-Autos-AE -> Platform, Canal, Nicho
    const partes = nombreCampana.split('-');
    if (partes.length < 3) return;

    const plataforma = partes[0]; // FB, TT, GN
    const nicho = partes[2];       // Autos, Celulares, Iphone, etc.

    console.log('üîç Buscando en cat√°logo:', { plataforma, nicho });

    // Buscar en el cat√°logo HAV
    let idEncontrado = null;
    let nichoEncontrado = null;

    // Recorrer todos los grupos del cat√°logo
    for (let grupo in db.havCatalog) {
        const canales = db.havCatalog[grupo];
        if (!canales || !Array.isArray(canales)) continue;

        for (let canal of canales) {
            // Verificar si el canal coincide con plataforma y nicho
            // Ejemplo: canal.code = "FB-HAV-Autos", canal.id = "00901", canal.platform = "FB"
            if (canal.platform === plataforma && canal.code.includes(nicho)) {
                idEncontrado = canal.id;
                nichoEncontrado = nicho;
                console.log('‚úÖ Encontrado:', canal);
                break;
            }
        }

        if (idEncontrado) break;
    }

    // Auto-completar NICHO
    if (nichoEncontrado) {
        const selectNicho = document.getElementById('inProduct');

        // Buscar el nicho exacto en el dropdown
        for (let i = 0; i < selectNicho.options.length; i++) {
            const opcion = selectNicho.options[i].value;

            // Coincidencia exacta o parcial
            if (opcion === nichoEncontrado || 
                opcion.toLowerCase().includes(nichoEncontrado.toLowerCase()) ||
                nichoEncontrado.toLowerCase().includes(opcion.toLowerCase())) {
                selectNicho.value = opcion;
                console.log('‚úÖ Nicho seleccionado:', opcion);
                break;
            }
        }
    }

    // Auto-completar ID
    if (idEncontrado) {
        // Si el ID no est√° en la lista, agregarlo
        if (!db.ids.includes(idEncontrado)) {
            console.log('‚ûï Agregando nuevo ID:', idEncontrado);
            db.ids.push(idEncontrado);
            db.ids.sort();
            saveGlobalSettings();

            // Refrescar los dropdowns
            updateOptions();
        }

        // Seleccionar el ID
        setTimeout(() => {
            document.getElementById('inId').value = idEncontrado;
            console.log('‚úÖ ID seleccionado:', idEncontrado);
        }, 100);
    }
}


// ========================================================================
// SISTEMA DE AUTENTICACI√ìN Y SEGURIDAD
// ========================================================================

const USUARIOS_AUTORIZADOS = {
    'haevedecano83': 'gestor2026**./',
    'amelemery': 'gestor2026**./'
};

function handleLogin(event) {
    event.preventDefault();

    const usuario = document.getElementById('loginUser').value.trim();
    const password = document.getElementById('loginPass').value;

    // Validar credenciales
    if (USUARIOS_AUTORIZADOS[usuario] && USUARIOS_AUTORIZADOS[usuario] === password) {
        // Login exitoso
        const timestamp = Date.now();
        localStorage.setItem('gestorHAV_auth', btoa(usuario + ':' + timestamp));
        localStorage.setItem('gestorHAV_user', usuario);
        localStorage.setItem('gestorHAV_loginTime', timestamp);

        showApp();
        console.log('‚úÖ Acceso autorizado:', usuario);
    } else {
        // Login fallido
        document.getElementById('loginError').classList.add('show');
        document.getElementById('loginPass').value = '';

        setTimeout(() => {
            document.getElementById('loginError').classList.remove('show');
        }, 3000);

        console.warn('‚ö†Ô∏è Intento de acceso denegado');
    }

    return false;
}

function showApp() {
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('mainApp').classList.add('show');
    document.getElementById('logoutBtn').style.display = 'block';

    const usuario = localStorage.getItem('gestorHAV_user');
    const loginTime = localStorage.getItem('gestorHAV_loginTime');

    console.log('üë§ Usuario activo:', usuario);
    console.log('üïê Sesi√≥n iniciada:', new Date(parseInt(loginTime)).toLocaleString());
}

function logout() {
    if (confirm('¬øCerrar sesi√≥n y salir del gestor?')) {
        localStorage.removeItem('gestorHAV_auth');
        localStorage.removeItem('gestorHAV_user');
        localStorage.removeItem('gestorHAV_loginTime');

        console.log('üö™ Sesi√≥n cerrada');
        location.reload();
    }
}

function checkSession() {
    const auth = localStorage.getItem('gestorHAV_auth');
    const usuario = localStorage.getItem('gestorHAV_user');
    const loginTime = localStorage.getItem('gestorHAV_loginTime');

    // Verificar si existe sesi√≥n v√°lida
    if (auth && usuario && loginTime && USUARIOS_AUTORIZADOS[usuario]) {
        // Verificar que la sesi√≥n no tenga m√°s de 7 d√≠as (opcional)
        const diasTranscurridos = (Date.now() - parseInt(loginTime)) / (1000 * 60 * 60 * 24);

        if (diasTranscurridos < 7) {
            // Sesi√≥n v√°lida - mostrar app directamente
            showApp();
            console.log('‚úÖ Sesi√≥n activa restaurada:', usuario);
        } else {
            // Sesi√≥n expirada
            logout();
            console.log('‚è∞ Sesi√≥n expirada - Requiere nuevo login');
        }
    } else {
        // No hay sesi√≥n - mostrar login
        document.getElementById('loginScreen').classList.remove('hidden');
        console.log('üîí Gestor protegido - Login requerido');
    }
}

// Verificar sesi√≥n autom√°ticamente al cargar
document.addEventListener('DOMContentLoaded', function() {
    checkSession();
});

// Tambi√©n verificar al cargar el script
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', checkSession);
} else {
    checkSession();
}

// ========================================================================
// FIN SISTEMA DE AUTENTICACI√ìN
// ========================================================================



// FUNCIONES DE ESTAD√çSTICAS INTERACTIVAS
let articleFilterActive = false;

function showKeywordAnalysis() {
    const totalCamps = db.campaigns.length;
    if (totalCamps === 0) {
        alert('No hay campa√±as para analizar');
        return;
    }

    const totalKeys = db.campaigns.reduce((sum, c) => sum + (c.keywords?.length || 0), 0);
    const avgKeys = Math.round(totalKeys / totalCamps);

    let maxCamp = db.campaigns[0];
    let minCamp = db.campaigns[0];

    db.campaigns.forEach(c => {
        const keysCount = c.keywords?.length || 0;
        if (keysCount > (maxCamp.keywords?.length || 0)) maxCamp = c;
        if (keysCount < (minCamp.keywords?.length || 0)) minCamp = c;
    });

    const above = db.campaigns.filter(c => (c.keywords?.length || 0) > avgKeys);
    const below = db.campaigns.filter(c => (c.keywords?.length || 0) < avgKeys);

    let html = '<div class="analysis-metric"><strong>üìä Promedio actual:</strong> ' + avgKeys + ' keywords/campa√±a</div>';

    html += '<div class="analysis-metric"><strong>üèÜ Campa√±a con M√ÅS keywords:</strong><br>';
    html += maxCamp.code + ' (' + maxCamp.country + ') ‚Üí <span style="color: var(--success); font-weight: bold;">' + (maxCamp.keywords?.length || 0) + ' keywords</span></div>';

    html += '<div class="analysis-metric"><strong>‚ö†Ô∏è Campa√±a con MENOS keywords:</strong><br>';
    html += minCamp.code + ' (' + minCamp.country + ') ‚Üí <span style="color: var(--danger); font-weight: bold;">' + (minCamp.keywords?.length || 0) + ' keywords</span></div>';

    html += '<div class="analysis-section"><h4 style="color: var(--success);">üü¢ Por ENCIMA del promedio (' + avgKeys + '+): ' + above.length + ' campa√±as</h4>';
    above.slice(0, 5).forEach(c => {
        html += '<div class="campaign-item above"><strong>' + c.code + '</strong> (' + c.country + ') ‚Üí ' + (c.keywords?.length || 0) + ' keywords</div>';
    });
    if (above.length > 5) {
        html += '<div style="text-align: center; color: #666; margin-top: 10px;">... y ' + (above.length - 5) + ' m√°s</div>';
    }
    html += '</div>';

    html += '<div class="analysis-section"><h4 style="color: var(--danger);">üî¥ Por DEBAJO del promedio (<' + avgKeys + '): ' + below.length + ' campa√±as</h4>';
    below.slice(0, 5).forEach(c => {
        html += '<div class="campaign-item below"><strong>' + c.code + '</strong> (' + c.country + ') ‚Üí ' + (c.keywords?.length || 0) + ' keywords ‚ö†Ô∏è</div>';
    });
    if (below.length > 5) {
        html += '<div style="text-align: center; color: #666; margin-top: 10px;">... y ' + (below.length - 5) + ' m√°s</div>';
    }
    html += '</div>';

    if (below.length > 0) {
        html += '<div class="analysis-metric" style="background: #fff3cd; border-left: 4px solid var(--warning);"><strong>üí° Sugerencia:</strong> ' + below.length + ' ' + (below.length === 1 ? 'campa√±a necesita' : 'campa√±as necesitan') + ' m√°s keywords.</div>';
    }

    document.getElementById('analysisBody').innerHTML = html;
    document.getElementById('analysisModal').classList.add('active');
}

function closeAnalysisModal() {
    document.getElementById('analysisModal').classList.remove('active');
}

function filterByArticleStatus() {
    if (!articleFilterActive) {
        const withoutArticle = db.campaigns.filter(c => !c.article || !c.article.trim());

        if (withoutArticle.length === 0) {
            showNotif('‚úÖ Todas las campa√±as tienen art√≠culo', 'success');
            return;
        }

        articleFilterActive = true;
        showNotif('‚ö†Ô∏è Mostrando ' + withoutArticle.length + ' campa√±as SIN art√≠culo', 'warning');
        renderTableFiltered(withoutArticle);
    } else {
        articleFilterActive = false;
        showNotif('‚úÖ Mostrando todas las campa√±as', 'success');
        renderTable();
    }
}

function renderTableFiltered(campaigns) {
    const tbody = document.getElementById('campaignList');
    tbody.innerHTML = campaigns.map(c => {
        const realIndex = db.campaigns.indexOf(c);
        const hasArticle = c.article && c.article.trim();
        const articleIcon = hasArticle ? 
            '<span class="article-indicator has-article" onclick="toggleArticle(' + realIndex + ')">‚úÖ</span>' : 
            '<span class="article-indicator no-article">‚ùå</span>';

        const hasUrl = (c.url && String(c.url).trim().length > 0);
        const urlClass = hasUrl ? 'url-active' : 'url-inactive';
        const urlIcon = hasUrl ?
            '<a href="' + c.url + '" target="_blank" class="' + urlClass + '" title="Ir a: ' + c.url + '">üîó</a>' :
            '<span class="' + urlClass + '" title="Sin Link">üîó</span>';

        return '<tr style="background: #fff3cd;"><td>' + (c.date || '-') + '</td><td><select class="platform-select" onchange="updateCampPlatform(' + realIndex + ', this.value)"><option value="FB" ' + (c.platform === 'FB' ? 'selected' : '') + '>Facebook</option><option value="TT" ' + (c.platform === 'TT' ? 'selected' : '') + '>TikTok</option><option value="GN" ' + (c.platform === 'GN' ? 'selected' : '') + '>Google</option></select></td><td>' + (c.channel || '-') + '</td><td><strong>' + getNichoConEmoji(c.product) + '</strong></td><td><code>' + c.id + '</code></td><td><strong>' + c.code + '</strong></td><td>' + (c.language || '-') + '</td><td>' + c.country + '</td><td><strong>' + (c.keywords?.length || 0) + '</strong></td><td style="text-align: center;">' + articleIcon + '</td><td style="text-align: center;">' + urlIcon + '</td><td style="text-align: center; font-weight: bold; color: var(--primary);">' + (c.autor || '-') + '</td><td><button class="btn btn-edit" style="padding: 6px 10px;" onclick="editCampaign(' + realIndex + ')">‚úèÔ∏è</button><button class="btn btn-del" style="padding: 6px 10px;" onclick="deleteCampaign(' + realIndex + ')">üóëÔ∏è</button><button class="btn" style="padding: 6px 10px; ' + (c.observaciones && c.observaciones.trim() ? 'background: #ef4444; color: white;' : 'background: #e5e7eb; color: #666;') + '" onclick="verObservacion(' + realIndex + ')">üìå</button></td></tr>';
    }).join('');
}


window.onload = function() {
    startRealtimeSync();

    // Listener para auto-completar al escribir nombre de campa√±a
    const campoNombre = document.getElementById('inCode');
    if (campoNombre) {
        campoNombre.addEventListener('input', autoCompleteFromHAV);
        console.log('‚úÖ Auto-completado activado');
    }
    document.getElementById('inProduct').addEventListener('change', function() {});
    document.getElementById('editChannelModal').addEventListener('click', function(e) {
        if (e.target === this) closeChannelModal();
    });
};

// FUNCI√ìN PARA MOSTRAR/OCULTAR OBSERVACIONES
function toggleObservaciones() {
    const container = document.getElementById('obsContainer');
    if (container) {
        container.style.display = container.style.display === 'none' ? 'block' : 'none';
    }
}

// FUNCI√ìN PARA VER OBSERVACI√ìN DESDE LA TABLA
function verObservacion(index) {
    const c = db.campaigns[index];
    if (c.observaciones && c.observaciones.trim()) {
        alert('üìå Observaci√≥n de campa√±a ' + c.code + ':\n\n' + c.observaciones);
    } else {
        alert('Esta campa√±a no tiene observaciones.');
    }
}


async function generarReporte() {
        if (!db.campaigns.length) return alert('No hay campa√±as');

        function extraerTitulo(article) {
            if (!article) return 'Sin t√≠tulo';
            const p = article.indexOf('<p>');
            let t = (p!==-1 ? article.substring(0,p) : article).split('\n')[0].trim();
            return t.replace(/^#+\s*/g,'').replace(/\*\*/g,'').replace(/\*/g,'').replace(/<\/?b>/gi,'').replace(/<\/?strong>/gi,'').trim() || 'Sin t√≠tulo';
        }

        const fs = (document.getElementById('search')?.value || '').toLowerCase();
        const pF = document.getElementById('filterPlatform')?.value || '';
        const prF = document.getElementById('filterProduct')?.value || '';
        const idF = document.getElementById('filterId')?.value || '';
        const chF = document.getElementById('filterChannel')?.value || '';

        const camps = db.campaigns.filter(c => 
            (c.code.toLowerCase().includes(fs) || c.id.includes(fs) || c.country.toLowerCase().includes(fs)) &&
            (!pF || c.platform === pF) && 
            (!prF || c.product === prF) && 
            (!idF || c.id === idF) &&
            (!chF || chF === 'Todos' || c.channel === chF)
        );

        if (!camps.length) return alert('No hay campa√±as visibles');

        const totalKeys = camps.reduce((sum, c) => {
            let filteredKeys = c.keywords || [];

            // FILTRO MEJORADO: Buscar l√≠nea vac√≠a O palabras clave de cajitas
            if (filteredKeys.length > 0) {
                // 1. Primero buscar l√≠nea vac√≠a
                let cutIndex = filteredKeys.findIndex(k => !k || k.trim() === '');

                // 2. Si no hay l√≠nea vac√≠a, buscar keywords de tipo "Cajita"
                if (cutIndex === -1) {
                    cutIndex = filteredKeys.findIndex(k => 
                        k && (
                            k.trim().toLowerCase() === 'cajita' ||
                            k.trim().toLowerCase().startsWith('how to') ||
                            k.trim().toLowerCase().startsWith('what is') ||
                            k.trim().toLowerCase().startsWith('best ') ||
                            k.trim().toLowerCase().startsWith('top ') ||
                            /^[A-Z][a-z]+\s+(to|is|are|can|will|for)\s+/i.test(k.trim())
                        )
                    );
                }

                // 3. Cortar en el √≠ndice encontrado
                if (cutIndex !== -1) {
                    filteredKeys = filteredKeys.slice(0, cutIndex);
                }
            }

            return sum + filteredKeys.length;
        }, 0);

        const avgKeys = camps.length > 0 ? Math.round(totalKeys / camps.length) : 0;

        // CSS MEJORADO
        let html = `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte HAV 2026</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; }
        .container { max-width: 1600px; margin: 0 auto; background: white; border-radius: 15px; padding: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
        .header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #667eea; }
        .header h1 { color: #667eea; font-size: 2.5em; margin-bottom: 10px; }
        .header p { color: #666; font-size: 1.1em; }
        .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 12px; text-align: center; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); }
        .stat-card .number { font-size: 3em; font-weight: bold; margin-bottom: 5px; }
        .stat-card .label { font-size: 1.1em; opacity: 0.9; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9em; }
        thead { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; position: sticky; top: 0; z-index: 10; }
        th { padding: 12px 8px; text-align: left; font-weight: 600; font-size: 0.85em; border-right: 1px solid rgba(255,255,255,0.2); }
        th:last-child { border-right: none; }

        /* ANCHOS OPTIMIZADOS */
        th:nth-child(1), td:nth-child(1) { width: 35px; text-align: center; }
        th:nth-child(2), td:nth-child(2) { width: 80px; }
        th:nth-child(3), td:nth-child(3) { width: 70px; }
        th:nth-child(4), td:nth-child(4) { width: 50px; }
        th:nth-child(5), td:nth-child(5) { width: 90px; }
        th:nth-child(6), td:nth-child(6) { width: 60px; }
        th:nth-child(7), td:nth-child(7) { width: 50px; }
        th:nth-child(8), td:nth-child(8) { width: 70px; }
        th:nth-child(9), td:nth-child(9) { width: 200px; }
        th:nth-child(10), td:nth-child(10) { width: 40px; text-align: center; }
        th:nth-child(11), td:nth-child(11) { width: auto; min-width: 300px; }

        td { padding: 10px 8px; border-bottom: 1px solid #e5e7eb; vertical-align: top; }
        tr:hover { background-color: #f9fafb; }

        .keywords-list { display: flex; flex-wrap: wrap; gap: 6px; line-height: 1.6; }
        .keyword-item { 
            background: #e0e7ff; 
            color: #4338ca; 
            padding: 4px 10px; 
            border-radius: 6px; 
            font-size: 0.85em;
            font-weight: 500;
            display: inline-block;
            white-space: nowrap;
        }

        .platform-badge { padding: 4px 10px; border-radius: 6px; font-weight: 600; font-size: 0.8em; display: inline-block; }
        .platform-FB { background: #e7f3ff; color: #1877f2; }
        .platform-TT { background: #fff0f3; color: #fe2c55; }
        .platform-GN { background: #fff5f0; color: #EA4335; }

        @media print {
            body { background: white; padding: 0; }
            .container { box-shadow: none; }
            thead { background: #667eea !important; }
            @page { margin: 1cm; size: landscape; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Reporte de Campa√±as HAV 2026</h1>
            <p><strong>Fecha de generaci√≥n:</strong> ${new Date().toLocaleDateString('es-ES')} ${new Date().toLocaleTimeString('es-ES')}</p>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="number">${camps.length}</div>
                <div class="label">Campa√±as</div>
            </div>
            <div class="stat-card">
                <div class="number">${totalKeys}</div>
                <div class="label">Keywords Totales</div>
            </div>
            <div class="stat-card">
                <div class="number">${avgKeys}</div>
                <div class="label">Promedio Keywords</div>
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>Fecha</th>
                    <th>Plataforma</th>
                    <th>Canal</th>
                    <th>Nicho</th>
                    <th>ID</th>
                    <th>Pa√≠s</th>
                    <th>Idioma</th>
                    <th>Nombre de Campa√±a</th>
                    <th>Keys</th>
                    <th>Keywords</th>
                </tr>
            </thead>
            <tbody>`;

        camps.forEach((c, i) => {
            // FILTRO MEJORADO DE KEYWORDS
            let filteredKeywords = c.keywords || [];

            if (filteredKeywords.length > 0) {
                // 1. Primero buscar l√≠nea vac√≠a
                let cutIndex = filteredKeywords.findIndex(k => !k || k.trim() === '');

                // 2. Si no hay l√≠nea vac√≠a, buscar keywords de tipo "Cajita"
                if (cutIndex === -1) {
                    cutIndex = filteredKeywords.findIndex(k => 
                        k && (
                            k.trim().toLowerCase() === 'cajita' ||
                            k.trim().toLowerCase().startsWith('how to') ||
                            k.trim().toLowerCase().startsWith('what is') ||
                            k.trim().toLowerCase().startsWith('best ') ||
                            k.trim().toLowerCase().startsWith('top ') ||
                            /^[A-Z][a-z]+\s+(to|is|are|can|will|for)\s+/i.test(k.trim())
                        )
                    );
                }

                // 3. Cortar en el √≠ndice encontrado
                if (cutIndex !== -1) {
                    filteredKeywords = filteredKeywords.slice(0, cutIndex);
                }
            }

            const keywordsHTML = filteredKeywords.length > 0
                ? `<div class="keywords-list">${filteredKeywords.map(k => `<span class="keyword-item">${k}</span>`).join('')}</div>`
                : '<em style="color:#999">Sin keywords</em>';

            const platformName = c.platform === 'FB' ? 'Facebook' : c.platform === 'TT' ? 'TikTok' : c.platform === 'GN' ? 'Google' : c.platform;

            html += `
                <tr>
                    <td style="text-align:center; font-weight:bold; color:#667eea;">${i + 1}</td>
                    <td>${c.date ? c.date.split('-').reverse().join('/') : '-'}</td>
                    <td><span class="platform-badge platform-${c.platform}">${platformName}</span></td>
                    <td>${c.channel || '-'}</td>
                    <td><strong>${c.product || '-'}</strong></td>
                    <td><code>${c.id || '-'}</code></td>
                    <td><strong>${c.country || '-'}</strong></td>
                    <td>${c.language || '-'}</td>
                    <td><strong>${c.code || '-'}</strong></td>
                    <td style="text-align:center; font-weight:bold; color:#667eea;">${filteredKeywords.length}</td>
                    <td>${keywordsHTML}</td>
                </tr>`;
        });

        html += `
            </tbody>
        </table>
    </div>
</body>
</html>`;

        const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `reporte-campanas-${new Date().toISOString().slice(0, 10)}.html`;
        link.click();
        URL.revokeObjectURL(url);

        showNotif(`‚úì Reporte HTML generado con ${camps.length} campa√±as`, 'success');
    }

    function generarReporteExcel() {
        if (!db.campaigns.length) {
            return alert("No hay campa√±as para generar reporte.");
        }

        // Funci√≥n para extraer el t√≠tulo del art√≠culo
        function extraerTitulo(article) {
            if (!article) return 'Sin t√≠tulo';
            const p = article.indexOf('<p>');
            let t = (p!==-1 ? article.substring(0,p) : article).split('\n')[0].trim();
            return t.replace(/^#+\s*/g,'').replace(/\*\*/g,'').replace(/\*/g,'').replace(/<\/?b>/gi,'').replace(/<\/?strong>/gi,'').trim() || 'Sin t√≠tulo';
        }

        // Obtener filtros actuales - MISMA L√ìGICA QUE renderTable()
        const q = document.getElementById('search').value.toLowerCase();
        const pF = document.getElementById('filterPlatform').value;
        const prF = document.getElementById('filterProduct').value;
        const idF = document.getElementById('filterId').value;
        const chF = document.getElementById('filterChannel').value;

        // Filtrar campa√±as - EXACTAMENTE IGUAL QUE renderTable()
        const camps = db.campaigns.filter(c => 
            (c.code.toLowerCase().includes(q) || c.id.includes(q) || c.country.toLowerCase().includes(q)) &&
            (!pF || c.platform === pF) && 
            (!prF || c.product === prF) && 
            (!idF || c.id === idF) &&
            (!chF || chF === 'Todos' || c.channel === chF)
        );

        if (!camps.length) {
            return alert("No hay campa√±as visibles con los filtros aplicados.");
        }

        // Generar nombre del archivo seg√∫n filtros
        let nom = "reporte";
        if (chF && chF!=="Todos") nom += "-"+chF;
        if (prF) nom += "-"+prF;
        if (pF) nom += "-"+pF;
        if (idF) nom += "-ID"+idF;
        if (q) nom += "-"+q;
        if (nom==="reporte") nom="reporte-completo";

        // Generar HTML Excel SIN columna de keywords
        let h = '<html xmlns:x="urn:schemas-microsoft-com:office:excel"><head><meta charset="UTF-8"><style>table{border-collapse:collapse}th{background:#4472C4;color:white;font-weight:bold;border:1px solid black;padding:8px}td{border:1px solid black;padding:8px}</style></head><body><table><tr><th>No</th><th>T√çTULO</th><th>PA√çS</th><th>ETIQUETA</th><th>FECHA</th></tr>';

        camps.forEach((c,i) => {
            const f = c.date ? c.date.split('-').reverse().join('/') : 'Sin fecha';
            h += `<tr><td>${i+1}</td><td>${extraerTitulo(c.article)}</td><td>${c.country||'NA'}</td><td>${c.code}</td><td>${f}</td></tr>`;
        });

        h += '</table></body></html>';

        // Descargar como .xls
        const blob = new Blob([h], {type:'application/vnd.ms-excel;charset=utf-8'});
        const url = URL.createObjectURL(blob);
        const lnk = document.createElement('a');
        lnk.href = url;
        lnk.download = `${nom}-${new Date().toISOString().slice(0,10)}.xls`;
        document.body.appendChild(lnk);
        lnk.click();
        document.body.removeChild(lnk);
        URL.revokeObjectURL(url);

        showNotif(`‚úì ${camps.length} campa√±as exportadas a Excel (sin keywords)`, 'success');
    }



// ===== SISTEMA DE TRACKING CON PERSISTENCIA =====
function loadModifiedFromStorage() {
    const stored = localStorage.getItem('modifiedCampaigns');
    if (stored) {
        try {
            const obj = JSON.parse(stored);
            window.modifiedCampaigns = new Map(Object.entries(obj));
        } catch (e) {
            window.modifiedCampaigns = new Map();
        }
    } else {
        window.modifiedCampaigns = new Map();
    }
    cleanExpiredModifications();
    updateModifiedCount();
}

function saveModifiedToStorage() {
    const obj = Object.fromEntries(window.modifiedCampaigns);
    localStorage.setItem('modifiedCampaigns', JSON.stringify(obj));
}

if (!window.modifiedCampaigns) {
    loadModifiedFromStorage();
}

function markAsModified(campaignCode) {
    window.modifiedCampaigns.set(campaignCode, Date.now());
    saveModifiedToStorage();
    updateModifiedCount();
}

function cleanExpiredModifications() {
    const SIETE_DIAS = 7 * 24 * 60 * 60 * 1000;
    const ahora = Date.now();
    for (let [code, timestamp] of window.modifiedCampaigns) {
        if (ahora - timestamp > SIETE_DIAS) {
            window.modifiedCampaigns.delete(code);
        }
    }
    saveModifiedToStorage();
}

function updateModifiedCount() {
    cleanExpiredModifications();
    const count = window.modifiedCampaigns.size;
    const btn = document.getElementById('btnShowModified');
    if (btn) {
        btn.textContent = `üìù Modificadas (${count})`;
    }
}

function showModifiedCampaigns() {
    // 1. Verificar si hay datos
    if (!window.modifiedCampaigns || window.modifiedCampaigns.size === 0) {
        showNotif('‚ö†Ô∏è No hay campa√±as modificadas recientes.', 'error');
        return;
    }

    // 2. Limpiar filtros para mostrar TODO antes de filtrar visualmente
    document.getElementById('search').value = '';
    document.getElementById('filterPlatform').value = '';
    document.getElementById('filterProduct').value = '';
    document.getElementById('filterId').value = '';
    document.getElementById('filterChannel').value = 'Todos';

    // 3. Cambiar a la pesta√±a de lista y forzar renderizado completo
    switchTab('tab-list');
    renderTable();

    // 4. Obtener el tbody usando el ID CORRECTO
    const tbody = document.getElementById('campaignList');
    
    if (!tbody) {
        console.error("Error cr√≠tico: No se encuentra el elemento con ID 'campaignList'");
        return;
    }

    // 5. Filtrar las filas visualmente
    const allRows = tbody.querySelectorAll('tr');
    let visibleCount = 0;

    allRows.forEach((row) => {
        const codeCell = row.cells[5]; 
        
        if (codeCell) {
            const codeText = codeCell.textContent.trim();
            
            if (window.modifiedCampaigns.has(codeText)) {
                row.style.display = ''; // Mostrar
                row.style.backgroundColor = '#fef3c7'; // Resaltar en amarillo
                visibleCount++;
            } else {
                row.style.display = 'none'; // Ocultar
            }
        }
    });

    if (visibleCount > 0) {
        showNotif(`‚úÖ Mostrando ${visibleCount} campa√±as modificadas`, 'success');
    } else {
        showNotif('‚ö†Ô∏è Error inesperado al mostrar modificadas.', 'warning');
    }
}

function clearModifiedHistory() {
    if (window.modifiedCampaigns.size === 0) {
        showNotif('No hay campa√±as modificadas para limpiar', 'info');
        return;
    }
    if (confirm('¬øSeguro que quieres limpiar el historial de campa√±as modificadas?\n\nEsta acci√≥n no se puede deshacer.')) {
        window.modifiedCampaigns.clear();
        saveModifiedToStorage();
        updateModifiedCount();
        showNotif('‚úÖ Historial de modificadas limpiado', 'success');
    }
}

// ===== ATAJOS DE TECLADO =====
document.addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        saveToCloud();
        showNotif('üíæ Guardando con Ctrl+S...', 'success');
    }

    if ((e.ctrlKey || e.metaKey) && e.key === 'g') {
        e.preventDefault();
        saveToCloud();
        showNotif('üíæ Guardando con Ctrl+G...', 'success');
    }
});

document.addEventListener('DOMContentLoaded', function() {
    loadModifiedFromStorage();
});


// ===== VENTANAS EMERGENTES =====
function openTabInWindow(tabId) {
    const tabNames = {
        'tab-list': 'üìã Lista de Campa√±as',
        'tab-comp': 'üî¨ Comparador',
        'tab-add': '‚ûï Gestionar Campa√±a',
        'tab-config': '‚öôÔ∏è Configuraci√≥n',
        'tab-catalog': 'üì° Cat√°logo HAV',
        'tab-analysis': 'üìä An√°lisis'
    };

    const tabName = tabNames[tabId] || 'Ventana';

    // Abrir el MISMO gestor completo (popup 100% funcional)
    const baseUrl = window.location.href.split('#')[0];
    const url = baseUrl + '#' + tabId;

    const popupWindow = window.open(url, '_blank', 'width=1400,height=900,menubar=no,toolbar=no,location=no,status=no');

    if (!popupWindow) {
        showNotif('No se pudo abrir la ventana. Permite ventanas emergentes.', 'error');
        return;
    }

    showNotif('‚úÖ ' + tabName + ' abierto en nueva ventana', 'success');
}


// Cargar modificadas al inicio
if (typeof document !== 'undefined') {
    document.addEventListener('DOMContentLoaded', function() {
        loadModifiedFromStorage();
    });
}

</script>


    <div id="analysisModal" class="analysis-modal" onclick="if(event.target === this) closeAnalysisModal()">
        <div class="analysis-content">
            <div class="analysis-header">üìä An√°lisis Detallado de Keywords</div>
            <div id="analysisBody"></div>
            <div style="margin-top: 25px; text-align: right;">
                <button class="btn btn-primary" onclick="closeAnalysisModal()">‚úÖ Cerrar</button>
            </div>
        </div>
    </div>

</div>
<!-- ========================================== -->
<!-- M√ìDULO GENERADOR DE PROMPTS IA - TOTALMENTE EDITABLE -->
<!-- ========================================== -->
<div id="modalPromptIA" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:10000; align-items:center; justify-content:center;">
  <div style="background:white; padding:30px; max-width:800px; width:92%; border-radius:16px; max-height:92vh; overflow-y:auto; box-shadow: 0 20px 60px rgba(0,0,0,0.4);">

    <div style="text-align:center; margin-bottom:25px;">
      <h2 style="margin:0; color:#2563eb; font-size:26px;">ü§ñ Generador de Prompts IA</h2>
      <p style="color:#6b7280; font-size:14px; margin:8px 0 0 0;">Datos auto-completados - <strong style="color:#10b981;">Puedes modificar todo lo que quieras</strong></p>
    </div>

    <!-- Grid de 2 columnas -->
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:20px;">

      <div>
        <label style="font-weight:600; font-size:13px; display:block; margin-bottom:5px; color:#374151;">üåç Pa√≠s Objetivo:</label>
        <input id="ia_pais" type="text" style="width:100%; padding:10px; border:2px solid #e5e7eb; border-radius:8px; font-size:14px; transition:border 0.3s;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e5e7eb'">
      </div>

      <div>
        <label style="font-weight:600; font-size:13px; display:block; margin-bottom:5px; color:#374151;">üó£Ô∏è Idioma Nativo:</label>
        <input id="ia_idioma" type="text" style="width:100%; padding:10px; border:2px solid #e5e7eb; border-radius:8px; font-size:14px; transition:border 0.3s;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e5e7eb'">
      </div>

    </div>

    <!-- Campo completo de nicho -->
    <div style="margin-bottom:15px;">
      <label style="font-weight:600; font-size:13px; display:block; margin-bottom:5px; color:#374151;">üì¶ Nicho / Producto:</label>
      <input id="ia_nicho" type="text" style="width:100%; padding:10px; border:2px solid #e5e7eb; border-radius:8px; font-size:14px; transition:border 0.3s;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e5e7eb'">
    </div>

    <!-- Campo completo H1 -->
    <div style="margin-bottom:15px;">
      <label style="font-weight:600; font-size:13px; display:block; margin-bottom:5px; color:#374151;">üéØ Keyword Principal (H1):</label>
      <input id="ia_h1" type="text" style="width:100%; padding:10px; border:2px solid #e5e7eb; border-radius:8px; font-size:14px; transition:border 0.3s;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e5e7eb'">
    </div>

    <!-- Keywords EDITABLES -->
    <div style="margin-bottom:20px;">
      <label style="font-weight:600; font-size:13px; display:block; margin-bottom:5px; color:#374151;">üîë Keywords (Editable - borra las que no quieras):</label>
      <textarea id="ia_keywords" style="width:100%; padding:10px; border:2px solid #e5e7eb; border-radius:8px; font-size:13px; height:140px; font-family:inherit; resize:vertical; line-height:1.6; transition:border 0.3s;" placeholder="keyword1&#10;keyword2&#10;keyword3&#10;...puedes borrar o agregar l√≠neas" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e5e7eb'"></textarea>
      <small style="color:#10b981; font-size:11px; display:block; margin-top:4px;">‚úèÔ∏è Puedes borrar, editar o agregar keywords. Una por l√≠nea. Solo para tu referencia (no van en el prompt).</small>
    </div>

    <!-- Divisor visual -->
    <div style="border-top:2px dashed #e5e7eb; margin:20px 0;"></div>

    <!-- Botones con estilo mejorado -->
    <div style="display:flex; gap:10px; margin-bottom:20px;">
      <button onclick="generarPromptMagnifico()" style="flex:1; background:linear-gradient(135deg, #10b981 0%, #059669 100%); color:white; border:none; padding:12px 20px; border-radius:10px; font-size:15px; font-weight:600; cursor:pointer; box-shadow:0 4px 12px rgba(16,185,129,0.3); transition:all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(16,185,129,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(16,185,129,0.3)'">
        ‚ú® Generar Prompt
      </button>
      <button onclick="copiarPromptIA()" style="flex:1; background:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color:white; border:none; padding:12px 20px; border-radius:10px; font-size:15px; font-weight:600; cursor:pointer; box-shadow:0 4px 12px rgba(59,130,246,0.3); transition:all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(59,130,246,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(59,130,246,0.3)'">
        üìã Copiar Prompt
      </button>
      <button onclick="cerrarModalPromptIA()" style="background:#6b7280; color:white; border:none; padding:12px 20px; border-radius:10px; font-size:15px; font-weight:600; cursor:pointer; transition:all 0.3s;" onmouseover="this.style.background='#4b5563'" onmouseout="this.style.background='#6b7280'">
        ‚ùå Cerrar
      </button>
    </div>

    <!-- √Årea de prompt generado -->
    <div>
      <label style="font-weight:600; font-size:13px; display:block; margin-bottom:5px; color:#374151;">üìÑ Prompt Generado:</label>
      <textarea id="ia_prompt_generado" style="width:100%; padding:12px; border:2px solid #e5e7eb; border-radius:8px; font-size:12px; height:300px; font-family:'Courier New', monospace; background:#f9fafb; resize:vertical; line-height:1.5;"></textarea>
    </div>

  </div>
</div>

<script>
// ============================================
// GENERADOR DE PROMPTS IA - TOTALMENTE EDITABLE
// ============================================

// Mapeo de pa√≠ses (ISO a nombre completo)
const paisesMap = {
  'AE': 'Emiratos √Årabes Unidos', 'ES': 'Espa√±a', 'MX': 'M√©xico', 'AR': 'Argentina',
  'CL': 'Chile', 'CO': 'Colombia', 'PE': 'Per√∫', 'BR': 'Brasil', 'US': 'Estados Unidos',
  'GB': 'Reino Unido', 'FR': 'Francia', 'DE': 'Alemania', 'IT': 'Italia', 'PT': 'Portugal',
  'PL': 'Polonia', 'NL': 'Pa√≠ses Bajos', 'BE': 'B√©lgica', 'SE': 'Suecia', 'NO': 'Noruega',
  'DK': 'Dinamarca', 'FI': 'Finlandia', 'CH': 'Suiza', 'AT': 'Austria', 'IE': 'Irlanda',
  'CA': 'Canad√°', 'AU': 'Australia', 'NZ': 'Nueva Zelanda', 'SG': 'Singapur', 'HK': 'Hong Kong',
  'JP': 'Jap√≥n', 'KR': 'Corea del Sur', 'IN': 'India', 'ZA': 'Sud√°frica', 'TR': 'Turqu√≠a',
  'RU': 'Rusia', 'UA': 'Ucrania', 'EG': 'Egipto', 'SA': 'Arabia Saudita', 'QA': 'Qatar',
  'KW': 'Kuwait', 'OM': 'Om√°n', 'BH': 'Bar√©in', 'IL': 'Israel', 'TH': 'Tailandia',
  'MY': 'Malasia', 'ID': 'Indonesia', 'PH': 'Filipinas', 'VN': 'Vietnam', 'PK': 'Pakist√°n',
  'BD': 'Bangladesh', 'NG': 'Nigeria', 'KE': 'Kenia', 'GH': 'Ghana', 'UY': 'Uruguay',
  'PY': 'Paraguay', 'BO': 'Bolivia', 'EC': 'Ecuador', 'VE': 'Venezuela', 'CR': 'Costa Rica',
  'PA': 'Panam√°', 'DO': 'Rep√∫blica Dominicana', 'PR': 'Puerto Rico', 'GT': 'Guatemala',
  'HN': 'Honduras', 'SV': 'El Salvador', 'NI': 'Nicaragua', 'CU': 'Cuba', 'JM': 'Jamaica',
  'TT': 'Trinidad y Tobago', 'BS': 'Bahamas', 'BB': 'Barbados'
};

// Mapeo de idiomas
const idiomasMap = {
  'es': 'Espa√±ol', 'en': 'Ingl√©s', 'pt': 'Portugu√©s', 'fr': 'Franc√©s', 'de': 'Alem√°n',
  'it': 'Italiano', 'pl': 'Polaco', 'nl': 'Holand√©s', 'sv': 'Sueco', 'no': 'Noruego',
  'da': 'Dan√©s', 'fi': 'Finland√©s', 'ru': 'Ruso', 'ar': '√Årabe', 'tr': 'Turco',
  'ja': 'Japon√©s', 'ko': 'Coreano', 'zh': 'Chino', 'hi': 'Hindi', 'th': 'Tailand√©s',
  'vi': 'Vietnamita', 'id': 'Indonesio', 'ms': 'Malayo', 'he': 'Hebreo'
};

function convertirPaisCompleto(pais) {
  if (pais && pais.length === 2) {
    return paisesMap[pais.toUpperCase()] || pais;
  }
  return pais;
}

function convertirIdiomaCompleto(idioma) {
  if (idioma && idioma.length === 2) {
    return idiomasMap[idioma.toLowerCase()] || idioma;
  }
  return idioma;
}

function abrirModalPromptIA(campaniaIndex) {
  console.log('üé® Abriendo modal editable para campa√±a:', campaniaIndex);

  if (typeof db === 'undefined' || !db.campaigns || !Array.isArray(db.campaigns)) {
    alert('‚ö†Ô∏è No hay campa√±as cargadas. Espera unos segundos.');
    return;
  }

  if (campaniaIndex < 0 || campaniaIndex >= db.campaigns.length) {
    alert('‚ùå √çndice de campa√±a inv√°lido: ' + campaniaIndex);
    return;
  }

  const campania = db.campaigns[campaniaIndex];

  if (!campania) {
    alert('‚ùå No se pudo acceder a la campa√±a');
    return;
  }

  console.log('‚úÖ Campa√±a cargada:', campania);

  // Convertir pa√≠s e idioma
  const paisRaw = campania.pais || campania.country || '';
  const idiomaRaw = campania.idioma || campania.language || '';

  const paisCompleto = convertirPaisCompleto(paisRaw);
  const idiomaCompleto = convertirIdiomaCompleto(idiomaRaw);

  // Procesar keywords UNA POR L√çNEA
  let keywordsTexto = '';
  if (campania.keywords) {
    if (typeof campania.keywords === 'string') {
      keywordsTexto = campania.keywords.split(',').map(k => k.trim()).filter(k => k).join('\n');
    } else if (Array.isArray(campania.keywords)) {
      keywordsTexto = campania.keywords.map(k => String(k).trim()).filter(k => k).join('\n');
    }
  }

  console.log('Keywords procesadas (editables):', keywordsTexto);

  // Rellenar todos los campos (TODOS EDITABLES)
  document.getElementById('ia_pais').value = paisCompleto;
  document.getElementById('ia_idioma').value = idiomaCompleto;
  document.getElementById('ia_nicho').value = campania.nicho || campania.product || '';
  document.getElementById('ia_h1').value = campania.nombre || campania.name || '';
  document.getElementById('ia_keywords').value = keywordsTexto;
  document.getElementById('ia_prompt_generado').value = '';

  document.getElementById('modalPromptIA').style.display = 'flex';
  console.log('‚úÖ Modal editable abierto - puedes modificar todo');
}

function cerrarModalPromptIA() {
  document.getElementById('modalPromptIA').style.display = 'none';
}

function generarPromptMagnifico() {
  const pais = document.getElementById('ia_pais').value.trim();
  const idioma = document.getElementById('ia_idioma').value.trim();
  const nicho = document.getElementById('ia_nicho').value.trim();
  const h1 = document.getElementById('ia_h1').value.trim();

  if (!pais || !idioma || !nicho || !h1) {
    alert('‚ö†Ô∏è Por favor completa todos los campos obligatorios');
    return;
  }

  // PROMPT EXACTO
  const prompt = `Act√∫a como un experto redactor de art√≠culos advertorial RSOC con 15 a√±os de experiencia en redes sociales.
Necesito crear un art√≠culo 100% compliant con las pol√≠ticas publicitarias para ${pais} en idioma ${idioma} (Nativo).

üõë **MANDATO DE EJECUCI√ìN OBLIGATORIO**:
Tu misi√≥n es hacer **EXACTAMENTE LO QUE PIDO**, respetando longitudes, negritas y asegurando una traducci√≥n perfecta.

‚õî **REGLA DE TRADUCCI√ìN**: El input contiene textos en ESPA√ëOL que sirven como PLANTILLAS. TRAD√öCELOS fielmente al ${idioma} y ad√°ptalos al pa√≠s ${pais}. NO escribas nada en espa√±ol en el resultado final.


---
### üìè REGLAS DE FORMATO Y EXTENSI√ìN (OBLIGATORIO)

**1. Longitud:** M√≠nimo 1200 palabras, M√°ximo 1500 palabras.
**2. Uso de Negritas:** √öNICAMENTE en T√≠tulo H1, Subt√≠tulos H2, la PRIMERA vez que aparece la Keyword Principal y menciones de Keywords Secundarias.
**3. P√°rrafos:** 2 a 3 p√°rrafos por H2. Longitud de 6 a 8 renglones visuales por p√°rrafo de forma consistente.
**4. Las palabras de los T√≠tulos principales (H1), siembre deben ir en May√∫sculas las primeras letras, tanto en el titulo principal (H1), como de los t√≠tulos  secundarios (H2), es "obligatorio"

---
### üõ°Ô∏è TONO Y COMPLIANCE (OBLIGATORIO)

- **Tono General:** Neutral e informativo.
- **Estilo de Escritura:** CERO lenguaje de venta agresiva.
- **Resultados:** NO garantizar aprobaciones ni resultados.
- **Anonimato:** NO mencionar marcas reales, financieras,  bancos espec√≠ficos ni precios concretos.
- **Pagos:** NO mencionar m√©todos de pago espec√≠ficos (tarjetas, plataformas financieras).
- **Publicidad:** NO mencionar anunciantes ni ofertas comerciales directas.

---
### üèóÔ∏è ESTRUCTURA Y CONTENIDO

**1. T√çTULO PRINCIPAL (H1)**
Instrucci√≥n: Utiliza OBLIGATORIAMENTE esta informaci√≥n para el t√≠tulo: "${h1}".
Acci√≥n: Trad√∫cela al ${idioma} de forma atractiva pero profesional.
Formato: # **[Texto Traducido]**

**2. INTRODUCCI√ìN**
Instrucci√≥n: Traduce este p√°rrafo maestro al ${idioma}:
"En ${pais}, algunas tiendas y plataformas ofrecen planes para **Comprar un ${nicho}**. La disponibilidad, el costo y los requisitos var√≠an seg√∫n el proveedor, el producto y el tipo de financiamiento, y siempre est√°n sujetos a evaluaciones de elegibilidad y asequibilidad. Este art√≠culo explica c√≥mo funciona, los t√©rminos comunes, qu√© revisar antes de decidir y qu√© buscar para evitar costos inesperados."

**3. DISCLAIMER INICIAL**
Instrucci√≥n: Traduce al ${idioma} y ponlo en cursiva:
*"Solo para fines informativos; esto no constituye asesoramiento financiero. No se garantiza la aprobaci√≥n. Por favor, consulte los t√©rminos y condiciones oficiales del proveedor al realizar la compra."*

**4. DESARROLLO (H2)**
Instrucci√≥n: Desarrolla los siguientes puntos (traducidos). Usa el separador (---) antes de cada H2.
   - [Genera 4 subt√≠tulos H2 traducidos y relevantes para el nicho]

**5. CONCLUSI√ìN (H2)**
Formato:
---
## **[Conclusi√≥n Traducida]**
Contenido: P√°rrafo de cierre en ${idioma}.

**7. DISCLAIMER FINAL**
Instrucci√≥n: Traduce al ${idioma} y ponlo en cursiva:
*"La informaci√≥n compartida en este art√≠culo est√° vigente al momento de su publicaci√≥n. Para obtener informaci√≥n m√°s actualizada, investigue por su cuenta."*
---
**8. FUENTES Y REFERENCIAS (H2)**
Instrucci√≥n: Genera un H2 titulado "Fuentes" (Traducido).
‚ö†Ô∏è Lista 5 fuentes de autoridad REAL en ${pais} (Bancos, Ministerios, Entidades de Consumidores).

¬°Escribe el art√≠culo en formato editabl.md!`;

  document.getElementById('ia_prompt_generado').value = prompt;
  document.getElementById('ia_prompt_generado').scrollIntoView({behavior: 'smooth', block: 'nearest'});

  console.log('‚úÖ Prompt generado exitosamente');

  if (typeof showNotif === 'function') {
    showNotif('‚úÖ Prompt generado correctamente', 'success');
  }
}

function copiarPromptIA() {
  const textarea = document.getElementById('ia_prompt_generado');

  if (!textarea.value.trim()) {
    alert('‚ö†Ô∏è Primero genera el prompt haciendo clic en "‚ú® Generar Prompt"');
    return;
  }

  textarea.select();
  textarea.setSelectionRange(0, 99999);

  try {
    document.execCommand('copy');
    console.log('‚úÖ Prompt copiado al portapapeles');

    if (typeof showNotif === 'function') {
      showNotif('‚úÖ Prompt copiado al portapapeles', 'success');
    }

    alert('‚úÖ ¬°Prompt copiado exitosamente!\n\nüìã Ahora p√©galo en Qwen o Perplexity (Ctrl+V)');
  } catch (err) {
    console.error('‚ùå Error al copiar:', err);
    alert('‚ö†Ô∏è Error al copiar autom√°ticamente.\n\nSelecciona el texto manualmente y copia con Ctrl+C');
  }
}

console.log('‚úÖ M√≥dulo IA totalmente editable cargado');


// BANCO DE KEYWORDS

async function importKeywordBankFromExcel(event) {
  const file = event.target.files[0];
  if (!file) return;
  showNotif('Leyendo Excel...', 'info');
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, {type: 'array'});
      const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(firstSheet);
      if (rows.length === 0) { alert('Excel vac√≠o'); return; }
      const cols = Object.keys(rows[0]);
      let formatType = 'unknown';
      if (cols.includes('campaign_id') && cols.includes('product') && cols.includes('keyword')) {
        formatType = 'standard';
      } else if (cols.some(c => c.toLowerCase().includes('keyword')) && 
                 (cols.some(c => c.toLowerCase().includes('search')) || cols.some(c => c.toLowerCase().includes('impression')))) {
        formatType = 'tabla-keywords';
      }
      if (formatType === 'unknown') { alert('Formato no reconocido'); return; }
      showNotif('Formato: ' + formatType, 'info');
      const campaignMap = {};
      if (formatType === 'standard') {
        rows.forEach(row => {
          const cid = row.campaign_id;
          if (!campaignMap[cid]) {
            campaignMap[cid] = {
              campaign_id: cid, product: row.product, country: row.country,
              platform: cid.split('-')[0] || 'FB', channel: cid.split('-')[1] || 'HAV',
              keywords: [], date_added: new Date().toISOString().slice(0, 10)
            };
          }
          campaignMap[cid].keywords.push({
            text: row.keyword, priority: row.priority || 'normal',
            impressions: parseInt(row.impressions) || 0, clicks: parseInt(row.clicks) || 0,
            ctr: parseFloat(row.ctr) || 0, conversions: parseInt(row.conversions) || 0,
            cost: parseFloat(row.cost) || 0, cpc: parseFloat(row.cpc) || 0
          });
        });
      } else if (formatType === 'tabla-keywords') {
        const keyCol = cols.find(c => c.toLowerCase().includes('keyword')) || 'Keyword';
        const campCol = cols.find(c => { const val = String(rows[0][c]); return val.includes('FB-') || val.includes('TT-') || val.includes('MMT'); }) || cols[1];
        const searchCol = cols.find(c => c.toLowerCase().includes('search') || c.toLowerCase().includes('impression')) || 'Searches';
        const clickCol = cols.find(c => c.toLowerCase().includes('click')) || 'Clicks';
        const ctrCol = cols.find(c => c.toLowerCase().includes('ctr')) || 'CTR';
        rows.forEach(row => {
          const cid = row[campCol];
          if (!cid || cid === '' || typeof cid !== 'string') return;
          const parts = cid.split('-');
          if (parts.length < 4) return;
          if (!campaignMap[cid]) {
            campaignMap[cid] = {
              campaign_id: cid, product: parts[2], country: parts[3],
              platform: parts[0], channel: parts[1], keywords: [],
              date_added: new Date().toISOString().slice(0, 10)
            };
          }
          let ctrVal = 0;
          if (row[ctrCol]) { const ctrStr = String(row[ctrCol]).replace('%', '').trim(); ctrVal = parseFloat(ctrStr) || 0; }
          campaignMap[cid].keywords.push({
            text: row[keyCol] || '', priority: 'normal',
            impressions: parseInt(row[searchCol]) || 0, clicks: parseInt(row[clickCol]) || 0,
            ctr: ctrVal, conversions: 0, cost: 0, cpc: 0
          });
        });
      }
      // ================================================================
      // PASO 1: CREAR ARRAY DE NUEVAS CAMPA√ëAS (NO REEMPLAZAR)
      // ================================================================
      const newCampaigns = Object.values(campaignMap).map(camp => {
        camp.total_keywords = camp.keywords.length;
        camp.high_priority_count = camp.keywords.filter(k => k.priority === 'high').length;
        return camp;
      });

      console.log('üîÑ Campa√±as en Excel:', newCampaigns.length);
      console.log('üì¶ Campa√±as en banco ANTES:', keywordBank.length);

      // ================================================================
      // PASO 2: MERGE INTELIGENTE - NO BORRAR EXISTENTES
      // ================================================================

      // Obtener IDs de campa√±as que YA existen en el banco
      const existingIds = new Set(keywordBank.map(c => c.campaignid));

      // Filtrar solo las campa√±as NUEVAS (que NO existen)
      const campaignsToAdd = newCampaigns.filter(c => !existingIds.has(c.campaignid));

      if (campaignsToAdd.length > 0) {
        // AGREGAR campa√±as nuevas SIN borrar las existentes
        keywordBank.push(...campaignsToAdd);

        console.log('‚úÖ AGREGADAS:', campaignsToAdd.length, 'campa√±as nuevas');
        console.log('üìä TOTAL en banco:', keywordBank.length, 'campa√±as');

        const totalKw = keywordBank.reduce((s,c) => s + c.total_keywords, 0);
        showNotif(campaignsToAdd.length + ' campa√±as AGREGADAS | Total: ' + keywordBank.length + ' campa√±as (' + totalKw + ' keywords)', 'success');

      } else {
        // Todas las campa√±as YA existen - actualizar keywords
        console.log('‚ÑπÔ∏è Campa√±as ya existen - Actualizando keywords');

        let keywordsAgregadas = 0;
        let campanasActualizadas = 0;

        newCampaigns.forEach(newCamp => {
          const existing = keywordBank.find(c => c.campaignid === newCamp.campaignid);
          if (existing) {
            // Obtener keywords existentes (comparar en min√∫sculas)
            const existingKwTexts = new Set(existing.keywords.map(k => k.text.toLowerCase()));

            // Filtrar solo keywords NUEVAS
            const newKws = newCamp.keywords.filter(k => !existingKwTexts.has(k.text.toLowerCase()));

            if (newKws.length > 0) {
              // Agregar keywords nuevas
              existing.keywords.push(...newKws);
              existing.totalkeywords = existing.keywords.length;
              existing.total_keywords = existing.keywords.length;
              existing.high_priority_count = existing.keywords.filter(k => k.priority === 'high').length;

              keywordsAgregadas += newKws.length;
              campanasActualizadas++;

              console.log('üìù', newKws.length, 'keywords nuevas agregadas a', existing.campaignid);
            }
          }
        });

        if (keywordsAgregadas > 0) {
          const totalKw = keywordBank.reduce((s,c) => s + c.total_keywords, 0);
          showNotif(keywordsAgregadas + ' keywords nuevas agregadas a ' + campanasActualizadas + ' campa√±as existentes | Total: ' + totalKw + ' keywords', 'success');
        } else {
          showNotif('Sin cambios - Todas las campa√±as y keywords ya existen', 'info');
        }
      }

      console.log('‚úÖ BANCO FINAL:', keywordBank.length, 'campa√±as');

      // ================================================================
      // PASO 3: GUARDAR Y ACTUALIZAR
      // ================================================================
      localStorage.setItem('keywordBank', JSON.stringify(keywordBank));
      updateBankStats(); populateBankFilters(); renderBankCampaigns();
      document.getElementById('importBankExcel').value = '';
    

        // AUTO-SINCRONIZACI√ìN
        if (keywordBank && keywordBank.length > 0) {
            setTimeout(() => {
                if (typeof syncBankToFirebase === 'function') {
                    syncBankToFirebase();
                }
            }, 1000);
        }
} catch (error) { alert('Error: ' + error.message); console.error(error); }
  };
  reader.readAsArrayBuffer(file);
}

function importKeywordBank(event) {
  const file = event.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      keywordBank = JSON.parse(e.target.result);
      localStorage.setItem('keywordBank', JSON.stringify(keywordBank));
      updateBankStats(); populateBankFilters(); renderBankCampaigns();
      showNotif(keywordBank.length + ' campa√±as', 'success');
      document.getElementById('importBankFile').value = '';
    } catch (error) { alert('Error: ' + error.message); }
  };
  reader.readAsText(file);
}

function loadKeywordBankFromStorage() {
  const stored = localStorage.getItem('keywordBank');
  if (stored) { try { keywordBank = JSON.parse(stored); updateBankStats(); populateBankFilters(); } catch(e) {} }
}

function updateBankStats() {
  const e1 = document.getElementById('bankTotalCampaigns');
  const e2 = document.getElementById('bankTotalKeywords');
  const e3 = document.getElementById('bankHighPriority');
  const e4 = document.getElementById('bankSelectedCount');
  if (e1) e1.textContent = keywordBank.length;
  if (e2) e2.textContent = keywordBank.reduce((s, c) => s + c.total_keywords, 0);
  if (e3) e3.textContent = keywordBank.reduce((s, c) => s + c.high_priority_count, 0);
  if (e4) e4.textContent = selectedKeywords.length;
}

function populateBankFilters() {
  const products = [...new Set(keywordBank.map(c => c.product))].sort();
  const countries = [...new Set(keywordBank.map(c => c.country))].sort();
  const psel = document.getElementById('bankFilterProduct');
  if (psel) psel.innerHTML = '<option value="">Todos</option>' + products.map(p => '<option value="' + p + '">' + p + '</option>').join('');
  const csel = document.getElementById('bankFilterCountry');
  if (csel) csel.innerHTML = '<option value="">Todos</option>' + countries.map(c => '<option value="' + c + '">' + c + '</option>').join('');
}

function renderBankCampaigns() {
  const cont = document.getElementById('bankCampaignsList'); if (!cont) return;
  if (keywordBank.length === 0) { cont.innerHTML = '<div style="text-align:center;padding:60px 20px;color:#999;"><p>Importa archivo</p></div>'; return; }
  const filtered = getFilteredBankCampaigns();
  const cel = document.getElementById('bankFilteredCount'); if (cel) cel.textContent = filtered.length;
  cont.innerHTML = filtered.map(camp => {
    const idx = keywordBank.indexOf(camp);
    return '<div class="bank-campaign-card" onclick="showBankCampaignDetail(' + idx + ')"><h4>' + camp.campaign_id + '</h4><div class="meta"><span>üì¶ ' + camp.product + '</span><span>üåç ' + camp.country + '</span><span>üìù ' + camp.total_keywords + '</span></div></div>';
  }).join('');
}

function getFilteredBankCampaigns() {
  const search = (document.getElementById('bankSearch')?.value || '').toLowerCase();
  const product = document.getElementById('bankFilterProduct')?.value || '';
  const country = document.getElementById('bankFilterCountry')?.value || '';
  return keywordBank.filter(camp => {
    if (product && camp.product !== product) return false;
    if (country && camp.country !== country) return false;
    if (search) {
      const ok = camp.campaign_id.toLowerCase().includes(search) || camp.keywords.some(kw => kw.text.toLowerCase().includes(search));
      if (!ok) return false;
    }
    return true;
  });
}

function filterKeywordBank() { renderBankCampaigns(); }

function showBankCampaignDetail(idx) {
  currentBankCampaignIndex = idx;
  const camp = keywordBank[idx];
  originalKeywordOrder = [...camp.keywords];
  updateCurrentCampaignView();
}

function updateCurrentCampaignView() {
  if (currentBankCampaignIndex < 0) return;
  const camp = keywordBank[currentBankCampaignIndex];
  const cont = document.getElementById('bankKeywordsDetail'); if (!cont) return;
  document.querySelectorAll('.bank-campaign-card').forEach((card, i) => {
    const filtered = getFilteredBankCampaigns();
    const realIdx = keywordBank.indexOf(filtered[i]);
    card.classList.toggle('active', realIdx === currentBankCampaignIndex);
  });
  const priof = document.getElementById('bankFilterPriority')?.value || '';
  let fkws = camp.keywords.filter(kw => !priof || kw.priority === priof);
  let html = '<div style="margin-bottom:20px;border-bottom:2px solid #667eea;padding-bottom:15px;"><h3 style="color:#667eea;margin:0 0 10px 0;">' + camp.campaign_id + '</h3><div style="display:flex;gap:20px;font-size:0.9em;color:#666;"><span>üì¶ ' + camp.product + '</span><span>üåç ' + camp.country + '</span><span>üìù ' + fkws.length + ' kws</span></div></div><div style="margin-bottom:15px;display:flex;gap:10px;"><button class="btn btn-success" onclick="selectAllKeywordsFromCampaign()" style="flex:1;padding:8px;font-size:0.85em;">‚úÖ Todas</button><button class="btn btn-warning" onclick="deselectAllKeywordsFromCampaign()" style="flex:1;padding:8px;font-size:0.85em;">‚ùå Ninguna</button></div><div style="max-height:450px;overflow-y:auto;">';
  fkws.forEach(kw => {
    const aidx = camp.keywords.indexOf(kw);
    const sel = selectedKeywords.some(sk => sk.campaignId === camp.campaign_id && sk.text === kw.text);
    const pcls = kw.priority === 'high' ? 'priority-high' : 'priority-normal';
    const plbl = kw.priority === 'high' ? 'üî• ALTA' : 'NORMAL';
    html += '<div class="keyword-item ' + (sel?'selected':'') + '" id="kw-' + currentBankCampaignIndex + '-' + aidx + '"><input type="checkbox" ' + (sel?'checked':'') + ' onchange="toggleKeywordSelection(' + aidx + ')"><span class="keyword-text">' + kw.text + '</span><span class="keyword-priority ' + pcls + '">' + plbl + '</span><div class="keyword-metrics"><span class="metric-value">üëÅÔ∏è ' + kw.impressions.toLocaleString() + '</span><span class="metric-value">üñ±Ô∏è ' + kw.clicks + '</span><span class="metric-value">üìä ' + kw.ctr.toFixed(2) + '%</span></div></div>';
  });
  html += '</div>'; cont.innerHTML = html;
}

function toggleKeywordSelection(kwIdx) {
  const camp = keywordBank[currentBankCampaignIndex]; const kw = camp.keywords[kwIdx];
  const eidx = selectedKeywords.findIndex(sk => sk.campaignId === camp.campaign_id && sk.text === kw.text);
  if (eidx >= 0) { selectedKeywords.splice(eidx, 1); } else { selectedKeywords.push({campaignId: camp.campaign_id, text: kw.text, priority: kw.priority, product: camp.product, country: camp.country}); }
  updateBankStats(); const el = document.getElementById('kw-' + currentBankCampaignIndex + '-' + kwIdx); if (el) el.classList.toggle('selected');
}

function selectAllKeywordsFromCampaign() {
  const camp = keywordBank[currentBankCampaignIndex]; const priof = document.getElementById('bankFilterPriority')?.value || '';
  camp.keywords.forEach(kw => { if (priof && kw.priority !== priof) return; const ex = selectedKeywords.some(sk => sk.campaignId === camp.campaign_id && sk.text === kw.text); if (!ex) { selectedKeywords.push({campaignId: camp.campaign_id, text: kw.text, priority: kw.priority, product: camp.product, country: camp.country}); } });
  updateBankStats(); updateCurrentCampaignView(); showNotif(selectedKeywords.length + ' seleccionadas', 'success');
}

function deselectAllKeywordsFromCampaign() {
  const camp = keywordBank[currentBankCampaignIndex];
  selectedKeywords = selectedKeywords.filter(sk => sk.campaignId !== camp.campaign_id);
  updateBankStats(); updateCurrentCampaignView();
}

function clearSelectedKeywords() {
  selectedKeywords = []; updateBankStats();
  if (currentBankCampaignIndex >= 0) updateCurrentCampaignView();
  showNotif('Limpiado', 'info');
}

function copySelectedKeywords() {
  if (selectedKeywords.length === 0) { alert('No hay keywords seleccionadas'); return; }
  const txt = selectedKeywords.map(kw => kw.priority === 'high' ? '**' + kw.text + '**' : kw.text).join('\n');
  navigator.clipboard.writeText(txt).then(() => { showNotif(selectedKeywords.length + ' copiadas', 'success'); }).catch(() => { const ta = document.createElement('textarea'); ta.value = txt; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); showNotif(selectedKeywords.length + ' copiadas', 'success'); });
}

function sendToForm() {
  if (selectedKeywords.length === 0) { alert('No hay keywords'); return; }
  const txt = selectedKeywords.map(kw => kw.priority === 'high' ? '**' + kw.text + '**' : kw.text).join('\n');
  switchTab('tab-add'); const ta = document.getElementById('inKeywords1');
  if (ta) { ta.value = ta.value.trim() ? ta.value + '\n' + txt : txt; setTimeout(() => ta.scrollIntoView({behavior:'smooth',block:'center'}), 100); showNotif(selectedKeywords.length + ' keywords', 'success'); }
}

function exportKeywordBank() {
  if (keywordBank.length === 0) { alert('Banco vac√≠o'); return; }
  const str = JSON.stringify(keywordBank, null, 2);
  const blob = new Blob([str], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'banco_' + new Date().toISOString().slice(0,10) + '.json'; a.click();
  URL.revokeObjectURL(url); showNotif('Exportado', 'success');
}

function clearBankData() {
  if (confirm('¬øVaciar banco?')) {
    keywordBank = []; selectedKeywords = []; currentBankCampaignIndex = -1; originalKeywordOrder = [];
    localStorage.removeItem('keywordBank'); updateBankStats(); renderBankCampaigns();
    document.getElementById('bankKeywordsDetail').innerHTML = '<div style="text-align:center;padding:100px 20px;color:#999;">Vaciado</div>';
    showNotif('Vaciado', 'warning');
  }
}

(function() {
  const origSwitchTab = window.switchTab;
  window.switchTab = function(id) {
    if (origSwitchTab) origSwitchTab(id);
    if (id === 'tab-keyword-bank') { loadKeywordBankFromStorage(); if (keywordBank.length > 0) renderBankCampaigns(); }
  };
})();

window.addEventListener('DOMContentLoaded', loadKeywordBankFromStorage);



// ============================================================================
// SISTEMA COMPLETO: EDICI√ìN, ELIMINACI√ìN, SINCRONIZACI√ìN Y ORDENAMIENTO
// ============================================================================

let editingKeywordIndex = null;
const keywordBankRef = dbFirebase.collection('keywordBank');
let keywordSortBy = null; // 'impressions', 'clicks', 'alpha', 'priority'
let keywordSortDirection = 'desc';

// ORDENAR KEYWORDS
function sortKeywordsBy(criteria) {
    if (keywordSortBy === criteria) {
        keywordSortDirection = keywordSortDirection === 'desc' ? 'asc' : 'desc';
    } else {
        keywordSortBy = criteria;
        keywordSortDirection = 'desc';
    }

    const campaign = keywordBank[currentBankCampaignIndex];
    campaign.keywords.sort((a, b) => {
        let valA, valB;
        if (criteria === 'impressions') {
            valA = a.impressions || a.searches || 0;
            valB = b.impressions || b.searches || 0;
        } else if (criteria === 'clicks') {
            valA = a.clicks || 0;
            valB = b.clicks || 0;
        } else if (criteria === 'alpha') {
            valA = a.text.toLowerCase();
            valB = b.text.toLowerCase();
        } else if (criteria === 'priority') {
            valA = a.priority === 'high' ? 1 : 0;
            valB = b.priority === 'high' ? 1 : 0;
        }

        if (criteria === 'alpha') {
            return keywordSortDirection === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
        } else {
            if (valA < valB) return keywordSortDirection === 'asc' ? -1 : 1;
            if (valA > valB) return keywordSortDirection === 'asc' ? 1 : -1;
            return 0;
        }
    });

    updateCurrentCampaignView();

    const msgs = {
        impressions: `üëÅÔ∏è ${keywordSortDirection === 'desc' ? 'Mayor a menor' : 'Menor a mayor'}`,
        clicks: `üñ±Ô∏è ${keywordSortDirection === 'desc' ? 'Mayor a menor' : 'Menor a mayor'}`,
        alpha: `üî§ ${keywordSortDirection === 'desc' ? 'Z‚ÜíA' : 'A‚ÜíZ'}`,
        priority: `‚≠ê ${keywordSortDirection === 'desc' ? 'Alta primero' : 'Normal primero'}`
    };
    showNotif(msgs[criteria], 'info');
}

// REDEFINIR updateCurrentCampaignView
const _origUpdate = updateCurrentCampaignView;
function updateCurrentCampaignView() {
    if (currentBankCampaignIndex < 0) return;
    const campaign = keywordBank[currentBankCampaignIndex];
    const container = document.getElementById('bankKeywordsDetail');

    let html = `
        <div style="margin-bottom:20px;border-bottom:2px solid #667eea;padding-bottom:15px;">
            <h3 style="color:#667eea;margin:0 0 10px 0;">${campaign.campaign_id || campaign.campaignid}</h3>
            <div style="display:flex;gap:20px;font-size:0.9em;color:#666;flex-wrap:wrap;">
                <span>üì¶ ${campaign.product}</span>
                <span>üåç ${campaign.country}</span>
                <span>üìù ${campaign.keywords.length} kw</span>
                <span style="color:#f59e0b;">‚úèÔ∏è ${campaign.keywords.filter(k => k.edited).length} editadas</span>
            </div>
        </div>
        <div style="margin-bottom:15px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
            <button class="btn btn-success" onclick="selectAllKeywordsFromCampaign()" style="padding:8px 16px;font-size:0.85em;">‚úÖ Todas</button>
            <button class="btn btn-warning" onclick="deselectAllKeywordsFromCampaign()" style="padding:8px 16px;font-size:0.85em;">‚ùå Ninguna</button>
            <button class="btn btn-danger" onclick="deleteSelectedKeywords()" style="padding:8px 16px;font-size:0.85em;">üóëÔ∏è Eliminar</button>
            <div style="border-left:2px solid #ddd;margin-left:10px;padding-left:10px;display:flex;gap:5px;align-items:center;">
                <span style="font-size:0.85em;color:#666;font-weight:600;">Ordenar:</span>
                <button class="btn-mini" style="background:#667eea;color:white;padding:6px 12px;" onclick="sortKeywordsBy('impressions')" title="Por impresiones">üëÅÔ∏è</button>
                <button class="btn-mini" style="background:#667eea;color:white;padding:6px 12px;" onclick="sortKeywordsBy('clicks')" title="Por clics">üñ±Ô∏è</button>
                <button class="btn-mini" style="background:#667eea;color:white;padding:6px 12px;" onclick="sortKeywordsBy('alpha')" title="Alfab√©tico">üî§</button>
                <button class="btn-mini" style="background:#667eea;color:white;padding:6px 12px;" onclick="sortKeywordsBy('priority')" title="Por prioridad">‚≠ê</button>
            </div>
        </div>
        <div style="max-height:450px;overflow-y:auto;">`;

    const filterPriority = document.getElementById('bankFilterPriority')?.value;

    campaign.keywords.forEach((kw, idx) => {
        if (filterPriority && filterPriority !== 'Todas' && kw.priority !== filterPriority) return;

        const isSelected = selectedKeywords.some(sk => 
            sk.campaignId === campaign.campaign_id && sk.text === kw.text
        );
        const isEditing = editingKeywordIndex === idx;

        html += `
            <div class="keyword-item ${isSelected ? 'selected' : ''} ${isEditing ? 'editing' : ''}">
                <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleKeywordSelection(${idx})">`;

        if (isEditing) {
            html += `<input type="text" class="keyword-text-input" id="kwInput-${idx}" 
                value="${kw.text.replace(/"/g, '&quot;')}"
                onkeydown="if(event.key==='Enter'){event.preventDefault();saveKeywordEdit(${idx});}if(event.key==='Escape')cancelKeywordEdit();">`;
        } else {
            html += `<span class="keyword-text">${kw.text}${kw.edited ? '<span class="keyword-edited-badge">‚úèÔ∏è</span>' : ''}</span>`;
        }

        html += `
                <div class="keyword-metrics">
                    <span class="metric-value">üëÅÔ∏è ${(kw.impressions || kw.searches || 0).toLocaleString()}</span>
                    <span class="metric-value">üñ±Ô∏è ${kw.clicks || 0}</span>
                    <span class="metric-value" style="background:${kw.priority === 'high' ? '#ef4444' : '#6b7280'};color:white;padding:4px 8px;">
                        
                    </span>
                </div>
                <div class="keyword-actions">`;

        if (isEditing) {
            html += `<button class="btn-mini btn-save-mini" onclick="saveKeywordEdit(${idx})">üíæ</button>
                     <button class="btn-mini btn-cancel-mini" onclick="cancelKeywordEdit()">‚ùå</button>`;
        } else {
            html += `<button class="btn-mini btn-edit-mini" onclick="startKeywordEdit(${idx})">‚úèÔ∏è</button>
                     <button class="btn-mini btn-del-mini" onclick="deleteSingleKeyword(${idx})">üóëÔ∏è</button>`;
        }

        html += `</div></div>`;
    });

    html += '</div>';
    container.innerHTML = html;
}

function startKeywordEdit(idx) {
    if (editingKeywordIndex !== null) {
        showNotif('Termina de editar primero', 'warning');
        return;
    }
    editingKeywordIndex = idx;
    updateCurrentCampaignView();
    setTimeout(() => {
        const inp = document.getElementById(`kwInput-${idx}`);
        if (inp) { inp.focus(); inp.select(); }
    }, 50);
}

async function saveKeywordEdit(idx) {
    const inp = document.getElementById(`kwInput-${idx}`);
    if (!inp) return;
    const newText = inp.value.trim();
    if (!newText) { showNotif('No puede estar vac√≠a', 'warning'); return; }

    const campaign = keywordBank[currentBankCampaignIndex];
    const kw = campaign.keywords[idx];

    if (newText !== kw.text) {
        kw.text = newText;
        kw.edited = true;
        kw.editedAt = new Date().toISOString();
        localStorage.setItem('keywordBank', JSON.stringify(keywordBank));
        await syncBankToFirebase();
        showNotif('‚úÖ Guardado', 'success');
    }

    editingKeywordIndex = null;
    updateBankStats();
    updateCurrentCampaignView();
}

function cancelKeywordEdit() {
    editingKeywordIndex = null;
    updateCurrentCampaignView();
}

async function deleteSingleKeyword(idx) {
    if (!confirm('¬øEliminar?')) return;
    const campaign = keywordBank[currentBankCampaignIndex];
    const deleted = campaign.keywords[idx];
    campaign.keywords.splice(idx, 1);
    campaign.total_keywords = campaign.keywords.length;

    selectedKeywords = selectedKeywords.filter(sk => 
        !(sk.campaignId === campaign.campaign_id && sk.text === deleted.text)
    );

    if (campaign.keywords.length === 0) {
        keywordBank.splice(currentBankCampaignIndex, 1);
        currentBankCampaignIndex = -1;
        localStorage.setItem('keywordBank', JSON.stringify(keywordBank));
        await syncBankToFirebase();
        updateBankStats();
        populateBankFilters();
        renderBankCampaigns();
        document.getElementById('bankKeywordsDetail').innerHTML = '<div style="text-align:center;padding:100px 20px;"><p>Campa√±a eliminada</p></div>';
        showNotif('Campa√±a eliminada', 'warning');
        return;
    }

    localStorage.setItem('keywordBank', JSON.stringify(keywordBank));
    await syncBankCampaignToFirebase(currentBankCampaignIndex);
    updateBankStats();
    renderBankCampaigns();
    updateCurrentCampaignView();
    showNotif('Eliminada', 'success');
}

async function deleteSelectedKeywords() {
    const campaign = keywordBank[currentBankCampaignIndex];
    const selected = selectedKeywords.filter(sk => sk.campaignId === campaign.campaign_id);
    if (selected.length === 0) { showNotif('No hay seleccionadas', 'warning'); return; }
    if (!confirm(`¬øEliminar ${selected.length}?`)) return;

    const texts = selected.map(sk => sk.text);
    campaign.keywords = campaign.keywords.filter(kw => !texts.includes(kw.text));
    campaign.total_keywords = campaign.keywords.length;
    selectedKeywords = selectedKeywords.filter(sk => sk.campaignId !== campaign.campaign_id);

    if (campaign.keywords.length === 0) {
        keywordBank.splice(currentBankCampaignIndex, 1);
        currentBankCampaignIndex = -1;
        localStorage.setItem('keywordBank', JSON.stringify(keywordBank));
        await syncBankToFirebase();
        updateBankStats();
        populateBankFilters();
        renderBankCampaigns();
        document.getElementById('bankKeywordsDetail').innerHTML = '<div style="text-align:center;padding:100px 20px;"><p>Campa√±a eliminada</p></div>';
        showNotif('Campa√±a eliminada', 'warning');
        return;
    }

    localStorage.setItem('keywordBank', JSON.stringify(keywordBank));
    await syncBankCampaignToFirebase(currentBankCampaignIndex);
    updateBankStats();
    renderBankCampaigns();
    updateCurrentCampaignView();
    showNotif(`${selected.length} eliminadas`, 'success');
}

// SINCRONIZACI√ìN
async function syncBankToFirebase() {
    try {
        showSyncStatus('saving');
        const snapshot = await keywordBankRef.get();
        const batch = dbFirebase.batch();
        snapshot.forEach(doc => batch.delete(doc.ref));
        await batch.commit();

        const batch2 = dbFirebase.batch();
        keywordBank.forEach((camp, idx) => {
            const docRef = keywordBankRef.doc(`camp_${idx}`);
            batch2.set(docRef, { ...camp, updatedAt: new Date().toISOString() });
        });
        await batch2.commit();
        showSyncStatus('saved');
    } catch (error) {
        console.error(error);
        showSyncStatus('error');
    }
}

// Sync r√°pido: actualiza SOLO la campa√±a actual (sin borrar todo el banco)
async function syncBankCampaignToFirebase(idx) {
    try {
        showSyncStatus('saving');
        const camp = keywordBank[idx];
        if (!camp) { showSyncStatus('saved'); return; }
        const docRef = keywordBankRef.doc(`camp_${idx}`);
        await docRef.set({ ...camp, updatedAt: new Date().toISOString() });
        showSyncStatus('saved');
    } catch (error) {
        console.error(error);
        showSyncStatus('error');
    }
}


async function loadBankFromFirebase() {
    try {
        const snapshot = await keywordBankRef.orderBy('campaign_id').get();
        if (!snapshot.empty) {
            keywordBank = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                delete data.updatedAt;
                keywordBank.push(data);
            });
            updateBankStats();
            populateBankFilters();
            renderBankCampaigns();
        }
    } catch (error) { console.error(error); }
}

function showSyncStatus(status) {
    const el = document.getElementById('syncStatus');
    if (!el) return;
    el.className = `sync-status ${status}`;
    if (status === 'saving') el.textContent = '‚òÅÔ∏è Guardando...';
    else if (status === 'saved') {
        el.textContent = '‚úÖ Guardado';
        setTimeout(() => el.style.display = 'none', 2000);
    } else {
        el.textContent = '‚ùå Error';
        setTimeout(() => el.style.display = 'none', 3000);
    }
}



// ============================================================================
// POPUP: abrir pesta√±a por hash despu√©s del login + sincronizaci√≥n entre ventanas
// ============================================================================
(function(){
    function isAppVisible(){
        try {
            const login = document.getElementById('loginScreen');
            if (!login) return true;
            return login.classList.contains('hidden');
        } catch(e){
            return true;
        }
    }

    function openTabFromHash(){
        try {
            const id = (window.location.hash || '').replace('#','');
            if (!id) return;
            if (!document.getElementById(id)) return;
            if (typeof switchTab !== 'function') return;
            if (!isAppVisible()) return;
            switchTab(id);
        } catch(e) {}
    }

    function waitAndOpen(){
        if (isAppVisible()) { openTabFromHash(); return; }
        setTimeout(waitAndOpen, 250);
    }

    window.addEventListener('load', waitAndOpen);
    window.addEventListener('hashchange', waitAndOpen);

    try {
        const bc = new BroadcastChannel('gestor_sync');
        bc.onmessage = (ev) => {
            if (ev && ev.data && ev.data.type === 'reload') {
                if (typeof renderTable === 'function') renderTable();
                if (typeof updateStats === 'function') updateStats();
                if (typeof refreshEverything === 'function') refreshEverything();
            }
        };

        function wrapReload(fnName){
            const orig = window[fnName];
            if (typeof orig !== 'function') return;
            window[fnName] = async function(){
                const res = await orig.apply(this, arguments);
                bc.postMessage({type:'reload'});
                return res;
            };
        }

        wrapReload('saveCampaign');
        wrapReload('saveMetadataOnly');
        wrapReload('deleteCampaign');
        wrapReload('addOption');
    } catch(e) {}
})();
</script>

</body>
</html>
