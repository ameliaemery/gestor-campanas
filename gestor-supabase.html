<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ Gestor HAV 2026 - Supabase</title>
    <style>
        :root { --primary: #667eea; --secondary: #764ba2; --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --dark: #1f2937; --light: #f9fafb; --border: #e5e7eb; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; min-height: 100vh; }
        .container { max-width: 1900px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; padding: 30px; text-align: center; position: relative; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .header .subtitle { font-size: 1.1em; opacity: 0.9; }
        
        #loginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; justify-content: center; align-items: center; z-index: 99999; }
        #loginScreen.hidden { display: none; }
        .login-box { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); width: 90%; max-width: 400px; text-align: center; }
        .login-box h1 { color: #667eea; margin-bottom: 10px; font-size: 2em; }
        .login-box p { color: #666; margin-bottom: 30px; }
        .login-input { width: 100%; padding: 12px 15px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1em; margin: 10px 0; box-sizing: border-box; }
        .login-btn { width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 1.1em; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .login-error { color: #dc2626; margin-top: 15px; display: none; }
        .logout-btn { position: fixed; top: 20px; right: 20px; background: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; z-index: 1000; }
        #mainApp { display: none; }
        #mainApp.show { display: block; }
        
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; padding: 20px; background: var(--light); }
        .stat-card { background: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .stat-card .number { font-size: 2.5em; font-weight: bold; color: var(--primary); }
        .stat-card .label { color: var(--dark); margin-top: 5px; font-size: 0.9em; }
        
        .tabs { display: flex; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); overflow-x: auto; }
        .tab-btn { flex: 1; padding: 18px; background: transparent; border: none; color: white; cursor: pointer; font-size: 1.05em; font-weight: 600; white-space: nowrap; }
        .tab-btn.active { background: white; color: var(--primary); }
        .tab-content { display: none; padding: 30px; }
        .tab-content.active { display: block; }
        
        .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .control-group { display: flex; flex-direction: column; }
        .control-group label { font-weight: 600; margin-bottom: 8px; color: var(--dark); }
        .control-group input, .control-group select, .control-group textarea { padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 1em; }
        .control-group textarea { resize: vertical; font-family: 'Courier New', monospace; min-height: 100px; }
        
        .btn { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 600; transition: all 0.3s; margin: 5px; }
        .btn-edit { background: var(--warning); color: white; }
        .btn-del { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-primary { background: var(--primary); color: white; }
        
        table { width: 100%; border-collapse: collapse; background: white; margin-top: 20px; font-size: 0.9em; }
        thead { background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; }
        th { padding: 12px 8px; text-align: left; cursor: pointer; font-size: 0.85em; }
        td { padding: 10px 8px; border-bottom: 1px solid var(--border); }
        tbody tr:hover { background: var(--light); }
        
        .article-box { border: 3px dashed #ccc; padding: 15px; border-radius: 8px; margin-top: 15px; background: #fafafa; }
        .article-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        
        #notification-area { position: fixed; bottom: 20px; right: 20px; z-index: 10000; }
        .notif-box { background: #333; color: white; padding: 15px; border-radius: 8px; margin-top: 10px; animation: slideIn 0.3s; }
        @keyframes slideIn { from { transform: translateX(400px); } to { transform: translateX(0); } }
        
        .comp-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 20px; }
        .comp-card { border: 2px solid var(--border); border-radius: 12px; padding: 20px; background: white; }
        .comp-card h3 { color: var(--primary); margin-bottom: 15px; }
        .comp-card .info { margin: 8px 0; }
        
        .hav-list { max-height: 400px; overflow-y: auto; border: 2px solid var(--border); border-radius: 8px; padding: 15px; background: white; }
        .hav-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border); }
        .hav-item:last-child { border-bottom: none; }
    </style>
</head>
<body>

<div id="loginScreen">
    <div class="login-box">
        <h1>üîí Gestor HAV 2026</h1>
        <p>Acceso Protegido</p>
        <input type="text" id="loginUser" class="login-input" placeholder="Usuario" autocomplete="username">
        <input type="password" id="loginPass" class="login-input" placeholder="Contrase√±a" autocomplete="current-password">
        <button class="login-btn" onclick="handleLogin()">Entrar</button>
        <div id="loginError" class="login-error">‚ùå Usuario o contrase√±a incorrectos</div>
    </div>
</div>

<button class="logout-btn" onclick="logout()" style="display: none;" id="logoutBtn">üö™ Salir</button>

<div id="mainApp">
    <div id="notification-area"></div>
    <div class="container">
        <div class="header">
            <h1>üöÄ Gestor de Campa√±as HAV 2026</h1>
            <p class="subtitle">‚òÅÔ∏è Supabase Edition - Usuario: <span id="currentUser"></span></p>
        </div>

        <div class="stats">
            <div class="stat-card"><div class="number" id="totalCampaigns">0</div><div class="label">üìä Total Campa√±as</div></div>
            <div class="stat-card"><div class="number" id="totalKeywords">0</div><div class="label">üîë Keywords</div></div>
            <div class="stat-card"><div class="number" id="avgKeys">0</div><div class="label">üìà Promedio</div></div>
            <div class="stat-card"><div class="number" id="totalArticles">0</div><div class="label">üìù Art√≠culos</div></div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('tab-list')">üìã Lista de Campa√±as</button>
            <button class="tab-btn" onclick="switchTab('tab-comp')">üî¨ Comparador</button>
            <button class="tab-btn" onclick="switchTab('tab-add')">‚ûï Gestionar Campa√±a</button>
            <button class="tab-btn" onclick="switchTab('tab-config')">‚öôÔ∏è Configuraci√≥n Global</button>
            <button class="tab-btn" onclick="switchTab('tab-catalog')">üì° Cat√°logo HAV</button>
        </div>

        <!-- TAB: LISTA DE CAMPA√ëAS -->
        <div id="tab-list" class="tab-content active">
            <div class="controls">
                <div class="control-group"><label>üîç Buscar</label><input type="text" id="search" placeholder="Buscar..." onkeyup="renderTable()"></div>
                <div class="control-group"><label>Filtrar por Plataforma</label><select id="filterPlatform" onchange="renderTable()"><option value="">Todas</option><option>FB</option><option>TT</option><option>GN</option></select></div>
                <div class="control-group"><label>Filtrar por Pa√≠s</label><input type="text" id="filterCountry" placeholder="DE, AT, CH..." onkeyup="renderTable()"></div>
            </div>
            <button class="btn btn-success" onclick="exportarCampanas()">üì§ Exportar JSON</button>
            <button class="btn btn-primary" onclick="document.getElementById('importFile').click()">üì• Importar JSON</button>
            <input type="file" id="importFile" accept=".json" style="display:none" onchange="importarDatos(event)">
            
            <table>
                <thead>
                    <tr>
                        <th onclick="applySort('date')">üìÖ Fecha</th>
                        <th onclick="applySort('platform')">Plat.</th>
                        <th onclick="applySort('channel')">Canal</th>
                        <th onclick="applySort('product')">Nicho</th>
                        <th onclick="applySort('campaign_id')">ID</th>
                        <th onclick="applySort('code')">Nombre</th>
                        <th onclick="applySort('language')">Idioma</th>
                        <th onclick="applySort('country')">Pa√≠s</th>
                        <th>Keys</th>
                        <th>Art√≠culo</th>
                        <th>Link</th>
                        <th>üë§</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="campaignList"></tbody>
            </table>
        </div>

        <!-- TAB: COMPARADOR -->
        <div id="tab-comp" class="tab-content">
            <h2>üî¨ Analizar 3 Campa√±as Simult√°neamente</h2>
            <div class="controls" style="margin-top: 20px;">
                <div class="control-group">
                    <label>Campa√±a 1</label>
                    <select id="comp1" onchange="runTripleComparison()"><option value="">Seleccionar...</option></select>
                </div>
                <div class="control-group">
                    <label>Campa√±a 2</label>
                    <select id="comp2" onchange="runTripleComparison()"><option value="">Seleccionar...</option></select>
                </div>
                <div class="control-group">
                    <label>Campa√±a 3</label>
                    <select id="comp3" onchange="runTripleComparison()"><option value="">Seleccionar...</option></select>
                </div>
            </div>
            <div id="compResult" class="comp-grid"></div>
        </div>

        <!-- TAB: GESTIONAR CAMPA√ëA -->
        <div id="tab-add" class="tab-content">
            <h2 id="formTitle">Nueva Campa√±a</h2>
            <div class="controls" style="margin-top: 20px;">
                <div class="control-group"><label>Plataforma</label><select id="inPlatform" onchange="updateCampPlatform()"><option>FB</option><option>TT</option><option>GN</option></select></div>
                <div class="control-group"><label>Canal</label><input type="text" id="inChannel" list="channelOptions"><datalist id="channelOptions"></datalist></div>
                <div class="control-group"><label>Nicho</label><input type="text" id="inProduct" list="productOptions"><datalist id="productOptions"></datalist></div>
                <div class="control-group"><label>Pa√≠s</label><input type="text" id="inCountry" list="countryOptions"><datalist id="countryOptions"></datalist></div>
            </div>
            <div class="controls">
                <div class="control-group"><label>ID</label><input type="text" id="inId"></div>
                <div class="control-group"><label>C√≥digo</label><input type="text" id="inCode"></div>
                <div class="control-group"><label>Idioma</label><input type="text" id="inLanguage" list="langOptions"><datalist id="langOptions"></datalist></div>
                <div class="control-group"><label>Fecha</label><input type="date" id="inDate"></div>
            </div>
            <div class="control-group" style="margin-top: 15px;">
                <label>Keywords (una por l√≠nea)</label>
                <textarea id="inKeywords" rows="8"></textarea>
            </div>
            <div class="control-group" style="margin-top: 15px;">
                <label>Link/Enlace</label>
                <input type="text" id="inLink" placeholder="https://...">
            </div>
            
            <div class="article-box">
                <div class="article-header">
                    <h3>üìù Art√≠culo Advertorial</h3>
                    <button class="btn btn-primary" onclick="boldSelectedText()">üÖ±Ô∏è Negrita</button>
                </div>
                <textarea id="inArticle" rows="15" style="width:100%; padding:10px; font-family: Arial; border: 2px solid #ddd; border-radius: 5px;"></textarea>
            </div>
            
            <button class="btn btn-success" onclick="saveCampaign()" style="margin-top: 20px; font-size: 1.2em;">üíæ Guardar Campa√±a</button>
            <button class="btn btn-del" onclick="resetForm()" style="margin-top: 20px;">üîÑ Limpiar</button>
        </div>

        <!-- TAB: CONFIGURACI√ìN GLOBAL -->
        <div id="tab-config" class="tab-content">
            <h2>‚öôÔ∏è Configuraci√≥n Global (Sincronizada)</h2>
            <div class="controls" style="margin-top: 20px;">
                <div class="control-group">
                    <label>Canales Disponibles (separados por coma)</label>
                    <textarea id="globalChannels" rows="3"></textarea>
                </div>
                <div class="control-group">
                    <label>Nichos Disponibles (separados por coma)</label>
                    <textarea id="globalProducts" rows="3"></textarea>
                </div>
            </div>
            <div class="controls">
                <div class="control-group">
                    <label>Pa√≠ses Disponibles (separados por coma)</label>
                    <textarea id="globalCountries" rows="2"></textarea>
                </div>
                <div class="control-group">
                    <label>Idiomas Disponibles (separados por coma)</label>
                    <textarea id="globalLanguages" rows="2"></textarea>
                </div>
            </div>
            <button class="btn btn-success" onclick="saveGlobalSettings()" style="margin-top: 20px;">üíæ Guardar Configuraci√≥n</button>
        </div>

        <!-- TAB: CAT√ÅLOGO HAV -->
        <div id="tab-catalog" class="tab-content">
            <h2>üì° Cat√°logo HAV (Canales de Afiliados)</h2>
            <div class="controls" style="margin-top: 20px;">
                <div class="control-group">
                    <label>Nombre del Canal</label>
                    <input type="text" id="havChannelName" placeholder="Ej: DigitalDeals2024">
                </div>
                <div class="control-group">
                    <label>Plataforma</label>
                    <select id="havPlatform"><option>FB</option><option>TT</option><option>GN</option></select>
                </div>
            </div>
            <button class="btn btn-success" onclick="addNewHAVChannel()">‚ûï Agregar Canal</button>
            <button class="btn btn-primary" onclick="document.getElementById('havImportFile').click()">üì• Importar JSON</button>
            <button class="btn btn-warning" onclick="limpiarDuplicadosCatalogo()">üßπ Eliminar Duplicados</button>
            <button class="btn btn-del" onclick="borrarCatalogoCompleto()">üóëÔ∏è Borrar Todo</button>
            <input type="file" id="havImportFile" accept=".json" style="display:none" onchange="importarCatalogo(event)">
            
            <div id="havList" class="hav-list" style="margin-top: 20px;"></div>
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ========== CONFIGURACI√ìN ==========
const SUPABASE_URL = 'https://zwpurfuzheyzcomeckbr.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp3cHVyZnV6aGV5emNvbWVja2JyIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc3MDAwMDcxMywiZXhwIjoyMDg1NTc2NzEzfQ.wgSCnZ5sHU0pXnyJGilZfepAWBGShJMqUQZ7jzfcC_8';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const USERS = {
    'amelemery': 'gestor2026',
    'haevedecano83': 'gestor2026'
};

let db = { campaigns: [], havChannels: [], globalSettings: {} };
let editingId = null;
let currentSort = { field: 'date', asc: false };

// ========== LOGIN ==========
function handleLogin() {
    const user = document.getElementById('loginUser').value.trim();
    const pass = document.getElementById('loginPass').value;
    
    if (USERS[user] && USERS[user] === pass) {
        localStorage.setItem('loggedUser', user);
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('mainApp').classList.add('show');
        document.getElementById('logoutBtn').style.display = 'block';
        document.getElementById('currentUser').textContent = user;
        loadData();
    } else {
        document.getElementById('loginError').style.display = 'block';
    }
}

function logout() {
    localStorage.removeItem('loggedUser');
    document.getElementById('loginScreen').classList.remove('hidden');
    document.getElementById('mainApp').classList.remove('show');
    document.getElementById('logoutBtn').style.display = 'none';
}

// ========== CARGAR DATOS ==========
async function loadData() {
    // Cargar campa√±as
    const { data: camps, error1 } = await sb.from('campaigns').select('*').order('created_at', { ascending: false });
    if (camps) db.campaigns = camps;
    
    // Cargar cat√°logo HAV
    const { data: hav, error2 } = await sb.from('hav_channels').select('*').order('name');
    if (hav) db.havChannels = hav;
    
    // Cargar configuraci√≥n global
    const { data: config, error3 } = await sb.from('global_config').select('*').single();
    if (config) {
        db.globalSettings = config;
        document.getElementById('globalChannels').value = (config.channels || []).join(', ');
        document.getElementById('globalProducts').value = (config.products || []).join(', ');
        document.getElementById('globalCountries').value = (config.countries || []).join(', ');
        document.getElementById('globalLanguages').value = (config.languages || []).join(', ');
    }
    
    renderTable();
    updateStats();
    updateCompSelects();
    renderHAVCatalog();
    updateOptions();
}

// ========== TABS ==========
function switchTab(id) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    event.target.classList.add('active');
}

// ========== ESTAD√çSTICAS ==========
function updateStats() {
    document.getElementById('totalCampaigns').textContent = db.campaigns.length;
    const totalKeys = db.campaigns.reduce((sum, c) => sum + (c.keywords ? c.keywords.length : 0), 0);
    document.getElementById('totalKeywords').textContent = totalKeys;
    document.getElementById('avgKeys').textContent = db.campaigns.length > 0 ? Math.round(totalKeys / db.campaigns.length) : 0;
    document.getElementById('totalArticles').textContent = db.campaigns.filter(c => c.article && c.article.trim()).length;
}

// ========== RENDER TABLA ==========
function renderTable() {
    const search = document.getElementById('search').value.toLowerCase();
    const filterPlatform = document.getElementById('filterPlatform').value;
    const filterCountry = document.getElementById('filterCountry').value.toUpperCase();
    
    let filtered = db.campaigns.filter(c => {
        const matchSearch = JSON.stringify(c).toLowerCase().includes(search);
        const matchPlatform = !filterPlatform || c.platform === filterPlatform;
        const matchCountry = !filterCountry || (c.country && c.country.toUpperCase().includes(filterCountry));
        return matchSearch && matchPlatform && matchCountry;
    });
    
    // Ordenar
    filtered.sort((a, b) => {
        const valA = a[currentSort.field] || '';
        const valB = b[currentSort.field] || '';
        if (valA < valB) return currentSort.asc ? -1 : 1;
        if (valA > valB) return currentSort.asc ? 1 : -1;
        return 0;
    });
    
    const tbody = document.getElementById('campaignList');
    tbody.innerHTML = '';
    
    filtered.forEach(c => {
        const row = tbody.insertRow();
        const hasArticle = c.article && c.article.trim();
        const articleIcon = hasArticle ? '‚úÖ' : '‚ùå';
        const linkIcon = c.link ? 'üîó' : '';
        
        row.innerHTML = `
            <td>${c.date || '-'}</td>
            <td>${c.platform}</td>
            <td>${c.channel || '-'}</td>
            <td>${c.product || '-'}</td>
            <td>${c.campaign_id || '-'}</td>
            <td>${c.code || '-'}</td>
            <td>${c.language || '-'}</td>
            <td>${c.country || '-'}</td>
            <td><strong>${(c.keywords || []).length}</strong></td>
            <td>${articleIcon}</td>
            <td>${linkIcon}</td>
            <td>${c.owner || ''}</td>
            <td>
                <button class="btn btn-edit" onclick="editCampaign(${c.id})" style="padding: 6px 12px;">‚úèÔ∏è</button>
                <button class="btn btn-del" onclick="deleteCampaign(${c.id})" style="padding: 6px 12px;">üóëÔ∏è</button>
            </td>
        `;
    });
}

function applySort(field) {
    if (currentSort.field === field) {
        currentSort.asc = !currentSort.asc;
    } else {
        currentSort.field = field;
        currentSort.asc = true;
    }
    renderTable();
}

// ========== GUARDAR CAMPA√ëA ==========
async function saveCampaign() {
    const campaign = {
        platform: document.getElementById('inPlatform').value,
        channel: document.getElementById('inChannel').value.trim(),
        product: document.getElementById('inProduct').value.trim(),
        country: document.getElementById('inCountry').value.toUpperCase().trim(),
        code: document.getElementById('inCode').value.trim(),
        campaign_id: document.getElementById('inId').value.trim(),
        language: document.getElementById('inLanguage').value.trim(),
        keywords: document.getElementById('inKeywords').value.split('\n').filter(k => k.trim()).map(k => k.trim()),
        date: document.getElementById('inDate').value,
        article: document.getElementById('inArticle').value.trim(),
        link: document.getElementById('inLink').value.trim(),
        owner: localStorage.getItem('loggedUser')
    };
    
    if (editingId) {
        await sb.from('campaigns').update(campaign).eq('id', editingId);
        showNotif('‚úÖ Campa√±a actualizada');
    } else {
        await sb.from('campaigns').insert([campaign]);
        showNotif('‚úÖ Campa√±a guardada');
    }
    
    resetForm();
    loadData();
}

// ========== RESETEAR FORMULARIO ==========
function resetForm() {
    editingId = null;
    document.getElementById('formTitle').textContent = 'Nueva Campa√±a';
    document.getElementById('inPlatform').value = 'FB';
    document.getElementById('inChannel').value = '';
    document.getElementById('inProduct').value = '';
    document.getElementById('inCountry').value = '';
    document.getElementById('inCode').value = '';
    document.getElementById('inId').value = '';
    document.getElementById('inLanguage').value = '';
    document.getElementById('inKeywords').value = '';
    document.getElementById('inDate').value = '';
    document.getElementById('inArticle').value = '';
    document.getElementById('inLink').value = '';
}

// ========== EDITAR CAMPA√ëA ==========
function editCampaign(id) {
    const c = db.campaigns.find(camp => camp.id === id);
    if (!c) return;
    
    editingId = id;
    document.getElementById('formTitle').textContent = 'Editar Campa√±a';
    document.getElementById('inPlatform').value = c.platform || 'FB';
    document.getElementById('inChannel').value = c.channel || '';
    document.getElementById('inProduct').value = c.product || '';
    document.getElementById('inCountry').value = c.country || '';
    document.getElementById('inCode').value = c.code || '';
    document.getElementById('inId').value = c.campaign_id || '';
    document.getElementById('inLanguage').value = c.language || '';
    document.getElementById('inKeywords').value = (c.keywords || []).join('\n');
    document.getElementById('inDate').value = c.date || '';
    document.getElementById('inArticle').value = c.article || '';
    document.getElementById('inLink').value = c.link || '';
    
    switchTab('tab-add');
    document.querySelector('[onclick="switchTab(\'tab-add\')"]').classList.add('active');
}

// ========== ELIMINAR CAMPA√ëA ==========
async function deleteCampaign(id) {
    if (!confirm('¬øEliminar esta campa√±a?')) return;
    await sb.from('campaigns').delete().eq('id', id);
    showNotif('üóëÔ∏è Campa√±a eliminada');
    loadData();
}

// ========== COMPARADOR ==========
function updateCompSelects() {
    const selects = ['comp1', 'comp2', 'comp3'];
    selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        select.innerHTML = '<option value="">Seleccionar...</option>';
        db.campaigns.forEach(c => {
            const option = document.createElement('option');
            option.value = c.id;
            option.textContent = `${c.code || c.campaign_id} (${c.country}) - ${c.platform}`;
            select.appendChild(option);
        });
    });
}

function runTripleComparison() {
    const id1 = document.getElementById('comp1').value;
    const id2 = document.getElementById('comp2').value;
    const id3 = document.getElementById('comp3').value;
    
    const result = document.getElementById('compResult');
    result.innerHTML = '';
    
    [id1, id2, id3].forEach(id => {
        if (!id) return;
        const c = db.campaigns.find(camp => camp.id == id);
        if (!c) return;
        
        const card = document.createElement('div');
        card.className = 'comp-card';
        card.innerHTML = `
            <h3>${c.code || c.campaign_id}</h3>
            <div class="info"><strong>Plataforma:</strong> ${c.platform}</div>
            <div class="info"><strong>Canal:</strong> ${c.channel || '-'}</div>
            <div class="info"><strong>Nicho:</strong> ${c.product || '-'}</div>
            <div class="info"><strong>Pa√≠s:</strong> ${c.country || '-'}</div>
            <div class="info"><strong>Idioma:</strong> ${c.language || '-'}</div>
            <div class="info"><strong>Keywords:</strong> ${(c.keywords || []).length}</div>
            <div class="info"><strong>Art√≠culo:</strong> ${c.article ? '‚úÖ S√≠' : '‚ùå No'}</div>
            <div class="info"><strong>Link:</strong> ${c.link ? 'üîó S√≠' : '-'}</div>
        `;
        result.appendChild(card);
    });
}

// ========== CONFIGURACI√ìN GLOBAL ==========
async function saveGlobalSettings() {
    const settings = {
        channels: document.getElementById('globalChannels').value.split(',').map(s => s.trim()).filter(s => s),
        products: document.getElementById('globalProducts').value.split(',').map(s => s.trim()).filter(s => s),
        countries: document.getElementById('globalCountries').value.split(',').map(s => s.trim()).filter(s => s),
        languages: document.getElementById('globalLanguages').value.split(',').map(s => s.trim()).filter(s => s)
    };
    
    // Verificar si existe configuraci√≥n
    const { data: existing } = await sb.from('global_config').select('*').single();
    
    if (existing) {
        await sb.from('global_config').update(settings).eq('id', existing.id);
    } else {
        await sb.from('global_config').insert([settings]);
    }
    
    showNotif('‚úÖ Configuraci√≥n guardada');
    loadData();
}

function updateOptions() {
    const channelList = document.getElementById('channelOptions');
    const productList = document.getElementById('productOptions');
    const countryList = document.getElementById('countryOptions');
    const langList = document.getElementById('langOptions');
    
    channelList.innerHTML = '';
    productList.innerHTML = '';
    countryList.innerHTML = '';
    langList.innerHTML = '';
    
    (db.globalSettings.channels || []).forEach(item => {
        const option = document.createElement('option');
        option.value = item;
        channelList.appendChild(option);
    });
    
    (db.globalSettings.products || []).forEach(item => {
        const option = document.createElement('option');
        option.value = item;
        productList.appendChild(option);
    });
    
    (db.globalSettings.countries || []).forEach(item => {
        const option = document.createElement('option');
        option.value = item;
        countryList.appendChild(option);
    });
    
    (db.globalSettings.languages || []).forEach(item => {
        const option = document.createElement('option');
        option.value = item;
        langList.appendChild(option);
    });
}

// ========== CAT√ÅLOGO HAV ==========
async function addNewHAVChannel() {
    const name = document.getElementById('havChannelName').value.trim();
    const platform = document.getElementById('havPlatform').value;
    
    if (!name) {
        alert('Debes ingresar un nombre de canal');
        return;
    }
    
    const channel = { name, platform };
    await sb.from('hav_channels').insert([channel]);
    
    document.getElementById('havChannelName').value = '';
    showNotif('‚úÖ Canal HAV agregado');
    loadData();
}

function renderHAVCatalog() {
    const list = document.getElementById('havList');
    list.innerHTML = '';
    
    if (db.havChannels.length === 0) {
        list.innerHTML = '<p style="text-align:center; color:#999;">No hay canales en el cat√°logo</p>';
        return;
    }
    
    db.havChannels.forEach(ch => {
        const item = document.createElement('div');
        item.className = 'hav-item';
        item.innerHTML = `
            <div>
                <strong>${ch.name}</strong>
                <span style="margin-left: 10px; color: #666;">${ch.platform}</span>
            </div>
            <div>
                <button class="btn btn-del" onclick="deleteHAVChannel(${ch.id})" style="padding: 5px 10px;">üóëÔ∏è</button>
            </div>
        `;
        list.appendChild(item);
    });
}

async function deleteHAVChannel(id) {
    if (!confirm('¬øEliminar este canal?')) return;
    await sb.from('hav_channels').delete().eq('id', id);
    showNotif('üóëÔ∏è Canal eliminado');
    loadData();
}

async function limpiarDuplicadosCatalogo() {
    if (!confirm('¬øEliminar canales duplicados?')) return;
    
    const seen = new Set();
    const duplicates = [];
    
    db.havChannels.forEach(ch => {
        const key = `${ch.name}-${ch.platform}`;
        if (seen.has(key)) {
            duplicates.push(ch.id);
        } else {
            seen.add(key);
        }
    });
    
    for (const id of duplicates) {
        await sb.from('hav_channels').delete().eq('id', id);
    }
    
    showNotif(`üßπ ${duplicates.length} duplicados eliminados`);
    loadData();
}

async function borrarCatalogoCompleto() {
    if (!confirm('¬øBORRAR TODO el cat√°logo HAV?')) return;
    if (!confirm('¬øEst√°s SEGURO? Esta acci√≥n no se puede deshacer')) return;
    
    await sb.from('hav_channels').delete().neq('id', 0);
    showNotif('üóëÔ∏è Cat√°logo eliminado');
    loadData();
}

function importarCatalogo(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = async function(e) {
        try {
            const data = JSON.parse(e.target.result);
            if (Array.isArray(data)) {
                for (const item of data) {
                    await sb.from('hav_channels').insert([{ name: item.name || item, platform: item.platform || 'FB' }]);
                }
                showNotif(`‚úÖ ${data.length} canales importados`);
                loadData();
            }
        } catch (err) {
            alert('Error al importar: ' + err.message);
        }
    };
    reader.readAsText(file);
}

// ========== EXPORTAR/IMPORTAR ==========
function exportarCampanas() {
    const dataStr = JSON.stringify(db.campaigns, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `campanas-export-${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    showNotif('üì§ Exportado');
}

function importarDatos(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = async function(e) {
        try {
            const data = JSON.parse(e.target.result);
            if (Array.isArray(data)) {
                for (const camp of data) {
                    delete camp.id; // Dejar que Supabase genere nuevo ID
                    await sb.from('campaigns').insert([camp]);
                }
                showNotif(`‚úÖ ${data.length} campa√±as importadas`);
                loadData();
            }
        } catch (err) {
            alert('Error al importar: ' + err.message);
        }
    };
    reader.readAsText(file);
}

// ========== UTILIDADES ==========
function boldSelectedText() {
    const textarea = document.getElementById('inArticle');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selected = textarea.value.substring(start, end);
    
    if (selected) {
        const before = textarea.value.substring(0, start);
        const after = textarea.value.substring(end);
        textarea.value = before + '<b>' + selected + '</b>' + after;
        showNotif('üÖ±Ô∏è Texto en negrita');
    } else {
        alert('Selecciona un texto primero');
    }
}

function updateCampPlatform() {
    // Placeholder para l√≥gica adicional si es necesario
}

function showNotif(msg) {
    const box = document.createElement('div');
    box.className = 'notif-box';
    box.textContent = msg;
    document.getElementById('notification-area').appendChild(box);
    setTimeout(() => box.remove(), 3000);
}

// ========== AUTO-LOGIN ==========
const loggedUser = localStorage.getItem('loggedUser');
if (loggedUser && USERS[loggedUser]) {
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('mainApp').classList.add('show');
    document.getElementById('logoutBtn').style.display = 'block';
    document.getElementById('currentUser').textContent = loggedUser;
    loadData();
}

document.getElementById('loginPass').addEventListener('keypress', e => {
    if (e.key === 'Enter') handleLogin();
});
</script>
</body>
</html>
